
# Uni-HamGNN User Guide
[![GitHub](https://img.shields.io/badge/GitHub-HamGNN-blue)](https://github.com/QuantumLab-ZY/HamGNN)

## Introduction

Uni-HamGNN is a universal spin-orbit-coupled Hamiltonian model designed for accelerated quantum material discovery across the periodic table. It addresses the significant challenge of modeling spin-orbit coupling (SOC) effects in diverse complex systems, which traditionally requires computationally expensive density functional theory (DFT) calculations.

Uni-HamGNN eliminates the need for system-specific retraining and costly SOC-DFT calculations, enabling efficient high-throughput screening of quantum materials across different dimensional systems. This makes it a powerful tool for quantum material design and property research, significantly accelerating the pace of discovery in condensed matter physics and materials science.

## 1. Environment Setup

We recommend using Python 3.9. HamGNN requires the following Python libraries:
- `numpy == 1.21.2`
- `PyTorch == 1.11.0`
- `PyTorch Geometric == 2.0.4`
- `pytorch_lightning == 1.5.10`
- `e3nn == 0.5.0`
- `pymatgen == 2022.3.7`
- `tensorboard == 2.8.0`
- `tqdm`
- `scipy == 1.7.3`
- `yaml`
- `HamGNN`

To avoid potential version conflicts between dependencies, you can download the prebuilt HamGNN Conda environment from [Zenodo](https://zenodo.org/records/11064223). After downloading the `ML.tar.gz` file, extract it into your `conda/envs` directory.

## 2. HamGNN Installation Process

To install HamGNN, run the following commands:

```bash
git clone https://github.com/QuantumLab-ZY/HamGNN.git
cd HamGNN
python setup.py install
```

### Verify Installation

```bash
# Check if installation was successful
python -c "import HamGNN_v_2_1; print('HamGNN installed successfully')"
```

## 3. Installation of OpenMXï¼Œopenmx_postprocess and read_openmx

### OpenMX

HamGNN requires the tight-binding Hamiltonian generated by OpenMX. You should be familiar with the basic OpenMX parameters and how to use them. OpenMX can be downloaded from [the official website](https://www.openmx-square.org/) and you can follow the instructions on this site to install it.

### openmx_postprocess

[`openmx_postprocess`](https://github.com/QuantumLab-ZY/HamGNN/tree/main/openmx_postprocess) is a modified version of OpenMX for computing overlap matrices and other Hamiltonian matrices analytically. It stores the computed data in a binary file called `overlap.scfout`. To install `openmx_postprocess`:

1. First, install the [GSL](https://www.gnu.org/software/gsl/) library.
2. Modify the `makefile` in the `openmx_postprocess` directory:
   - Set `GSL_lib` to the path of the GSL library
   - Set `GSL_include` to the include path of GSL
   - Set `MKLROOT` to the Intel MKL path
   - Set `CMPLR_ROOT` to the Intel compiler path

After modifying the `makefile`, execute `make` to generate the executable programs: `openmx_postprocess` and `read_openmx`.

### read_openmx
After `openmx_postprocess` is successfully compiled, the `read_openmx` executable file can also be obtained in the source file directory. `read_openmx` is a binary executable used to export matrices from the `overlap.scfout` file to `HS.json`. This binary executable will be used by `graph_data_gen` script.

## 4. Usage

### Basic Usage Workflow

1. Prepare input data (`graph_data.npz` files)
2. Prepare the configuration file (e.g., `Input.yaml`)
3. Run the script for prediction
4. Analyze output results

### Preparation of `graph_data.npz`

1. **Convert POSCAR to OpenMX Format**: 
   Edit the `poscar2openmx.yaml` file with appropriate path settings and run:
   ```bash
   poscar2openmx --config path/to/poscar2openmx.yaml
   ```
   This converts the structures into OpenMX's `.dat` format. 
   
   > **Note**: If preparing non-SOC data, the DFT parameters for OpenMX in poscar2openmx.yaml should be consistent with non-SOC calculations. If preparing SOC data, the DFT parameters for OpenMX should be consistent with SOC calculations.

2. **Run OpenMX**: 
   Perform static calculations on the structure files to generate `.scfout` binary files containing Hamiltonian and overlap matrix information. 
   
   > **Note**: This step is only required if you need to evaluate the model's mean absolute error (MAE) against the true Hamiltonian matrices. If you're not concerned with the MAE value, you can skip this step.

3. **Process with openmx_postprocess**: 
   Run `openmx_postprocess` to generate the `overlap.scfout` file, which contains the overlap matrix and angular momentum matrix.

### Graph Data Conversion

The universal SOC Hamiltonian model requires two `graph_data.npz` files as input data:
- One in non-SOC mode
- One in SOC mode

Both files should be prepared as follows:

1. Set the appropriate paths in the `graph_data_gen.yaml` file.
2. Run the following to convert the structural and Hamiltonian data into a single input file for the HamGNN network:
   ```bash
   graph_data_gen --config graph_data_gen.yaml
   ```

This generates the `graph_data.npz` file, which will be used as input to HamGNN.

### Prediction

Follow these steps:
1. Convert the structures to be predicted into `graph_data.npz`.
2. Set the parameters in `Input.yaml`.
3. Run:
   ```bash
   python Uni-HamiltonianPredictor.py --config Input.yaml
   ```

### Output Files

After execution, the script will generate the following files in the specified `output_dir`:
- `hamiltonian.npy`: Predicted Hamiltonian matrix in NumPy array format
- If `calculate_mae` is enabled, MAE statistics will be printed to the console

### Band Structure Calculation
To calculate the band structure:
1. Update the `band_cal.yaml` configuration file with the correct path to the Hamiltonian data.
2. Execute the band structure calculation:
    ```bash
    band_cal --config band_cal.yaml
    ```

## 5. Parameter Description

Below is a detailed explanation of each parameter in `Input.yaml`:

| Parameter | Type | Description | Default Value |
|-----------|------|-------------|---------------|
| `model_pkl_path` | String | Path to the trained model pickle file | None (Required) |
| `non_soc_data_dir` | String | Directory containing non-SOC graph data with graph_data.npz | None (Required) |
| `soc_data_dir` | String | Directory containing SOC graph data, required only when using SOC models | None (Optional) |
| `output_dir` | String | Directory for output results | Current directory ('./') |
| `device` | String | Computing device, 'cpu' or 'cuda' | 'cpu' |
| `calculate_mae` | Boolean | Whether to calculate Mean Absolute Error | False |

### Example Configuration File (Input.yaml)

```yaml
# HamGNN prediction configuration
model_pkl_path: '/path/to/trained_model.pkl'
non_soc_data_dir: '/path/to/non_soc_graph_data'
soc_data_dir: '/path/to/soc_graph_data'  # Optional, required only for SOC calculations
output_dir: './results'
device: 'cuda'  # Use GPU, will fall back to CPU if unavailable
calculate_mae: true  # Calculate Mean Absolute Error
```