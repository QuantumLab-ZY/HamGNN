

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HamGNN_v_2_1.models.hamgnn_output &mdash; HamGNN v2.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=7902463a" />

  
    <link rel="shortcut icon" href="../../../_static/logo.png"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c36237e0"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=faab29de"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            HamGNN_v_2_1
              <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/index.html">HamGNN User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/introduction.html">HamGNN Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/introduction.html#key-features">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/introduction.html#application-areas">Application Areas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/introduction.html#latest-developments">Latest Developments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/installation.html">Environment Configuration and Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/installation.html#python-environment">Python Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/installation.html#third-party-dft-tool-support">Third-party DFT Tool Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/installation.html#openmx">OpenMX</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/installation.html#siesta-honpas">SIESTA/HONPAS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/installation.html#abacus">ABACUS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/installation.html#compiling-openmx-postprocess-and-read-openmx">Compiling <code class="docutils literal notranslate"><span class="pre">openmx_postprocess</span></code> and <code class="docutils literal notranslate"><span class="pre">read_openmx</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/installation.html#hamgnn-installation-steps">HamGNN Installation Steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/installation.html#step-one-install-conda-environment">Step One: Install Conda Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/installation.html#step-two-source-installation-of-hamgnn">Step Two: Source Installation of HamGNN</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/data_preparation.html">Construction of graph_data.npz File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/data_preparation.html#general-process">General Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/data_preparation.html#openmx-process">OpenMX Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/data_preparation.html#siesta-honpas-process">SIESTA/HONPAS Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/data_preparation.html#abacus-process">ABACUS Process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/training.html">Model Training Process</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/training.html#training-mode-classification">Training Mode Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/training.html#training-command">Training Command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/training.html#key-configuration-items">Key Configuration Items</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/training.html#training-monitoring">Training Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/prediction.html">Model Prediction Operation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/prediction.html#preparation-for-prediction">Preparation for Prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/prediction.html#execute-prediction">Execute Prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/prediction.html#output-results">Output Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/band_calculation.html">Band Structure Calculation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/band_calculation.html#operation-process">Operation Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/band_calculation.html#band-calculation-for-large-systems">Band Calculation for Large Systems</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/uni_hamgnn.html">Uni-HamGNN Universal Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/uni_hamgnn.html#model-introduction">Model Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/uni_hamgnn.html#input-requirements">Input Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/uni_hamgnn.html#usage-process">Usage Process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/uni_hamgnn.html#output-results">Output Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/parameters.html">HamGNN Parameter Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#setup-basic-settings">setup (Basic Settings)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#dataset-params-dataset-parameters">dataset_params (Dataset Parameters)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#losses-metrics-loss-functions-and-evaluation-metrics">losses_metrics (Loss Functions and Evaluation Metrics)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#optim-params-optimizer-parameters">optim_params (Optimizer Parameters)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#output-nets-hamgnn-out-output-network-parameters">output_nets.HamGNN_out (Output Network Parameters)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#representation-nets-hamgnn-pre-representation-network-parameters">representation_nets.HamGNN_pre (Representation Network Parameters)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../user_guide/parameters.html#parameter-adjustment-recommendations">Parameter Adjustment Recommendations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../user_guide/parameters.html#references">References</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/model_structure.html">Model Structure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_structure.html#module-HamGNN_v_2_1.models.base_model">Base Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.get_radii_from_atomic_numbers"><code class="docutils literal notranslate"><span class="pre">get_radii_from_atomic_numbers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.neighbor_list_and_relative_vec"><code class="docutils literal notranslate"><span class="pre">neighbor_list_and_relative_vec()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.find_matching_columns_of_A_in_B"><code class="docutils literal notranslate"><span class="pre">find_matching_columns_of_A_in_B()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.BaseModel"><code class="docutils literal notranslate"><span class="pre">BaseModel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.BaseModel.forward"><code class="docutils literal notranslate"><span class="pre">BaseModel.forward()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.BaseModel.generate_graph"><code class="docutils literal notranslate"><span class="pre">BaseModel.generate_graph()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.base_model.BaseModel.num_params"><code class="docutils literal notranslate"><span class="pre">BaseModel.num_params</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_structure.html#module-HamGNN_v_2_1.models.hamgnn_conv">HamGNN Convolution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_conv.HamGNNConvE3"><code class="docutils literal notranslate"><span class="pre">HamGNNConvE3</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_conv.HamGNNConvE3.forward"><code class="docutils literal notranslate"><span class="pre">HamGNNConvE3.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_structure.html#module-HamGNN_v_2_1.models.hamgnn_transformer">HamGNN Transformer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_transformer.HamGNNTransformer"><code class="docutils literal notranslate"><span class="pre">HamGNNTransformer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_transformer.HamGNNTransformer.forward"><code class="docutils literal notranslate"><span class="pre">HamGNNTransformer.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_structure.html#module-HamGNN_v_2_1.models.hamgnn_output">HamGNN Output Head</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamLayer"><code class="docutils literal notranslate"><span class="pre">HamLayer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamLayer.forward"><code class="docutils literal notranslate"><span class="pre">HamLayer.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.merge_tensor_components"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.merge_tensor_components()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.merge_rank2_tensor_components"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.merge_rank2_tensor_components()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.merge_rank0_tensor_components"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.merge_rank0_tensor_components()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.construct_j_coupling_matrix"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.construct_j_coupling_matrix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.construct_k_coupling_matrix"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.construct_k_coupling_matrix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.reorder_matrix"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.reorder_matrix()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.construct_molecular_hamiltonian"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.construct_molecular_hamiltonian()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.concatenate_hamiltonians_by_crystal"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.concatenate_hamiltonians_by_crystal()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_hamiltonian"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.symmetrize_hamiltonian()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian_soc"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian_soc()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian_soc"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian_soc()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_band_energies_with_overlap"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.calculate_band_energies_with_overlap()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_band_energies"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.calculate_band_energies()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_band_energies_with_spin_orbit_coupling"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.calculate_band_energies_with_spin_orbit_coupling()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.apply_orbital_masks_to_hamiltonians"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.apply_orbital_masks_to_hamiltonians()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_orbital_coefficients"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.symmetrize_orbital_coefficients()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.create_cell_index_mapping"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.create_cell_index_mapping()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.extract_unique_cell_vectors"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.extract_unique_cell_vectors()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_edge_lookup_structures"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.build_edge_lookup_structures()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.create_orbital_validity_mask"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.create_orbital_validity_mask()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_interaction_masks"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.build_interaction_masks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_column_wise_interaction_masks"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.build_column_wise_interaction_masks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_spin_orbit_interaction_masks"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.build_spin_orbit_interaction_masks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_sparsity_ratio"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.calculate_sparsity_ratio()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.validate_elements_in_basis_def"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.validate_elements_in_basis_def()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.forward"><code class="docutils literal notranslate"><span class="pre">HamGNNPlusPlusOut.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_structure.html#module-HamGNN_v_2_1.models.Model">Main Model Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model"><code class="docutils literal notranslate"><span class="pre">Model</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.calculate_loss"><code class="docutils literal notranslate"><span class="pre">Model.calculate_loss()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.training_step"><code class="docutils literal notranslate"><span class="pre">Model.training_step()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.validation_step"><code class="docutils literal notranslate"><span class="pre">Model.validation_step()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.validation_epoch_end"><code class="docutils literal notranslate"><span class="pre">Model.validation_epoch_end()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.test_step"><code class="docutils literal notranslate"><span class="pre">Model.test_step()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.test_epoch_end"><code class="docutils literal notranslate"><span class="pre">Model.test_epoch_end()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.forward"><code class="docutils literal notranslate"><span class="pre">Model.forward()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.log_metrics"><code class="docutils literal notranslate"><span class="pre">Model.log_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_structure.html#HamGNN_v_2_1.models.Model.Model.configure_optimizers"><code class="docutils literal notranslate"><span class="pre">Model.configure_optimizers()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/gnn_core.html">GNN Core Layers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gnn_core/message_passing.html">Message Passing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/message_passing.html#module-HamGNN_v_2_1.nn.message_passing">Message Pack Blocks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/message_passing.html#HamGNN_v_2_1.nn.message_passing.MessagePackBlock"><code class="docutils literal notranslate"><span class="pre">MessagePackBlock</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/message_passing.html#HamGNN_v_2_1.nn.message_passing.MessagePackBlockV2"><code class="docutils literal notranslate"><span class="pre">MessagePackBlockV2</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gnn_core/attention.html">Attention Mechanisms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/attention.html#module-HamGNN_v_2_1.nn.attention">Attention Layers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/attention.html#HamGNN_v_2_1.nn.attention.AttentionAggregationV2"><code class="docutils literal notranslate"><span class="pre">AttentionAggregationV2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/attention.html#HamGNN_v_2_1.nn.attention.AttentionAggregation"><code class="docutils literal notranslate"><span class="pre">AttentionAggregation</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/attention.html#HamGNN_v_2_1.nn.attention.AttentionBlockE3"><code class="docutils literal notranslate"><span class="pre">AttentionBlockE3</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/attention.html#module-HamGNN_v_2_1.nn.attention_utils">Attention Utilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/attention.html#HamGNN_v_2_1.nn.attention_utils.VectorToAttentionHeads"><code class="docutils literal notranslate"><span class="pre">VectorToAttentionHeads</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/attention.html#HamGNN_v_2_1.nn.attention_utils.AttentionHeadsToVector"><code class="docutils literal notranslate"><span class="pre">AttentionHeadsToVector</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gnn_core/convolution.html">Convolution Layers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/convolution.html#module-HamGNN_v_2_1.nn.convolution">Graph Convolution Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/convolution.html#HamGNN_v_2_1.nn.convolution.ConvBlockE3"><code class="docutils literal notranslate"><span class="pre">ConvBlockE3</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gnn_core/tensor_operations.html">Tensor Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/tensor_operations.html#module-HamGNN_v_2_1.nn.tensor_products">Tensor Products</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/tensor_operations.html#HamGNN_v_2_1.nn.tensor_products.LinearScaleWithWeights"><code class="docutils literal notranslate"><span class="pre">LinearScaleWithWeights</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/tensor_operations.html#HamGNN_v_2_1.nn.tensor_products.TensorProductWithMemoryOptimizationWithWeight"><code class="docutils literal notranslate"><span class="pre">TensorProductWithMemoryOptimizationWithWeight</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/tensor_operations.html#HamGNN_v_2_1.nn.tensor_products.TensorProductWithScalarComponents"><code class="docutils literal notranslate"><span class="pre">TensorProductWithScalarComponents</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/tensor_operations.html#HamGNN_v_2_1.nn.tensor_products.ConcatenatedIrrepsTensorProduct"><code class="docutils literal notranslate"><span class="pre">ConcatenatedIrrepsTensorProduct</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gnn_core/interaction_blocks.html">Interaction Blocks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/interaction_blocks.html#module-HamGNN_v_2_1.nn.interaction_blocks">Neural Network Interaction Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/interaction_blocks.html#HamGNN_v_2_1.nn.interaction_blocks.PairInteractionBlock"><code class="docutils literal notranslate"><span class="pre">PairInteractionBlock</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/interaction_blocks.html#HamGNN_v_2_1.nn.interaction_blocks.CorrProductBlock"><code class="docutils literal notranslate"><span class="pre">CorrProductBlock</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/interaction_blocks.html#HamGNN_v_2_1.nn.interaction_blocks.ResidualBlock"><code class="docutils literal notranslate"><span class="pre">ResidualBlock</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html">Physics Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#module-HamGNN_v_2_1.physics.Clebsch_Gordan_coefficients">Clebsch-Gordan Coefficients</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.Clebsch_Gordan_coefficients.ClebschGordanCoefficients"><code class="docutils literal notranslate"><span class="pre">ClebschGordanCoefficients</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#module-HamGNN_v_2_1.physics.kpoints">K-Points</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.kpoints.kpoints_generator"><code class="docutils literal notranslate"><span class="pre">kpoints_generator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.kpoints.compute_reciprocal_lattice_vectors"><code class="docutils literal notranslate"><span class="pre">compute_reciprocal_lattice_vectors()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.kpoints.generate_kpoint_grid"><code class="docutils literal notranslate"><span class="pre">generate_kpoint_grid()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#module-HamGNN_v_2_1.physics.matrix_operations">Matrix Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.matrix_operations.HamLayer"><code class="docutils literal notranslate"><span class="pre">HamLayer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.matrix_operations.TensorExpansion"><code class="docutils literal notranslate"><span class="pre">TensorExpansion</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.matrix_operations.OverlapExpand"><code class="docutils literal notranslate"><span class="pre">OverlapExpand</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/gnn_core/physics_tools.html#HamGNN_v_2_1.physics.matrix_operations.TensorMerge"><code class="docutils literal notranslate"><span class="pre">TensorMerge</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/model_components.html">Model Components</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.nn.embeddings">Embeddings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.RadialBasisEdgeEncoding"><code class="docutils literal notranslate"><span class="pre">RadialBasisEdgeEncoding</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.RadialBasisEdgeEncoding.out_field"><code class="docutils literal notranslate"><span class="pre">RadialBasisEdgeEncoding.out_field</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.RadialBasisEdgeEncoding.forward"><code class="docutils literal notranslate"><span class="pre">RadialBasisEdgeEncoding.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.EdgeScalarEmbedding"><code class="docutils literal notranslate"><span class="pre">EdgeScalarEmbedding</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.EdgeScalarEmbedding.forward"><code class="docutils literal notranslate"><span class="pre">EdgeScalarEmbedding.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.LocalEnvironmentEmbedding"><code class="docutils literal notranslate"><span class="pre">LocalEnvironmentEmbedding</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.LocalEnvironmentEmbedding.forward"><code class="docutils literal notranslate"><span class="pre">LocalEnvironmentEmbedding.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.PairInteractionEmbeddingBlock"><code class="docutils literal notranslate"><span class="pre">PairInteractionEmbeddingBlock</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.PairInteractionEmbeddingBlock.create_linear"><code class="docutils literal notranslate"><span class="pre">PairInteractionEmbeddingBlock.create_linear()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.PairInteractionEmbeddingBlock.create_tensor_product"><code class="docutils literal notranslate"><span class="pre">PairInteractionEmbeddingBlock.create_tensor_product()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.PairInteractionEmbeddingBlock.init_weight_generator"><code class="docutils literal notranslate"><span class="pre">PairInteractionEmbeddingBlock.init_weight_generator()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.PairInteractionEmbeddingBlock.forward"><code class="docutils literal notranslate"><span class="pre">PairInteractionEmbeddingBlock.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.Embedding"><code class="docutils literal notranslate"><span class="pre">Embedding</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.Embedding.reset_parameters"><code class="docutils literal notranslate"><span class="pre">Embedding.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.nn.embeddings.Embedding.forward"><code class="docutils literal notranslate"><span class="pre">Embedding.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.nn.electron_configurations">Electron Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.utils.mlp">MLP Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.mlp.linear_bn_act"><code class="docutils literal notranslate"><span class="pre">linear_bn_act()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.mlp.denseLayer"><code class="docutils literal notranslate"><span class="pre">denseLayer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.mlp.denseLayer.forward"><code class="docutils literal notranslate"><span class="pre">denseLayer.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.mlp.Dense"><code class="docutils literal notranslate"><span class="pre">Dense</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.mlp.Dense.reset_parameters"><code class="docutils literal notranslate"><span class="pre">Dense.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.mlp.Dense.forward"><code class="docutils literal notranslate"><span class="pre">Dense.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.utils.activation">Activation Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.shifted_softplus"><code class="docutils literal notranslate"><span class="pre">shifted_softplus()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.switch_function"><code class="docutils literal notranslate"><span class="pre">switch_function()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.softplus_inverse"><code class="docutils literal notranslate"><span class="pre">softplus_inverse()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SoftUnitStepCutoff"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SoftUnitStepCutoff.cutoff"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff.cutoff</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SoftUnitStepCutoff.cut_param"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff.cut_param</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SoftUnitStepCutoff.forward"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.swish"><code class="docutils literal notranslate"><span class="pre">swish()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SSP"><code class="docutils literal notranslate"><span class="pre">SSP</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SSP.forward"><code class="docutils literal notranslate"><span class="pre">SSP.forward()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SSP.extra_repr"><code class="docutils literal notranslate"><span class="pre">SSP.extra_repr()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SWISH"><code class="docutils literal notranslate"><span class="pre">SWISH</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.SWISH.forward"><code class="docutils literal notranslate"><span class="pre">SWISH.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.activation.get_activation"><code class="docutils literal notranslate"><span class="pre">get_activation()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.utils.basis_functions">Basis Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.BernsteinRadialBasisFunctions"><code class="docutils literal notranslate"><span class="pre">BernsteinRadialBasisFunctions</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.BernsteinRadialBasisFunctions.reset_parameters"><code class="docutils literal notranslate"><span class="pre">BernsteinRadialBasisFunctions.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.BernsteinRadialBasisFunctions.forward"><code class="docutils literal notranslate"><span class="pre">BernsteinRadialBasisFunctions.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.ExponentialBernsteinRadialBasisFunctions"><code class="docutils literal notranslate"><span class="pre">ExponentialBernsteinRadialBasisFunctions</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.ExponentialBernsteinRadialBasisFunctions.reset_parameters"><code class="docutils literal notranslate"><span class="pre">ExponentialBernsteinRadialBasisFunctions.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.ExponentialBernsteinRadialBasisFunctions.forward"><code class="docutils literal notranslate"><span class="pre">ExponentialBernsteinRadialBasisFunctions.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.ExponentialGaussianRadialBasisFunctions"><code class="docutils literal notranslate"><span class="pre">ExponentialGaussianRadialBasisFunctions</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.ExponentialGaussianRadialBasisFunctions.reset_parameters"><code class="docutils literal notranslate"><span class="pre">ExponentialGaussianRadialBasisFunctions.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.ExponentialGaussianRadialBasisFunctions.forward"><code class="docutils literal notranslate"><span class="pre">ExponentialGaussianRadialBasisFunctions.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.GaussianRadialBasisFunctions"><code class="docutils literal notranslate"><span class="pre">GaussianRadialBasisFunctions</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.GaussianRadialBasisFunctions.reset_parameters"><code class="docutils literal notranslate"><span class="pre">GaussianRadialBasisFunctions.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.GaussianRadialBasisFunctions.forward"><code class="docutils literal notranslate"><span class="pre">GaussianRadialBasisFunctions.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.OverlapBernsteinRadialBasisFunctions"><code class="docutils literal notranslate"><span class="pre">OverlapBernsteinRadialBasisFunctions</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.OverlapBernsteinRadialBasisFunctions.reset_parameters"><code class="docutils literal notranslate"><span class="pre">OverlapBernsteinRadialBasisFunctions.reset_parameters()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.OverlapBernsteinRadialBasisFunctions.forward"><code class="docutils literal notranslate"><span class="pre">OverlapBernsteinRadialBasisFunctions.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.sph_harm_layer"><code class="docutils literal notranslate"><span class="pre">sph_harm_layer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.sph_harm_layer.forward"><code class="docutils literal notranslate"><span class="pre">sph_harm_layer.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.BesselBasis"><code class="docutils literal notranslate"><span class="pre">BesselBasis</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.BesselBasis.forward"><code class="docutils literal notranslate"><span class="pre">BesselBasis.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.GaussianSmearing"><code class="docutils literal notranslate"><span class="pre">GaussianSmearing</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.basis_functions.GaussianSmearing.forward"><code class="docutils literal notranslate"><span class="pre">GaussianSmearing.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.utils.cutoff_functions">Cutoff Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.cutoff_function"><code class="docutils literal notranslate"><span class="pre">cutoff_function()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.cuttoff_envelope"><code class="docutils literal notranslate"><span class="pre">cuttoff_envelope</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.cuttoff_envelope.forward"><code class="docutils literal notranslate"><span class="pre">cuttoff_envelope.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.CosineCutoff"><code class="docutils literal notranslate"><span class="pre">CosineCutoff</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.CosineCutoff.forward"><code class="docutils literal notranslate"><span class="pre">CosineCutoff.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.SoftUnitStepCutoff"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.SoftUnitStepCutoff.cutoff"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff.cutoff</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.SoftUnitStepCutoff.cut_param"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff.cut_param</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.cutoff_functions.SoftUnitStepCutoff.forward"><code class="docutils literal notranslate"><span class="pre">SoftUnitStepCutoff.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.utils.regression_layers">Regression Layers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.regression_layers.denseRegression"><code class="docutils literal notranslate"><span class="pre">denseRegression</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.regression_layers.denseRegression.forward"><code class="docutils literal notranslate"><span class="pre">denseRegression.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.regression_layers.MLPRegression"><code class="docutils literal notranslate"><span class="pre">MLPRegression</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.regression_layers.MLPRegression.forward"><code class="docutils literal notranslate"><span class="pre">MLPRegression.forward()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/model_components.html#module-HamGNN_v_2_1.utils.hparam">Hyperparameter Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/model_components.html#HamGNN_v_2_1.utils.hparam.get_hparam_dict"><code class="docutils literal notranslate"><span class="pre">get_hparam_dict()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/data_processing.html">Data Processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/data_processing.html#graph-data">Graph Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/configuration.html#module-HamGNN_v_2_1.config.config_parsing">Config Parsing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/configuration.html#HamGNN_v_2_1.config.config_parsing.config_default"><code class="docutils literal notranslate"><span class="pre">config_default</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/configuration.html#HamGNN_v_2_1.config.config_parsing.recursive_update"><code class="docutils literal notranslate"><span class="pre">recursive_update()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/configuration.html#HamGNN_v_2_1.config.config_parsing.load_config"><code class="docutils literal notranslate"><span class="pre">load_config()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/utilities.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities.html#module-HamGNN_v_2_1.utils.irreps_utils">Irreps Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.irreps_utils.extract_scalar_irreps"><code class="docutils literal notranslate"><span class="pre">extract_scalar_irreps()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.irreps_utils.irreps2gate"><code class="docutils literal notranslate"><span class="pre">irreps2gate()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.irreps_utils.scale_irreps"><code class="docutils literal notranslate"><span class="pre">scale_irreps()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.irreps_utils.filter_and_split_irreps"><code class="docutils literal notranslate"><span class="pre">filter_and_split_irreps()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities.html#module-HamGNN_v_2_1.utils.triplets">Triplets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.triplets.triplets"><code class="docutils literal notranslate"><span class="pre">triplets()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities.html#module-HamGNN_v_2_1.utils.math_utils">Math Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.math_utils.count_neighbors_per_node"><code class="docutils literal notranslate"><span class="pre">count_neighbors_per_node()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.math_utils.prod"><code class="docutils literal notranslate"><span class="pre">prod()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.math_utils.blockwise_2x2_concat"><code class="docutils literal notranslate"><span class="pre">blockwise_2x2_concat()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.math_utils.extract_elements_above_threshold"><code class="docutils literal notranslate"><span class="pre">extract_elements_above_threshold()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.math_utils.upgrade_tensor_precision"><code class="docutils literal notranslate"><span class="pre">upgrade_tensor_precision()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities.html#module-HamGNN_v_2_1.utils.losses">Loss Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.cosine_similarity_loss"><code class="docutils literal notranslate"><span class="pre">cosine_similarity_loss</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.cosine_similarity_loss.forward"><code class="docutils literal notranslate"><span class="pre">cosine_similarity_loss.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.sum_zero_loss"><code class="docutils literal notranslate"><span class="pre">sum_zero_loss</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.sum_zero_loss.forward"><code class="docutils literal notranslate"><span class="pre">sum_zero_loss.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.Euclidean_loss"><code class="docutils literal notranslate"><span class="pre">Euclidean_loss</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.Euclidean_loss.forward"><code class="docutils literal notranslate"><span class="pre">Euclidean_loss.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.RMSELoss"><code class="docutils literal notranslate"><span class="pre">RMSELoss</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.RMSELoss.forward"><code class="docutils literal notranslate"><span class="pre">RMSELoss.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.losses.parse_metric_func"><code class="docutils literal notranslate"><span class="pre">parse_metric_func()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/utilities.html#module-HamGNN_v_2_1.utils.visualization">Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/utilities.html#HamGNN_v_2_1.utils.visualization.scatter_plot"><code class="docutils literal notranslate"><span class="pre">scatter_plot()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">HamGNN_v_2_1</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">HamGNN_v_2_1.models.hamgnn_output</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for HamGNN_v_2_1.models.hamgnn_output</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">opt_einsum</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">oe</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">e3nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">o3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">e3nn.util.jit</span><span class="w"> </span><span class="kn">import</span> <span class="n">compile_mode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.core.periodic_table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Element</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.core.structure</span><span class="w"> </span><span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pymatgen.symmetry.kpath</span><span class="w"> </span><span class="kn">import</span> <span class="n">KPathSeek</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">global_mean_pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch_scatter</span><span class="w"> </span><span class="kn">import</span> <span class="n">scatter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..nn.interaction_blocks</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResidualBlock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..nn.tensor_decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">E3TensorDecomposition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..physics.Clebsch_Gordan_coefficients</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClebschGordanCoefficients</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..physics.kpoints</span><span class="w"> </span><span class="kn">import</span> <span class="n">kpoints_generator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">au2ang</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.math_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">blockwise_2x2_concat</span><span class="p">,</span>
    <span class="n">extract_elements_above_threshold</span><span class="p">,</span>
    <span class="n">upgrade_tensor_precision</span>
<span class="p">)</span>

<div class="viewcode-block" id="HamLayer">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamLayer">[docs]</a>
<span class="nd">@compile_mode</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HamLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irreps_in</span><span class="p">,</span> <span class="n">feature_irreps_hidden</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">nonlinearity_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gate&quot;</span><span class="p">,</span> <span class="n">resnet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="c1"># Define the residual block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_block</span> <span class="o">=</span> <span class="n">ResidualBlock</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span> 
                                            <span class="n">feature_irreps_hidden</span><span class="o">=</span><span class="n">feature_irreps_hidden</span><span class="p">,</span> 
                                            <span class="n">nonlinearity_type</span><span class="o">=</span><span class="n">nonlinearity_type</span><span class="p">,</span> 
                                            <span class="n">resnet</span><span class="o">=</span><span class="n">resnet</span><span class="p">)</span>
        
        <span class="c1"># Define the linear transformation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_transform</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_out</span><span class="o">=</span><span class="n">irreps_out</span><span class="p">)</span>
    
<div class="viewcode-block" id="HamLayer.forward">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamLayer.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Apply the residual block</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="c1"># Apply the linear transformation</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">x</span></div>
</div>


<div class="viewcode-block" id="HamGNNPlusPlusOut">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HamGNNPlusPlusOut</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Neural network module for computing Hamiltonian matrices using Graph Neural Networks.</span>
<span class="sd">    </span>
<span class="sd">    This class implements a GNN architecture for quantum chemistry applications, supporting</span>
<span class="sd">    different Hamiltonian types (openmx, siesta, abacus) with various configuration options</span>
<span class="sd">    for physics-informed neural network training.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        irreps_in_node (Union[int, str, o3.Irreps]): Input irreps for node features.</span>
<span class="sd">        irreps_in_edge (Union[int, str, o3.Irreps]): Input irreps for edge features.</span>
<span class="sd">        nao_max (int): Maximum number of atomic orbitals.</span>
<span class="sd">        return_forces (bool): Whether to compute forces during forward pass.</span>
<span class="sd">        create_graph (bool): Whether to create computational graph for backpropagation.</span>
<span class="sd">        ham_type (str): Type of Hamiltonian (&#39;openmx&#39;, &#39;siesta&#39;, &#39;abacus&#39;, or &#39;pasp&#39;).</span>
<span class="sd">        ham_only (bool): Whether to only compute the Hamiltonian matrix.</span>
<span class="sd">        symmetrize (bool): Whether to symmetrize the Hamiltonian matrix.</span>
<span class="sd">        include_triplet (bool): Whether to include triplet interactions.</span>
<span class="sd">        calculate_band_energy (bool): Whether to calculate band energies.</span>
<span class="sd">        num_k (int): Number of k-points for band structure calculations.</span>
<span class="sd">        k_path (Union[list, np.ndarray, tuple]): Path in k-space for band structure.</span>
<span class="sd">        band_num_control (dict or int): Control for band numbers.</span>
<span class="sd">        soc_switch (bool): Whether to include spin-orbit coupling.</span>
<span class="sd">        nonlinearity_type (str): Type of nonlinearity for neural network layers.</span>
<span class="sd">        export_reciprocal_values (bool): Whether to export reciprocal space values.</span>
<span class="sd">        add_H0 (bool): Whether to add the initial Hamiltonian term H0.</span>
<span class="sd">        soc_basis (str): Basis for spin-orbit coupling (&#39;so3&#39; or &#39;su2&#39;).</span>
<span class="sd">        spin_constrained (bool): Whether to apply spin constraints.</span>
<span class="sd">        use_learned_weight (bool): Whether to use learned weights.</span>
<span class="sd">        minMagneticMoment (float): Minimum magnetic moment threshold.</span>
<span class="sd">        collinear_spin (bool): Whether to consider collinear spin.</span>
<span class="sd">        zero_point_shift (bool): Whether to apply zero-point energy shift.</span>
<span class="sd">        add_H_nonsoc (bool): Whether to add non-SOC Hamiltonian.</span>
<span class="sd">        get_nonzero_mask_tensor (bool): Whether to get nonzero mask tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">irreps_in_node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">irreps_in_edge</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">nao_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> 
                 <span class="n">return_forces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">create_graph</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">ham_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;openmx&#39;</span><span class="p">,</span> 
                 <span class="n">ham_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">symmetrize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">include_triplet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">calculate_band_energy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">num_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> 
                 <span class="n">k_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">band_num_control</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">soc_switch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">nonlinearity_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gate&#39;</span><span class="p">,</span> 
                 <span class="n">export_reciprocal_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">add_H0</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">soc_basis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;so3&#39;</span><span class="p">,</span>
                 <span class="n">spin_constrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                 <span class="n">use_learned_weight</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                 <span class="n">minMagneticMoment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> 
                 <span class="n">collinear_spin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">zero_point_shift</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">add_H_nonsoc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">get_nonzero_mask_tensor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">calculate_sparsity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                 <span class="p">):</span>
        
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Store force computation settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derivative</span> <span class="o">=</span> <span class="n">return_forces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_graph</span> <span class="o">=</span> <span class="n">create_graph</span>
        
        <span class="c1"># Store model parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">=</span> <span class="n">nao_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">=</span> <span class="n">ham_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span> <span class="o">=</span> <span class="n">ham_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span> <span class="o">=</span> <span class="n">symmetrize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_triplet</span> <span class="o">=</span> <span class="n">include_triplet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="o">=</span> <span class="n">soc_switch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonlinearity_type</span> <span class="o">=</span> <span class="n">nonlinearity_type</span>
        
        <span class="c1"># Output and export settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span> <span class="o">=</span> <span class="n">export_reciprocal_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span> <span class="o">=</span> <span class="n">add_H0</span>
        
        <span class="c1"># Spin-related parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span> <span class="o">=</span> <span class="n">spin_constrained</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_learned_weight</span> <span class="o">=</span> <span class="n">use_learned_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_magnetic_moment</span> <span class="o">=</span> <span class="n">minMagneticMoment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span> <span class="o">=</span> <span class="n">collinear_spin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">=</span> <span class="n">soc_basis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="c1"># Band structure calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span> <span class="o">=</span> <span class="n">calculate_band_energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span> <span class="o">=</span> <span class="n">num_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span> <span class="o">=</span> <span class="n">k_path</span>
        
        <span class="c1"># Additional physics parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span> <span class="o">=</span> <span class="n">zero_point_shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_H_nonsoc</span> <span class="o">=</span> <span class="n">add_H_nonsoc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span> <span class="o">=</span> <span class="n">get_nonzero_mask_tensor</span>
        
        <span class="c1"># Sparsity calculation flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sparsity</span> <span class="o">=</span> <span class="n">calculate_sparsity</span>
        
        <span class="c1"># Initialize configurations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_band_num_control</span><span class="p">(</span><span class="n">band_num_control</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_basis_information</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_irreducible_representations</span><span class="p">()</span>
        
        <span class="c1"># Clebsch-Gordan coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_calculator</span> <span class="o">=</span> <span class="n">ClebschGordanCoefficients</span><span class="p">(</span><span class="n">max_l</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span><span class="o">.</span><span class="n">lmax</span><span class="p">)</span>
        
        <span class="c1"># Hamiltonian networks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onsite_hamiltonian_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
            <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
            <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsite_hamiltonian_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
            <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
            <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span>
        <span class="p">)</span>
        
        <span class="c1"># Spin-orbit coupling networks</span>
        <span class="k">if</span> <span class="n">soc_switch</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">!=</span> <span class="s1">&#39;openmx&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">=</span> <span class="s1">&#39;su2&#39;</span>
            
            <span class="c1"># Initialize based on selected basis</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onsite_hamiltonian_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_su2</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsite_hamiltonian_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_su2</span>
                <span class="p">)</span>
            
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;so3&#39;</span><span class="p">:</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">onsite_ksi_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;0e&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsite_ksi_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;0e&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>
                <span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SOC basis &#39;</span><span class="si">{</span><span class="n">soc_basis</span><span class="si">}</span><span class="s2">&#39; not supported!&quot;</span><span class="p">)</span>
        
        <span class="c1"># Spin-constrained networks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
            <span class="c1"># J network</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onsite_J_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
                <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsite_J_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
                <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span>
            <span class="p">)</span>
            
            <span class="c1"># K network (if quartic term is enabled)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onsite_K_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsite_K_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span>
                <span class="p">)</span>
            
            <span class="c1"># Weight networks</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_learned_weight</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onsite_weight_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">offsite_weight_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                    <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
                    <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span>
                <span class="p">)</span>
        
        <span class="c1"># Overlap networks (if not Hamiltonian-only mode)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">onsite_overlap_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_node</span><span class="p">,</span> 
                <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsite_overlap_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hamiltonian_layer</span><span class="p">(</span>
                <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in_edge</span><span class="p">,</span> 
                <span class="n">irreps_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_irreducible_representations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the irreducible representations for the Hamiltonian and related tensors.</span>
<span class="sd">        </span>
<span class="sd">        Sets up Hamiltonian irreps, their dimensions, SU(2) basis irreps (if spin-orbit </span>
<span class="sd">        coupling is enabled), and J/K irreps (if spin-constrained mode is enabled).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Initialize main Hamiltonian irreps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">-</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">),</span> <span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="o">+</span><span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">))</span>
        
        <span class="c1"># Store dimensions for each irrep</span>
        <span class="k">for</span> <span class="n">irrep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irrep</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="p">)</span>
        
        <span class="c1"># SU(2) basis irreps (for spin-orbit coupling)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span><span class="p">):</span> 
            <span class="n">out_js_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                    <span class="n">out_js_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">li</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">lj</span><span class="o">.</span><span class="n">l</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_decomposition</span> <span class="o">=</span> <span class="n">E3TensorDecomposition</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> 
                <span class="n">out_js_list</span><span class="p">,</span> 
                <span class="n">default_dtype_torch</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">(),</span>
                <span class="n">nao_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> 
                <span class="n">spinful</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_su2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_decomposition</span><span class="o">.</span><span class="n">required_irreps_out</span>
        
        <span class="c1"># Spin-constrained mode irreps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
            <span class="c1"># Initialize J and K irreps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dimensions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dimensions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">=</span> <span class="mi">0</span>            
            
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># t=1, p=1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># t=1, p=1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span> <span class="o">+=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irrep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># t=1, p=1</span>
            
            <span class="c1"># Store dimensions for J and K irreps</span>
            <span class="k">for</span> <span class="n">irrep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irrep</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">irrep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irrep</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>   
            
            <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dimensions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dimensions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dimensions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K_irreps_dimensions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_basis_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize basis information based on the selected Hamiltonian type.</span>
<span class="sd">        </span>
<span class="sd">        Configures basis sets for different Hamiltonian types:</span>
<span class="sd">        - openmx: Basis sets for OpenMX DFT code</span>
<span class="sd">        - siesta: Basis sets for SIESTA DFT code</span>
<span class="sd">        - abacus: Basis sets for ABACUS DFT code</span>
<span class="sd">        - pasp: Simplified basis set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;openmx&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_openmx_basis</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;siesta&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_siesta_basis</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;abacus&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_abacus_basis</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="o">==</span> <span class="s1">&#39;pasp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x1o&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hamiltonian type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span><span class="si">}</span><span class="s2">&#39; is not supported.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_openmx_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets basis information for &#39;openmx&#39; Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span> <span class="o">=</span> <span class="p">{</span><span class="n">Element</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;He&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Be&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ne&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ti&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Co&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Se&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Br&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Kr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ru&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;In&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Te&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Xe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ba&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;La&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ce&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Lu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>  <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Re&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
                            <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Bi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="mi">15</span>
                        <span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">14</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># H</span>
                                <span class="mi">2</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># He</span>
                                <span class="mi">3</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Li</span>
                                <span class="mi">4</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Be</span>
                                <span class="mi">5</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># B</span>
                                <span class="mi">6</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># C</span>
                                <span class="mi">7</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># N</span>
                                <span class="mi">8</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># O</span>
                                <span class="mi">9</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># F</span>
                                <span class="mi">10</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ne</span>
                                <span class="mi">11</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Na</span>
                                <span class="mi">12</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mg</span>
                                <span class="mi">13</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Al</span>
                                <span class="mi">14</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Si</span>
                                <span class="mi">15</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># p</span>
                                <span class="mi">16</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># S</span>
                                <span class="mi">17</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Cl</span>
                                <span class="mi">18</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ar</span>
                                <span class="mi">19</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># K</span>
                                <span class="mi">20</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ca</span>
                                <span class="mi">35</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Br  </span>
                                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># V</span>
                                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mn</span>
                            <span class="p">}</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="c1"># H</span>
                                <span class="mi">5</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># B</span>
                                <span class="mi">6</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># C</span>
                                <span class="mi">7</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># N</span>
                                <span class="mi">8</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]</span> <span class="c1"># O</span>
                            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">19</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">15</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">{</span>  <span class="mi">1</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># H</span>
                <span class="mi">2</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="c1"># He</span>
                <span class="mi">3</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Li</span>
                <span class="mi">4</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1"># Be</span>
                <span class="mi">5</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># B</span>
                <span class="mi">6</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># C</span>
                <span class="mi">7</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># N</span>
                <span class="mi">8</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># O</span>
                <span class="mi">9</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ne</span>
                <span class="mi">11</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Na</span>
                <span class="mi">12</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mg</span>
                <span class="mi">13</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Al</span>
                <span class="mi">14</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># p</span>
                <span class="mi">16</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ar</span>
                <span class="mi">19</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># K</span>
                <span class="mi">20</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ca</span>
                <span class="mi">25</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Mn</span>
                <span class="mi">42</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Mo  </span>
                <span class="mi">83</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Bi  </span>
                <span class="mi">34</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Se </span>
                <span class="mi">24</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Cr </span>
                <span class="mi">53</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># I</span>
                <span class="mi">28</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Ni</span>
                <span class="mi">35</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Br </span>
                <span class="mi">26</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># Fe</span>
                <span class="mi">77</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Ir</span>
                <span class="mi">52</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Te</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span> <span class="c1"># V</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="c1"># Sb</span>
            <span class="p">}</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">19</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e+1x3o&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span><span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span><span class="n">f1</span><span class="o">=</span><span class="p">[</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">]:</span> <span class="p">{</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span>  <span class="c1"># H6.0-s2p1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;He&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span>  <span class="c1"># He8.0-s2p1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Li&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="p">,</span>  <span class="c1"># Li8.0-s3p2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Be&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="p">,</span>  <span class="c1"># Be7.0-s2p2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># B7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># C6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># N6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># O6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># F6.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ne&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ne9.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Na9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Mg9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Al7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Si7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># P7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># S7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Cl7.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ar9.0-s2p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># K10.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ca9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Sc9.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ti&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ti7.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># V6.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Cr6.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Mn6.0-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Fe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Fe5.5H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Co&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Co6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Ni6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Cu6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span>  <span class="c1"># Zn6.0H-s3p2d1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ga7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ge7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># As7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Se&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Se7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Br&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Br7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Kr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Kr10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Rb11.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Sr10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Y10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Zr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Zr7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Nb7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Mo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Mo7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Tc7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ru&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ru7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Rh7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Pd7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ag7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Cd7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;In&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># In7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Sn7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Sb7.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Te&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Te7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># I7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Xe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Xe11.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Cs12.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ba&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span>  <span class="c1"># Ba10.0-s3p2d2</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;La&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># La8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ce&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ce8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pr8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Nd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Nd8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pm8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Sm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Sm8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Dy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Dy8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ho&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ho8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Lu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Lu8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Hf9.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ta7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># W7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Re&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Re7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Os&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Os7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Ir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Ir7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pt7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Au&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Au7.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Hg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Hg8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Tl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Tl8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Pb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Pb8.0-s3p2d2f1</span>
                <span class="n">Element</span><span class="p">[</span><span class="s1">&#39;Bi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>  <span class="c1"># Bi8.0-s3p2d2f1 </span>
            <span class="p">})()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NAO max &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="si">}</span><span class="s2">&#39; not supported for &#39;openmx&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_siesta_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets basis information for &#39;siesta&#39; Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="mi">11</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">13</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">14</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">15</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="mi">16</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="mi">17</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span><span class="mi">18</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="mi">19</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">22</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">33</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="mi">72</span><span class="p">:</span><span class="mi">4</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="kc">None</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">])</span> <span class="c1"># this list should follow the order in siesta. See spher_harm.f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span> <span class="p">{</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># H</span>
                <span class="mi">2</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># He</span>
                <span class="mi">3</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Li</span>
                <span class="mi">4</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Be</span>
                <span class="mi">5</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># B</span>
                <span class="mi">6</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># C</span>
                <span class="mi">7</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># N</span>
                <span class="mi">8</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># O</span>
                <span class="mi">9</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ne</span>
                <span class="mi">11</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Na</span>
                <span class="mi">12</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Mg</span>
                <span class="mi">13</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Al</span>
                <span class="mi">14</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># P</span>
                <span class="mi">16</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ar</span>
                <span class="mi">19</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># K</span>
                <span class="mi">20</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">31</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ga</span>
                <span class="mi">33</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># As</span>
            <span class="p">})()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">19</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">])</span> <span class="c1"># this list should follow the order in siesta. See spher_harm.f</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">],</span><span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">]:</span> <span class="p">{</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># H</span>
                <span class="mi">2</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># He</span>
                <span class="mi">3</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Li</span>
                <span class="mi">4</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Be</span>
                <span class="mi">5</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># B</span>
                <span class="mi">6</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># C</span>
                <span class="mi">7</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># N</span>
                <span class="mi">8</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># O</span>
                <span class="mi">9</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ne</span>
                <span class="mi">11</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Na</span>
                <span class="mi">12</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Mg</span>
                <span class="mi">13</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Al</span>
                <span class="mi">14</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># P</span>
                <span class="mi">16</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ar</span>
                <span class="mi">19</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># K</span>
                <span class="mi">20</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Cl</span>
                <span class="mi">22</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">,</span> <span class="c1"># Ti, created by Qin.</span>
            <span class="p">})()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NAO max &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="si">}</span><span class="s2">&#39; not supported for &#39;siesta&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_abacus_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets basis information for &#39;abacus&#39; Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="mi">3</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="mi">5</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">6</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="mi">7</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">8</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">9</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">10</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                        <span class="mi">11</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">13</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="mi">15</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">16</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">17</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">18</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                        <span class="mi">19</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">20</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">21</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                        <span class="mi">23</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">24</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">25</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">26</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">27</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">28</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">29</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="mi">31</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">32</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">33</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">34</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">35</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">36</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                        <span class="mi">37</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">38</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">39</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                        <span class="mi">41</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">42</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">43</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">44</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">45</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">46</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">47</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">48</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="mi">49</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">50</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">51</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">52</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">53</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">54</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">55</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">56</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                        <span class="mi">57</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">72</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
                        <span class="mi">73</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">74</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
                        <span class="mi">75</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">76</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                        <span class="mi">77</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">78</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
                        <span class="mi">79</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">80</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="mi">81</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">82</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                        <span class="mi">83</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x1o+1x1o+1x2e&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">]:</span> <span class="p">{</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># H</span>
                <span class="mi">2</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># He</span>
                <span class="mi">5</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># B</span>
                <span class="mi">6</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># C</span>
                <span class="mi">7</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># N</span>
                <span class="mi">8</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># O</span>
                <span class="mi">9</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># F</span>
                <span class="mi">10</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Ne</span>
                <span class="mi">14</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Si</span>
                <span class="mi">15</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># P</span>
                <span class="mi">16</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># S</span>
                <span class="mi">17</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Cl</span>
                <span class="mi">18</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="c1"># Ar</span>
            <span class="p">})()</span>           
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x0e+1x1o+1x1o+1x2e+1x2e+1x3o&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">])</span> <span class="c1"># this list should follow the order in abacus.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">s4</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span><span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span><span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">],</span><span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">],</span><span class="n">f1</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">]:</span> <span class="p">{</span>
            <span class="mi">1</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># H</span>
            <span class="mi">2</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># He</span>
            <span class="mi">3</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Li</span>
            <span class="mi">4</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> <span class="c1"># Bi</span>
            <span class="mi">5</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># B</span>
            <span class="mi">6</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># C</span>
            <span class="mi">7</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># N</span>
            <span class="mi">8</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># O</span>
            <span class="mi">9</span> <span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># F</span>
            <span class="mi">10</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ne</span>
            <span class="mi">11</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Na</span>
            <span class="mi">12</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Mg</span>
            <span class="c1"># 13: Al</span>
            <span class="mi">14</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Si</span>
            <span class="mi">15</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># P</span>
            <span class="mi">16</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># S</span>
            <span class="mi">17</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cl</span>
            <span class="mi">18</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ar</span>
            <span class="mi">19</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># K</span>
            <span class="mi">20</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Ca</span>
            <span class="mi">21</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Sc</span>
            <span class="mi">22</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ti</span>
            <span class="mi">23</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># V</span>
            <span class="mi">24</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Cr</span>
            <span class="mi">25</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Mn</span>
            <span class="mi">26</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Fe</span>
            <span class="mi">27</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Co</span>
            <span class="mi">28</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ni</span>
            <span class="mi">29</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Cu</span>
            <span class="mi">30</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Zn</span>
            <span class="mi">31</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ga</span>
            <span class="mi">32</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ge</span>
            <span class="mi">33</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># As</span>
            <span class="mi">34</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Se</span>
            <span class="mi">35</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Br</span>
            <span class="mi">36</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Kr</span>
            <span class="mi">37</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Rb</span>
            <span class="mi">38</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Sr</span>
            <span class="mi">39</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Y</span>
            <span class="mi">40</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Zr</span>
            <span class="mi">41</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Nb</span>
            <span class="mi">42</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Mo</span>
            <span class="mi">43</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Tc</span>
            <span class="mi">44</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ru</span>
            <span class="mi">45</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Rh</span>
            <span class="mi">46</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Pd</span>
            <span class="mi">47</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ag</span>
            <span class="mi">48</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Cd</span>
            <span class="mi">49</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># In</span>
            <span class="mi">50</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Sn</span>
            <span class="mi">51</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Sb</span>
            <span class="mi">52</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Te</span>
            <span class="mi">53</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># I</span>
            <span class="mi">54</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Xe</span>
            <span class="mi">55</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> <span class="c1"># Cs</span>
            <span class="mi">56</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Ba</span>
            <span class="c1">#</span>
            <span class="mi">79</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Au</span>
            <span class="mi">80</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Hg</span>
            <span class="mi">81</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Tl</span>
            <span class="mi">82</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Pb</span>
            <span class="mi">83</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> <span class="c1"># Bi</span>
        <span class="p">})()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">33</span><span class="p">])</span>       
            <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">o3</span><span class="o">.</span><span class="n">Irreps</span><span class="p">(</span><span class="s2">&quot;1x0e+1x0e+1x0e+1x0e+1x1o+1x1o+1x1o+1x1o+1x2e+1x2e+1x3o+1x3o&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">39</span><span class="p">])</span> <span class="c1"># this list should follow the order in abacus.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">s1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">s2</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">s3</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                   <span class="n">s4</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                   <span class="n">p1</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                   <span class="n">p2</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span>
                   <span class="n">p3</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span>
                   <span class="n">p4</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span>
                   <span class="n">d1</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                   <span class="n">d2</span><span class="o">=</span><span class="p">[</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">25</span><span class="p">],</span>
                   <span class="n">f1</span><span class="o">=</span><span class="p">[</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">],</span>
                   <span class="n">f2</span><span class="o">=</span><span class="p">[</span><span class="mi">33</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">39</span><span class="p">]:</span> <span class="p">{</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ag&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Al&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">p3</span><span class="o">+</span><span class="n">p4</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;As&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Au&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ba&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Be&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Bi&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Br&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ca&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Co&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Cu&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Fe&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ga&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ge&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;He&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Hf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="p">,</span>  <span class="c1"># Hf_gga_10au_100Ry_4s2p2d2f.orb</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Hg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;In&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Kr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Li&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Mg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Mn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Mo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Nb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ne&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ni&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Pb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Pd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Pt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Re&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Rh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ru&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Se&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Si&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Sr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="p">,</span>  <span class="c1"># Ta_gga_10au_100Ry_4s2p2d2f.orb</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Tc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Te&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Ti&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Tl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="p">,</span>  <span class="c1"># W_gga_10au_100Ry_4s2p2d2f.orb</span>
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Xe&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Zn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span> 
                <span class="n">Element</span><span class="p">(</span><span class="s1">&#39;Zr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span><span class="p">:</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">+</span><span class="n">s3</span><span class="o">+</span><span class="n">s4</span><span class="o">+</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="o">+</span><span class="n">f1</span><span class="p">,</span>
                <span class="p">})()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NAO max &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="si">}</span><span class="s2">&#39; not supported for &#39;abacus&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_band_num_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_num_control</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure band number control settings.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            band_num_control (dict or int): Band number control configuration.</span>
<span class="sd">                If dict, maps atomic numbers to band counts.</span>
<span class="sd">                If int, specifies a global band count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Convert atomic numbers to integers for consistency</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">band_num_control</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="n">band_num_control</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_hamiltonian_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Hamiltonian neural network layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            irreps_in (o3.Irreps): Input irreducible representations.</span>
<span class="sd">            irreps_out (o3.Irreps): Output irreducible representations.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            HamLayer: A neural network layer for Hamiltonian prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HamLayer</span><span class="p">(</span>
            <span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span>
            <span class="n">feature_irreps_hidden</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span>
            <span class="n">irreps_out</span><span class="o">=</span><span class="n">irreps_out</span><span class="p">,</span>
            <span class="n">nonlinearity_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nonlinearity_type</span><span class="p">,</span>
            <span class="n">resnet</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

<div class="viewcode-block" id="HamGNNPlusPlusOut.merge_tensor_components">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.merge_tensor_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_tensor_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spherical_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge spherical tensor components into a matrix using Clebsch-Gordan coefficients.</span>

<span class="sd">        Args:</span>
<span class="sd">            spherical_components (list of torch.Tensor): List of tensors representing spherical </span>
<span class="sd">                components of irreducible representations. Each tensor has shape </span>
<span class="sd">                (batch_size, component_dim).</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Merged matrix with shape (batch_size, nao_max * nao_max) representing</span>
<span class="sd">                flattened matrix of merged components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">spherical_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">spherical_components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">component_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Index for accessing the correct irreps</span>
        <span class="n">row_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">row_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Dimension based on angular momentum</span>
            <span class="n">col_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="n">col_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Dimension based on angular momentum</span>

                <span class="c1"># Iterate through allowed angular momentum values</span>
                <span class="k">for</span> <span class="n">angular_momentum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span><span class="p">),</span> <span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># Compute inverse spherical tensor product             </span>
                    <span class="n">clebsch_gordan_coef</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">angular_momentum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_calculator</span><span class="p">(</span>
                        <span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">angular_momentum</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">tensor_product</span> <span class="o">=</span> <span class="p">(</span><span class="n">clebsch_gordan_coef</span> <span class="o">*</span> <span class="n">spherical_components</span><span class="p">[</span><span class="n">component_index</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># Add product to appropriate part of the result matrix</span>
                    <span class="n">submatrix</span> <span class="o">=</span> <span class="n">result_matrix</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">row_start_idx</span><span class="p">,</span> <span class="n">row_dimension</span><span class="p">)</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_start_idx</span><span class="p">,</span> <span class="n">col_dimension</span><span class="p">)</span>
                    <span class="n">submatrix</span> <span class="o">+=</span> <span class="n">tensor_product</span>
                    <span class="n">component_index</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">col_start_idx</span> <span class="o">+=</span> <span class="n">col_dimension</span>
            <span class="n">row_start_idx</span> <span class="o">+=</span> <span class="n">row_dimension</span>

        <span class="k">return</span> <span class="n">result_matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.merge_rank2_tensor_components">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.merge_rank2_tensor_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_rank2_tensor_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spherical_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge rank-2 tensor components into a block matrix representation.</span>

<span class="sd">        This function is specialized for rank-2 tensors and applies permutation to the result.</span>

<span class="sd">        Args:</span>
<span class="sd">            spherical_components (list of torch.Tensor): List of tensors representing spherical</span>
<span class="sd">                components of irreducible representations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Merged block matrix with shape (batch_size, n_blocks, 3, 3) after</span>
<span class="sd">                applying a specific permutation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">spherical_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_blocks</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">spherical_components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">permutation_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># Indices for coordinate permutation</span>

        <span class="n">component_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Index for accessing the correct irreps</span>
        <span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">angular_momentum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="c1"># Compute inverse spherical tensor product             </span>
                    <span class="n">clebsch_gordan_coef</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">angular_momentum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_calculator</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">angular_momentum</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">tensor_product</span> <span class="o">=</span> <span class="p">(</span><span class="n">clebsch_gordan_coef</span> <span class="o">*</span> <span class="n">spherical_components</span><span class="p">[</span><span class="n">component_index</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># Add product to appropriate part of the block</span>
                    <span class="n">result_matrix</span><span class="p">[:,</span> <span class="n">block_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">tensor_product</span>
                    <span class="n">component_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">block_index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Apply permutation to the result</span>
        <span class="n">permuted_result</span> <span class="o">=</span> <span class="n">result_matrix</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">permutation_indices</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">permutation_indices</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="k">return</span> <span class="n">permuted_result</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.merge_rank0_tensor_components">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.merge_rank0_tensor_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_rank0_tensor_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spherical_components</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge rank-0 (scalar) tensor components into a matrix representation.</span>

<span class="sd">        Args:</span>
<span class="sd">            spherical_components (list of torch.Tensor): List of tensors representing spherical</span>
<span class="sd">                components of irreducible representations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Merged matrix with shape (batch_size, nao_max, nao_max).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">spherical_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">spherical_components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">component_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Index for accessing the correct irreps</span>
        <span class="n">row_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">row_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Dimension based on angular momentum</span>
            <span class="n">col_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="n">col_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Dimension based on angular momentum</span>

                <span class="c1"># For rank-0, we just expand the component to fill the submatrix</span>
                <span class="n">expanded_component</span> <span class="o">=</span> <span class="n">spherical_components</span><span class="p">[</span><span class="n">component_index</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_dimension</span><span class="p">,</span> <span class="n">col_dimension</span><span class="p">)</span>

                <span class="c1"># Add expanded component to appropriate part of the result matrix</span>
                <span class="n">submatrix</span> <span class="o">=</span> <span class="n">result_matrix</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">row_start_idx</span><span class="p">,</span> <span class="n">row_dimension</span><span class="p">)</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_start_idx</span><span class="p">,</span> <span class="n">col_dimension</span><span class="p">)</span>
                <span class="n">submatrix</span> <span class="o">+=</span> <span class="n">expanded_component</span>
                <span class="n">component_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col_start_idx</span> <span class="o">+=</span> <span class="n">col_dimension</span>
            <span class="n">row_start_idx</span> <span class="o">+=</span> <span class="n">row_dimension</span>

        <span class="k">return</span> <span class="n">result_matrix</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.construct_j_coupling_matrix">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.construct_j_coupling_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_j_coupling_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupling_coefficients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a matrix representation of J-coupling (spin-orbit interaction).</span>

<span class="sd">        Builds a matrix representation for J-coupling which can be either rank-2 </span>
<span class="sd">        (with spin-orbit coupling) or rank-0.</span>

<span class="sd">        Args:</span>
<span class="sd">            coupling_coefficients (torch.Tensor): Tensor containing coupling coefficients.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The J-coupling matrix. If spin-orbit coupling is enabled,</span>
<span class="sd">                shape is (batch_size, nao_max, nao_max, 3, 3); otherwise, shape is</span>
<span class="sd">                (batch_size, nao_max, nao_max).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Split coupling coefficients into spherical components</span>
        <span class="n">spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">coupling_coefficients</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_irreps_dim</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>  <span class="c1"># If spin-orbit coupling is enabled</span>
            <span class="c1"># Use rank-2 tensor merge for spin-orbit coupling</span>
            <span class="n">processed_coefficients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_rank2_tensor_components</span><span class="p">(</span><span class="n">spherical_components</span><span class="p">)</span>
            <span class="n">result_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">processed_coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
            <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">processed_coefficients</span><span class="p">)</span>

            <span class="c1"># Distribute the blocks to the full matrix</span>
            <span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">row_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="n">row_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">col_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                    <span class="n">col_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># Expand block to fill the corresponding submatrix</span>
                    <span class="n">block_expanded</span> <span class="o">=</span> <span class="n">processed_coefficients</span><span class="p">[:,</span> <span class="n">block_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                        <span class="n">processed_coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row_dimension</span><span class="p">,</span> <span class="n">col_dimension</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
                    <span class="p">)</span>
                    <span class="n">result_matrix</span><span class="p">[:,</span> <span class="n">row_start_idx</span><span class="p">:</span><span class="n">row_start_idx</span><span class="o">+</span><span class="n">row_dimension</span><span class="p">,</span> 
                                  <span class="n">col_start_idx</span><span class="p">:</span><span class="n">col_start_idx</span><span class="o">+</span><span class="n">col_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_expanded</span>

                    <span class="n">block_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">col_start_idx</span> <span class="o">+=</span> <span class="n">col_dimension</span>
                <span class="n">row_start_idx</span> <span class="o">+=</span> <span class="n">row_dimension</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use rank-0 tensor merge if spin-orbit coupling is disabled</span>
            <span class="n">result_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_rank0_tensor_components</span><span class="p">(</span><span class="n">spherical_components</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_matrix</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.construct_k_coupling_matrix">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.construct_k_coupling_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_k_coupling_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupling_coefficients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a matrix representation of exchange coupling (K-term).</span>

<span class="sd">        Args:</span>
<span class="sd">            coupling_coefficients (torch.Tensor): Tensor containing exchange coupling coefficients</span>
<span class="sd">                with shape (n_atoms_or_edges, coefficients_per_block * n_blocks).</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Exchange coupling matrix with shape (n_atoms_or_edges, nao_max, nao_max).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reshape to separate blocks</span>
        <span class="n">reshaped_coefficients</span> <span class="o">=</span> <span class="n">coupling_coefficients</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coupling_coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Initialize result matrix</span>
        <span class="n">result_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">reshaped_coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
        <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">reshaped_coefficients</span><span class="p">)</span>

        <span class="c1"># Distribute coefficients to blocks</span>
        <span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">row_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">row_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">row_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col_orbital</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
                <span class="n">col_dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">col_orbital</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># Expand coefficient to fill the block</span>
                <span class="n">expanded_coefficient</span> <span class="o">=</span> <span class="n">reshaped_coefficients</span><span class="p">[:,</span> <span class="n">block_index</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                    <span class="n">reshaped_coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row_dimension</span><span class="p">,</span> <span class="n">col_dimension</span>
                <span class="p">)</span>

                <span class="c1"># Place in the appropriate position in the result matrix</span>
                <span class="n">result_matrix</span><span class="p">[:,</span> <span class="n">row_start_idx</span><span class="p">:</span><span class="n">row_start_idx</span><span class="o">+</span><span class="n">row_dimension</span><span class="p">,</span> 
                              <span class="n">col_start_idx</span><span class="p">:</span><span class="n">col_start_idx</span><span class="o">+</span><span class="n">col_dimension</span><span class="p">]</span> <span class="o">=</span> <span class="n">expanded_coefficient</span>

                <span class="n">block_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col_start_idx</span> <span class="o">+=</span> <span class="n">col_dimension</span>
            <span class="n">row_start_idx</span> <span class="o">+=</span> <span class="n">row_dimension</span>

        <span class="k">return</span> <span class="n">result_matrix</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.reorder_matrix">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.reorder_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reorder_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reorder matrix elements to match the atomic orbital convention used by DFT.</span>

<span class="sd">        This function performs two types of transformations:</span>
<span class="sd">        1. Reorders rows and columns according to a predefined permutation (if defined)</span>
<span class="sd">        2. Flips the sign of specific elements (if defined)</span>

<span class="sd">        These transformations ensure compatibility with DFT&#39;s atomic orbital ordering</span>
<span class="sd">        convention, which may differ from the internal representation.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix (torch.Tensor): Input matrix in flattened form,</span>
<span class="sd">                with shape (batch_size, nao_max2) where nao_max is the maximum</span>
<span class="sd">                number of atomic orbitals.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Reordered matrix in the same shape as input,</span>
<span class="sd">                but with elements rearranged to match DFT conventions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Only perform reordering if necessary index maps are defined</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;minus_index&#39;</span><span class="p">):</span>
            <span class="c1"># Reshape to 3D tensor for easier manipulation</span>
            <span class="n">matrix_form</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="c1"># Apply index permutation if defined</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Use advanced indexing to permute both rows and columns</span>
                <span class="n">matrix_form</span> <span class="o">=</span> <span class="n">matrix_form</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_change</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]]</span>

            <span class="c1"># Apply sign flipping if defined</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;minus_index&#39;</span><span class="p">):</span>
                <span class="c1"># Flip signs for specified rows</span>
                <span class="n">matrix_form</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">matrix_form</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># Flip signs for specified columns</span>
                <span class="n">matrix_form</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">matrix_form</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_index</span><span class="p">]</span>

            <span class="c1"># Return to original flattened shape</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix_form</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">matrix</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.construct_molecular_hamiltonian">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.construct_molecular_hamiltonian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">construct_molecular_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a complete molecular Hamiltonian matrix from on-site and off-site components.</span>

<span class="sd">        This function transforms separate on-site (diagonal) and off-site (interaction) Hamiltonian </span>
<span class="sd">        components into a unified molecular Hamiltonian matrix. It handles atom-specific orbital </span>
<span class="sd">        basis sets and masks invalid or padded orbitals.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Object containing crystal structure information, including:</span>
<span class="sd">                - z: Atomic numbers</span>
<span class="sd">                - node_counts: Number of atoms in each crystal</span>
<span class="sd">                - edge_index: Edges between atoms (indices of connected atom pairs)</span>
<span class="sd">            onsite_hamiltonian (torch.Tensor): On-site Hamiltonian matrix elements for each atom,</span>
<span class="sd">                with shape (n_atoms, nao_max^2)</span>
<span class="sd">            offsite_hamiltonian (torch.Tensor): Off-site Hamiltonian matrix elements for each edge,</span>
<span class="sd">                with shape (n_edges, nao_max^2)</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Complete molecular Hamiltonian matrix with shape (n_molecules, n_orbitals, n_orbitals),</span>
<span class="sd">                where n_orbitals is the number of valid atomic orbitals per molecule after removing</span>
<span class="sd">                padding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the maximum number of atoms in any crystal in the batch</span>
        <span class="n">max_atoms_per_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create orbital validity mask based on atomic numbers</span>
        <span class="c1"># (determine which orbitals are valid for each atom type)</span>
        <span class="n">atom_orbital_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">basis_definition_mapped</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">)</span>

        <span class="c1"># Convert 1-indexed orbital indices to 0-indexed</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">orbital_indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">zero_indexed_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">orbital_indices</span><span class="p">]</span>  <span class="c1"># Convert to 0-indexed</span>
            <span class="n">basis_definition_mapped</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_indexed_indices</span>
            <span class="n">atom_orbital_mask</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">][</span><span class="n">zero_indexed_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Get the orbital mask for each atom in the batch</span>
        <span class="c1"># First reshape to (n_batch_crystals, max_atoms*nao_max)</span>
        <span class="n">crystal_orbital_mask</span> <span class="o">=</span> <span class="n">atom_orbital_mask</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_atoms_per_crystal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

        <span class="c1"># Create a 2D mask for interactions between all orbitals (outer product)</span>
        <span class="c1"># Shape: (n_batch_crystals, max_atoms*nao_max, max_atoms*nao_max)</span>
        <span class="n">orbital_interaction_mask</span> <span class="o">=</span> <span class="n">crystal_orbital_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">crystal_orbital_mask</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Reshape mask to match the final Hamiltonian format</span>
        <span class="n">orbital_interaction_mask</span> <span class="o">=</span> <span class="n">orbital_interaction_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_atoms_per_crystal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

        <span class="c1"># Initialize the combined Hamiltonian matrix</span>
        <span class="c1"># Shape: (n_atoms, max_atoms_per_crystal, nao_max^2)</span>
        <span class="n">combined_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">[</span><span class="n">n_atoms</span><span class="p">,</span> <span class="n">max_atoms_per_crystal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>

        <span class="c1"># Create atom index tensor for efficient indexing</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># Place on-site Hamiltonian elements</span>
        <span class="c1"># For each atom, place its on-site Hamiltonian at the corresponding position</span>
        <span class="n">combined_hamiltonian</span><span class="p">[</span><span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span> <span class="o">%</span> <span class="n">max_atoms_per_crystal</span><span class="p">]</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span>

        <span class="c1"># Place off-site Hamiltonian elements</span>
        <span class="c1"># For each edge (i,j), place the off-site Hamiltonian from i to j</span>
        <span class="n">source_atoms</span><span class="p">,</span> <span class="n">target_atoms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">combined_hamiltonian</span><span class="p">[</span><span class="n">source_atoms</span><span class="p">,</span> <span class="n">target_atoms</span> <span class="o">%</span> <span class="n">max_atoms_per_crystal</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span>

        <span class="c1"># Reshape and reorder dimensions to get the correct Hamiltonian structure</span>
        <span class="c1"># From (n_atoms, max_atoms, nao_max, nao_max) to (n_atoms*nao_max, max_atoms*nao_max)</span>
        <span class="n">combined_hamiltonian</span> <span class="o">=</span> <span class="n">combined_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">n_atoms</span><span class="p">,</span> <span class="n">max_atoms_per_crystal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
        <span class="p">)</span>
        <span class="n">combined_hamiltonian</span> <span class="o">=</span> <span class="n">combined_hamiltonian</span><span class="o">.</span><span class="n">permute</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">combined_hamiltonian</span> <span class="o">=</span> <span class="n">combined_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">n_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">max_atoms_per_crystal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
        <span class="p">)</span>

        <span class="c1"># Apply mask to remove padded/invalid orbitals</span>
        <span class="n">valid_elements</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">combined_hamiltonian</span><span class="p">,</span> <span class="n">orbital_interaction_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calculate the number of valid orbitals per molecule</span>
        <span class="n">n_molecules</span> <span class="o">=</span> <span class="n">n_atoms</span> <span class="o">/</span> <span class="n">max_atoms_per_crystal</span>
        <span class="n">orbitals_per_molecule</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">valid_elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_molecules</span><span class="p">))</span>

        <span class="c1"># Reshape to final molecular Hamiltonian form</span>
        <span class="n">molecular_hamiltonian</span> <span class="o">=</span> <span class="n">valid_elements</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">orbitals_per_molecule</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">molecular_hamiltonian</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.concatenate_hamiltonians_by_crystal">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.concatenate_hamiltonians_by_crystal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">onsite_hamiltonians</span><span class="p">,</span> <span class="n">offsite_hamiltonians</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate on-site and off-site Hamiltonian matrices for each crystal in a batch.</span>

<span class="sd">        This function organizes Hamiltonian matrices by crystal, interleaving on-site and</span>
<span class="sd">        off-site components in a specific order required for further processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Object containing crystal structure information, including:</span>
<span class="sd">                - node_counts: Number of atoms in each crystal</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - batch: Batch assignment for each node</span>
<span class="sd">            onsite_hamiltonians (torch.Tensor): On-site Hamiltonian matrices for all atoms,</span>
<span class="sd">                with shape (total_atoms, matrix_dimension)</span>
<span class="sd">            offsite_hamiltonians (torch.Tensor): Off-site Hamiltonian matrices for all edges,</span>
<span class="sd">                with shape (total_edges, matrix_dimension)</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Concatenated Hamiltonian matrices organized by crystal,</span>
<span class="sd">                with alternating on-site and off-site blocks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Split on-site Hamiltonians by crystal based on node counts</span>
        <span class="n">atoms_per_crystal</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">onsite_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">onsite_hamiltonians</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Get source and target indices for each edge</span>
        <span class="n">source_nodes</span><span class="p">,</span> <span class="n">target_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>

        <span class="c1"># Count edges per crystal using scatter operation</span>
        <span class="n">edge_counter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">source_nodes</span><span class="p">)</span>
        <span class="n">edges_per_crystal</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_counter</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">source_nodes</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Split off-site Hamiltonians by crystal based on edge counts</span>
        <span class="n">offsite_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">offsite_hamiltonians</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Interleave on-site and off-site Hamiltonians for each crystal</span>
        <span class="n">concatenated_hamiltonians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">crystal_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms_per_crystal</span><span class="p">)):</span>
            <span class="n">concatenated_hamiltonians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">])</span>  <span class="c1"># Add on-site Hamiltonians</span>
            <span class="n">concatenated_hamiltonians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">])</span>  <span class="c1"># Add off-site Hamiltonians</span>

        <span class="c1"># Concatenate all Hamiltonians into a single tensor</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">concatenated_hamiltonians</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_hamiltonian">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_hamiltonian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">is_soc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symmetry_type</span><span class="o">=</span><span class="s1">&#39;hermitian&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply symmetrization to a Hamiltonian matrix.</span>

<span class="sd">        This is a general-purpose function that handles various types of symmetrization for both</span>
<span class="sd">        on-site and off-site Hamiltonians, with or without spin-orbit coupling (SOC).</span>

<span class="sd">        Args:</span>
<span class="sd">            hamiltonian (torch.Tensor): Hamiltonian matrix elements in flattened form.</span>
<span class="sd">            is_soc (bool, optional): Whether this is a spin-orbit coupling Hamiltonian with</span>
<span class="sd">                double dimension. Defaults to False.</span>
<span class="sd">            inverse_edges (torch.Tensor, optional): Indices mapping each edge to its inverse</span>
<span class="sd">                for off-site Hamiltonians. Required for off-site symmetrization. Defaults to None.</span>
<span class="sd">            symmetry_type (str, optional): Type of symmetry to apply:</span>
<span class="sd">                - &#39;hermitian&#39;: Apply Hermitian symmetry H = 0.5*(H + H?)</span>
<span class="sd">                - &#39;anti-hermitian&#39;: Apply anti-Hermitian symmetry H = 0.5*(H - H?)</span>
<span class="sd">                Defaults to &#39;hermitian&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Symmetrized Hamiltonian matrix in the same format as input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Return original matrix if symmetrization is disabled</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
            <span class="c1"># For SOC case, ensure consistent shape even when not symmetrizing</span>
            <span class="k">if</span> <span class="n">is_soc</span><span class="p">:</span>
                <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
                <span class="k">return</span> <span class="n">hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dimension</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hamiltonian</span>

        <span class="c1"># Determine matrix dimension based on whether this is SOC</span>
        <span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="k">if</span> <span class="n">is_soc</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>

        <span class="c1"># Reshape for matrix operations</span>
        <span class="n">matrix_form</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">dimension</span><span class="p">)</span>

        <span class="c1"># Determine symmetrization operation based on type</span>
        <span class="k">if</span> <span class="n">symmetry_type</span> <span class="o">==</span> <span class="s1">&#39;hermitian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inverse_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># On-site case: symmetrize with its own transpose</span>
                <span class="n">symmetrized</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">matrix_form</span> <span class="o">+</span> <span class="n">matrix_form</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Off-site case: symmetrize with transpose of inverse edges</span>
                <span class="n">symmetrized</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">matrix_form</span> <span class="o">+</span> <span class="n">matrix_form</span><span class="p">[</span><span class="n">inverse_edges</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">symmetry_type</span> <span class="o">==</span> <span class="s1">&#39;anti-hermitian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inverse_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># On-site case: anti-symmetrize with its own transpose</span>
                <span class="n">symmetrized</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">matrix_form</span> <span class="o">-</span> <span class="n">matrix_form</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Off-site case: anti-symmetrize with transpose of inverse edges</span>
                <span class="n">symmetrized</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">matrix_form</span> <span class="o">-</span> <span class="n">matrix_form</span><span class="p">[</span><span class="n">inverse_edges</span><span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown symmetry type: </span><span class="si">{</span><span class="n">symmetry_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Reshape back to original format</span>
        <span class="k">return</span> <span class="n">symmetrized</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dimension</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_onsite_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symmetrize on-site Hamiltonian matrices.</span>

<span class="sd">        Applies Hermitian or anti-Hermitian symmetrization to on-site Hamiltonians.</span>

<span class="sd">        Args:</span>
<span class="sd">            hamiltonian (torch.Tensor): On-site Hamiltonian matrix elements.</span>
<span class="sd">            hermitian (bool, optional): If True, apply Hermitian symmetry (H + H?),</span>
<span class="sd">                otherwise apply anti-Hermitian symmetry (H - H?). Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Symmetrized Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry_type</span> <span class="o">=</span> <span class="s1">&#39;hermitian&#39;</span> <span class="k">if</span> <span class="n">hermitian</span> <span class="k">else</span> <span class="s1">&#39;anti-hermitian&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_hamiltonian</span><span class="p">(</span>
            <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">is_soc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symmetry_type</span><span class="o">=</span><span class="n">symmetry_type</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_offsite_hamiltonian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symmetrize off-site Hamiltonian matrices.</span>

<span class="sd">        Applies Hermitian or anti-Hermitian symmetrization to off-site Hamiltonians,</span>
<span class="sd">        using the inverse edge mapping to relate connected atom pairs.</span>

<span class="sd">        Args:</span>
<span class="sd">            hamiltonian (torch.Tensor): Off-site Hamiltonian matrix elements.</span>
<span class="sd">            inverse_edges (torch.Tensor): Tensor mapping each edge to its inverse edge index.</span>
<span class="sd">            hermitian (bool, optional): If True, apply Hermitian symmetry (H + H?),</span>
<span class="sd">                otherwise apply anti-Hermitian symmetry (H - H?). Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Symmetrized Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry_type</span> <span class="o">=</span> <span class="s1">&#39;hermitian&#39;</span> <span class="k">if</span> <span class="n">hermitian</span> <span class="k">else</span> <span class="s1">&#39;anti-hermitian&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_hamiltonian</span><span class="p">(</span>
            <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">is_soc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="o">=</span><span class="n">inverse_edges</span><span class="p">,</span> <span class="n">symmetry_type</span><span class="o">=</span><span class="n">symmetry_type</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian_soc">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_onsite_hamiltonian_soc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_onsite_hamiltonian_soc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symmetrize on-site Hamiltonian matrices with spin-orbit coupling.</span>

<span class="sd">        Applies Hermitian or anti-Hermitian symmetrization to on-site Hamiltonians</span>
<span class="sd">        that include spin-orbit coupling, which have double the dimension.</span>

<span class="sd">        Args:</span>
<span class="sd">            hamiltonian (torch.Tensor): On-site SOC Hamiltonian matrix elements.</span>
<span class="sd">            hermitian (bool, optional): If True, apply Hermitian symmetry (H + H?),</span>
<span class="sd">                otherwise apply anti-Hermitian symmetry (H - H?). Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Symmetrized SOC Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry_type</span> <span class="o">=</span> <span class="s1">&#39;hermitian&#39;</span> <span class="k">if</span> <span class="n">hermitian</span> <span class="k">else</span> <span class="s1">&#39;anti-hermitian&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_hamiltonian</span><span class="p">(</span>
            <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">is_soc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symmetry_type</span><span class="o">=</span><span class="n">symmetry_type</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian_soc">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_offsite_hamiltonian_soc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_offsite_hamiltonian_soc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symmetrize off-site Hamiltonian matrices with spin-orbit coupling.</span>

<span class="sd">        Applies Hermitian or anti-Hermitian symmetrization to off-site Hamiltonians</span>
<span class="sd">        that include spin-orbit coupling, which have double the dimension.</span>

<span class="sd">        Args:</span>
<span class="sd">            hamiltonian (torch.Tensor): Off-site SOC Hamiltonian matrix elements.</span>
<span class="sd">            inverse_edges (torch.Tensor): Tensor mapping each edge to its inverse edge index.</span>
<span class="sd">            hermitian (bool, optional): If True, apply Hermitian symmetry (H + H?),</span>
<span class="sd">                otherwise apply anti-Hermitian symmetry (H - H?). Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Symmetrized SOC Hamiltonian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symmetry_type</span> <span class="o">=</span> <span class="s1">&#39;hermitian&#39;</span> <span class="k">if</span> <span class="n">hermitian</span> <span class="k">else</span> <span class="s1">&#39;anti-hermitian&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_hamiltonian</span><span class="p">(</span>
            <span class="n">hamiltonian</span><span class="p">,</span> <span class="n">is_soc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inverse_edges</span><span class="o">=</span><span class="n">inverse_edges</span><span class="p">,</span> <span class="n">symmetry_type</span><span class="o">=</span><span class="n">symmetry_type</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.calculate_band_energies_with_overlap">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_band_energies_with_overlap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_band_energies_with_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> 
                                             <span class="n">onsite_overlap</span><span class="p">,</span> <span class="n">offsite_overlap</span><span class="p">,</span> <span class="n">crystal_data</span><span class="p">,</span> 
                                             <span class="n">export_reciprocal_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate electronic band structure using provided Hamiltonian and overlap matrices.</span>

<span class="sd">        This function computes electronic band energies, wavefunctions, and band gaps for a set </span>
<span class="sd">        of crystal structures using the generalized eigenvalue problem H = ES. This version</span>
<span class="sd">        allows debugging by accepting both reference and predicted overlap matrices.</span>

<span class="sd">        Args:</span>
<span class="sd">            onsite_hamiltonian (torch.Tensor): On-site Hamiltonian matrix elements with shape </span>
<span class="sd">                (total_atoms, nao_max2).</span>
<span class="sd">            offsite_hamiltonian (torch.Tensor): Off-site Hamiltonian matrix elements with shape </span>
<span class="sd">                (total_edges, nao_max2).</span>
<span class="sd">            onsite_overlap (torch.Tensor): Predicted on-site overlap matrix elements with shape </span>
<span class="sd">                (total_atoms, nao_max2).</span>
<span class="sd">            offsite_overlap (torch.Tensor): Predicted off-site overlap matrix elements with shape </span>
<span class="sd">                (total_edges, nao_max2).</span>
<span class="sd">            crystal_data (DataObject): Object containing crystal structure information including:</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - cell: Unit cell vectors</span>
<span class="sd">                - z: Atomic numbers</span>
<span class="sd">                - node_counts: Number of atoms in each crystal</span>
<span class="sd">                - batch: Batch assignment for each atom</span>
<span class="sd">                - k_vecs: k-points for band structure calculation</span>
<span class="sd">                - nbr_shift: Neighbor cell shifts for periodic boundary conditions</span>
<span class="sd">                - Son/Soff: Reference overlap matrices</span>
<span class="sd">            export_reciprocal_values (bool, optional): Whether to export additional reciprocal </span>
<span class="sd">                space matrices (H(k), S(k), dS(k)). Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Contains band energies, wavefunctions, and optionally additional reciprocal space </span>
<span class="sd">                   matrices depending on the export_reciprocal_values parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">cell</span>  <span class="c1"># shape: (batch_size, 3, 3)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">lattice_vectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create orbital validity mask based on atomic numbers</span>
        <span class="n">atomic_orbital_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">orbital_indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">][</span><span class="n">orbital_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Get orbital mask for each atom</span>
        <span class="n">orbital_mask</span> <span class="o">=</span> <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms, nao_max]</span>
        <span class="n">orbital_mask_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orbital_mask</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Create interaction masks for each crystal</span>
        <span class="n">orbital_interaction_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Create outer product of orbital masks for interaction masking</span>
            <span class="n">orbital_interaction_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orbital_mask_by_crystal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> 
                <span class="n">orbital_mask_by_crystal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set the number of valence electrons per atom type</span>
        <span class="n">valence_electron_counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">valence_electron_counts</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c1"># Get valence electron count for each atom and then for each crystal</span>
        <span class="n">atom_valence_counts</span> <span class="o">=</span> <span class="n">valence_electron_counts</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms]</span>
        <span class="n">crystal_valence_counts</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">atom_valence_counts</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: [batch_size]</span>

        <span class="c1"># Initialize band window sizes if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bands_per_atom_type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">band_count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">bands_per_atom_type</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_count</span>
            <span class="n">atom_band_counts</span> <span class="o">=</span> <span class="n">bands_per_atom_type</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms]</span>
            <span class="n">crystal_band_counts</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">atom_band_counts</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: [batch_size]</span>

        <span class="c1"># Split data by crystal</span>
        <span class="n">atoms_per_crystal</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">atom_index_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">atoms_per_crystal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">atoms_per_crystal</span>

        <span class="c1"># Split Hamiltonians and overlaps by crystal</span>
        <span class="n">onsite_hamiltonians_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">reference_onsite_overlaps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Son</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">predicted_onsite_overlaps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">onsite_overlap</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Count edges per crystal and split edge data</span>
        <span class="n">edge_counter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>
        <span class="n">edges_per_crystal</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_counter</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">source_indices</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">edge_index_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">edges_per_crystal</span>

        <span class="n">offsite_hamiltonians_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">reference_offsite_overlaps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Soff</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">predicted_offsite_overlaps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">offsite_overlap</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Prepare derivatives if exporting reciprocal values</span>
        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="n">onsite_overlap_derivatives</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">dSon</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">offsite_overlap_derivatives</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">dSoff</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Initialize results containers</span>
        <span class="n">band_energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wavefunctions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reciprocal_hamiltonians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">symmetrized_hamiltonians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reciprocal_overlaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reciprocal_overlap_derivatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">band_gaps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each crystal</span>
        <span class="k">for</span> <span class="n">crystal_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">k_points</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">k_vecs</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
            <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">atoms_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>

            <span class="c1"># Calculate phase factors for k-points</span>
            <span class="c1"># Shape: (edges_in_crystal, num_k_points)</span>
            <span class="n">phase_factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">crystal_data</span><span class="o">.</span><span class="n">nbr_shift</span><span class="p">[</span>
                        <span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> 
                        <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">),</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="p">:</span>
                    <span class="p">]</span> <span class="o">*</span> <span class="n">k_points</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Initialize k-space Hamiltonian and overlap matrices</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">reference_overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">predicted_overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Add on-site terms to k-space matrices</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>

            <span class="c1"># Add on-site Hamiltonian and overlap terms</span>
            <span class="n">hamiltonian_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_hamiltonians_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">)</span>

            <span class="n">reference_overlap_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">reference_onsite_overlaps</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">reference_overlap_k</span><span class="p">)</span>

            <span class="n">predicted_overlap_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">predicted_onsite_overlaps</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">predicted_overlap_k</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">overlap_derivatives_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_overlap_derivatives</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span>
                <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">)</span>

            <span class="c1"># Add off-site terms to k-space matrices</span>
            <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]):</span>
                <span class="c1"># Get local indices within this crystal</span>
                <span class="n">source_atom_idx</span> <span class="o">=</span> <span class="n">source_indices</span><span class="p">[</span><span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
                <span class="n">target_atom_idx</span> <span class="o">=</span> <span class="n">target_indices</span><span class="p">[</span><span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>

                <span class="c1"># Add contribution for each k-point with phase factor</span>
                <span class="n">hamiltonian_k</span><span class="p">[:,</span> <span class="n">source_atom_idx</span><span class="p">,</span> <span class="n">target_atom_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">phase_factors</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> 
                    <span class="n">offsite_hamiltonians_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="p">)</span>

                <span class="n">reference_overlap_k</span><span class="p">[:,</span> <span class="n">source_atom_idx</span><span class="p">,</span> <span class="n">target_atom_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">phase_factors</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> 
                    <span class="n">reference_offsite_overlaps</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="p">)</span>

                <span class="n">predicted_overlap_k</span><span class="p">[:,</span> <span class="n">source_atom_idx</span><span class="p">,</span> <span class="n">target_atom_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">phase_factors</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> 
                    <span class="n">predicted_offsite_overlaps</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="p">)</span>

            <span class="c1"># Add derivative terms if needed</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]):</span>
                    <span class="n">source_atom_idx</span> <span class="o">=</span> <span class="n">source_indices</span><span class="p">[</span><span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
                    <span class="n">target_atom_idx</span> <span class="o">=</span> <span class="n">target_indices</span><span class="p">[</span><span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>

                    <span class="n">overlap_derivatives_k</span><span class="p">[:,</span> <span class="n">source_atom_idx</span><span class="p">,</span> <span class="n">target_atom_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">phase_factors</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> 
                        <span class="n">offsite_overlap_derivatives</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
                    <span class="p">)</span>

            <span class="c1"># Reshape matrices to combine atom and orbital dimensions</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Swap atom and orbital indices</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">hamiltonian_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="n">reference_overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">reference_overlap_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">reference_overlap_k</span> <span class="o">=</span> <span class="n">reference_overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="n">predicted_overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">predicted_overlap_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">predicted_overlap_k</span> <span class="o">=</span> <span class="n">predicted_overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">overlap_derivatives_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Apply orbital mask to select only valid orbitals</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">orbital_interaction_masks</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">num_orbitals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">hamiltonian_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

            <span class="n">reference_overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">reference_overlap_k</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">reference_overlap_k</span> <span class="o">=</span> <span class="n">reference_overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

            <span class="n">predicted_overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">predicted_overlap_k</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">predicted_overlap_k</span> <span class="o">=</span> <span class="n">predicted_overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">derivative_mask</span> <span class="o">=</span> <span class="n">orbital_interaction_masks</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">,</span> <span class="n">derivative_mask</span><span class="p">)</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">overlap_derivatives_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Solve generalized eigenvalue problem using Cholesky decomposition</span>
            <span class="n">cholesky_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">reference_overlap_k</span><span class="p">)</span>
            <span class="n">cholesky_factor_conj_transpose</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cholesky_factor</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cholesky_inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky_factor</span><span class="p">)</span>
            <span class="n">cholesky_conj_transpose_inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky_factor_conj_transpose</span><span class="p">)</span>

            <span class="c1"># Transform to standard eigenvalue problem</span>
            <span class="n">transformed_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">cholesky_inverse</span><span class="p">,</span> <span class="n">hamiltonian_k</span><span class="p">),</span>
                <span class="n">cholesky_conj_transpose_inverse</span>
            <span class="p">)</span>

            <span class="c1"># Solve eigenvalue problem</span>
            <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">transformed_hamiltonian</span><span class="p">)</span>

            <span class="c1"># Transform eigenvectors back to original basis</span>
            <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,ika-&gt;iaj&#39;</span><span class="p">,</span> <span class="n">cholesky_conj_transpose_inverse</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">)</span>

            <span class="c1"># Normalize wavefunctions if exporting reciprocal values</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="c1"># Calculate normalization factors</span>
                <span class="n">normalization_factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
                    <span class="s1">&#39;nai,nij,naj-&gt;na&#39;</span><span class="p">,</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">),</span>
                    <span class="n">reference_overlap_k</span><span class="p">,</span>
                    <span class="n">eigenvectors</span>
                <span class="p">)</span><span class="o">.</span><span class="n">real</span>

                <span class="c1"># Apply normalization</span>
                <span class="n">normalization_factors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normalization_factors</span><span class="p">)</span>
                <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span> <span class="o">*</span> <span class="n">normalization_factors</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Store reciprocal space matrices</span>
                <span class="n">reciprocal_hamiltonians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">)</span>
                <span class="n">reciprocal_overlaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_overlap_k</span><span class="p">)</span>
                <span class="n">reciprocal_overlap_derivatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">)</span>

            <span class="c1"># Apply band number control if specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[:,</span> <span class="p">:</span><span class="n">crystal_band_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]]</span>
                <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="p">:</span><span class="n">crystal_band_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="p">:]</span>

            <span class="c1"># Store results</span>
            <span class="n">band_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">wavefunctions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">)</span>
            <span class="n">symmetrized_hamiltonians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transformed_hamiltonian</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># Calculate band gap</span>
            <span class="n">half_filled_band_index</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crystal_valence_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">band_gap</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[:,</span> <span class="n">half_filled_band_index</span><span class="p">])</span> <span class="o">-</span> 
                <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[:,</span> <span class="n">half_filled_band_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">band_gaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_gap</span><span class="p">)</span>

        <span class="c1"># Combine results across all crystals</span>
        <span class="n">band_energies</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_energies</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">band_gaps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_gaps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="c1"># Return reciprocal space matrices</span>
            <span class="n">wavefunctions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">wavefunctions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">hamiltonians_k_space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">reciprocal_hamiltonians</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">overlaps_k_space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">reciprocal_overlaps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">overlap_derivatives_k_space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">reciprocal_overlap_derivatives</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">band_energies</span><span class="p">,</span> <span class="n">wavefunctions</span><span class="p">,</span> <span class="n">hamiltonians_k_space</span><span class="p">,</span> <span class="n">overlaps_k_space</span><span class="p">,</span> <span class="n">overlap_derivatives_k_space</span><span class="p">,</span> <span class="n">band_gaps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Flatten wavefunctions and return</span>
            <span class="n">wavefunctions</span> <span class="o">=</span> <span class="p">[</span><span class="n">wf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">wf</span> <span class="ow">in</span> <span class="n">wavefunctions</span><span class="p">]</span>
            <span class="n">wavefunctions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">wavefunctions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">symmetrized_hamiltonians</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">symmetrized_hamiltonians</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">band_energies</span><span class="p">,</span> <span class="n">wavefunctions</span><span class="p">,</span> <span class="n">band_gaps</span><span class="p">,</span> <span class="n">symmetrized_hamiltonians</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.calculate_band_energies">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_band_energies">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_band_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">crystal_data</span><span class="p">,</span> 
                                <span class="n">export_reciprocal_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate electronic band structure using Hamiltonian matrices and reference overlap matrices.</span>

<span class="sd">        This function computes electronic band energies, wavefunctions, and band gaps for a set </span>
<span class="sd">        of crystal structures by solving the generalized eigenvalue problem H = ES.</span>

<span class="sd">        Args:</span>
<span class="sd">            onsite_hamiltonian (torch.Tensor): On-site Hamiltonian matrix elements with shape </span>
<span class="sd">                (total_atoms, nao_max2).</span>
<span class="sd">            offsite_hamiltonian (torch.Tensor): Off-site Hamiltonian matrix elements with shape </span>
<span class="sd">                (total_edges, nao_max2).</span>
<span class="sd">            crystal_data (DataObject): Object containing crystal structure information including:</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - cell: Unit cell vectors</span>
<span class="sd">                - z: Atomic numbers</span>
<span class="sd">                - node_counts: Number of atoms in each crystal</span>
<span class="sd">                - batch: Batch assignment for each atom</span>
<span class="sd">                - k_vecs: k-points for band structure calculation</span>
<span class="sd">                - nbr_shift: Neighbor cell shifts for periodic boundary conditions</span>
<span class="sd">                - Son/Soff: Reference overlap matrices</span>
<span class="sd">            export_reciprocal_values (bool, optional): Whether to export additional reciprocal </span>
<span class="sd">                space matrices (H(k), S(k), dS(k)). Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Contains band energies, wavefunctions, band gaps, and optionally additional </span>
<span class="sd">                   reciprocal space matrices depending on the export_reciprocal_values parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">cell</span>  <span class="c1"># shape: (batch_size, 3, 3)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">lattice_vectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create orbital validity mask based on atomic numbers</span>
        <span class="n">atomic_orbital_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">orbital_indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">][</span><span class="n">orbital_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Get orbital mask for each atom</span>
        <span class="n">orbital_mask</span> <span class="o">=</span> <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms, nao_max]</span>
        <span class="n">orbital_mask_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orbital_mask</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Create interaction masks for each crystal</span>
        <span class="n">orbital_interaction_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Create outer product of orbital masks for interaction masking</span>
            <span class="n">orbital_interaction_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orbital_mask_by_crystal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> 
                <span class="n">orbital_mask_by_crystal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set the number of valence electrons per atom type</span>
        <span class="n">valence_electron_counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">valence_electron_counts</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c1"># Get valence electron count for each atom and then for each crystal</span>
        <span class="n">atom_valence_counts</span> <span class="o">=</span> <span class="n">valence_electron_counts</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms]</span>
        <span class="n">crystal_valence_counts</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">atom_valence_counts</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: [batch_size]</span>

        <span class="c1"># Initialize band window sizes if needed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">bands_per_atom_type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">band_count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">bands_per_atom_type</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_count</span>
            <span class="n">atom_band_counts</span> <span class="o">=</span> <span class="n">bands_per_atom_type</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms]</span>
            <span class="n">crystal_band_counts</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">atom_band_counts</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: [batch_size]</span>

        <span class="c1"># Split data by crystal</span>
        <span class="n">atoms_per_crystal</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">node_counts</span>
        <span class="n">atom_index_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">atoms_per_crystal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">atoms_per_crystal</span>

        <span class="c1"># Split Hamiltonians and overlaps by crystal</span>
        <span class="n">onsite_hamiltonians_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">onsite_overlaps_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Son</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Count edges per crystal and split edge data</span>
        <span class="n">edge_counter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>
        <span class="n">edges_per_crystal</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_counter</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">source_indices</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">edge_index_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">edges_per_crystal</span>

        <span class="n">offsite_hamiltonians_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">offsite_overlaps_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Soff</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Prepare derivatives if exporting reciprocal values</span>
        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="n">onsite_overlap_derivatives</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">dSon</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">offsite_overlap_derivatives</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">dSoff</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Initialize results containers</span>
        <span class="n">band_energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wavefunctions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reciprocal_hamiltonians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">symmetrized_hamiltonians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reciprocal_overlaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reciprocal_overlap_derivatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">band_gaps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each crystal</span>
        <span class="k">for</span> <span class="n">crystal_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">k_points</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">k_vecs</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
            <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">atoms_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>

            <span class="c1"># Calculate phase factors for k-points</span>
            <span class="c1"># Shape: (edges_in_crystal, num_k_points)</span>
            <span class="n">phase_factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">crystal_data</span><span class="o">.</span><span class="n">nbr_shift</span><span class="p">[</span>
                        <span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> 
                        <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">),</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="p">:</span>
                    <span class="p">]</span> <span class="o">*</span> <span class="n">k_points</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Initialize k-space Hamiltonian and overlap matrices</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Add on-site terms to k-space matrices</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>

            <span class="c1"># Add on-site Hamiltonian and overlap terms</span>
            <span class="n">hamiltonian_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_hamiltonians_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">)</span>

            <span class="n">overlap_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_overlaps_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">overlap_k</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">overlap_derivatives_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_overlap_derivatives</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span>
                <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">)</span>

            <span class="c1"># Prepare edge data for vectorized operations</span>
            <span class="n">edge_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">source_indices</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">source_atom_indices</span> <span class="o">=</span> <span class="n">source_indices</span><span class="p">[</span><span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_indices</span><span class="p">]</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
            <span class="n">target_atom_indices</span> <span class="o">=</span> <span class="n">target_indices</span><span class="p">[</span><span class="n">edge_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_indices</span><span class="p">]</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>

            <span class="c1"># Reshape matrices for more efficient operations</span>
            <span class="n">offsite_h_reshaped</span> <span class="o">=</span> <span class="n">offsite_hamiltonians_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)</span>
            <span class="n">offsite_s_reshaped</span> <span class="o">=</span> <span class="n">offsite_overlaps_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span>
            <span class="p">)</span>

            <span class="c1"># Add off-site terms to k-space matrices for each k-point</span>
            <span class="k">for</span> <span class="n">k_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">):</span>
                <span class="c1"># Pre-calculate phase factors for this k-point</span>
                <span class="n">k_phase_factors</span> <span class="o">=</span> <span class="n">phase_factors</span><span class="p">[:</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="n">k_idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Calculate contribution to Hamiltonian</span>
                <span class="n">h_contributions</span> <span class="o">=</span> <span class="n">k_phase_factors</span> <span class="o">*</span> <span class="n">offsite_h_reshaped</span>
                <span class="n">s_contributions</span> <span class="o">=</span> <span class="n">k_phase_factors</span> <span class="o">*</span> <span class="n">offsite_s_reshaped</span>

                <span class="c1"># Add contributions to k-space matrices using index_put</span>
                <span class="n">hamiltonian_k</span><span class="p">[</span><span class="n">k_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_put</span><span class="p">(</span>
                    <span class="n">hamiltonian_k</span><span class="p">[</span><span class="n">k_idx</span><span class="p">],</span> 
                    <span class="p">(</span><span class="n">source_atom_indices</span><span class="p">,</span> <span class="n">target_atom_indices</span><span class="p">),</span> 
                    <span class="n">h_contributions</span><span class="p">,</span> 
                    <span class="n">accumulate</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="n">overlap_k</span><span class="p">[</span><span class="n">k_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_put</span><span class="p">(</span>
                    <span class="n">overlap_k</span><span class="p">[</span><span class="n">k_idx</span><span class="p">],</span> 
                    <span class="p">(</span><span class="n">source_atom_indices</span><span class="p">,</span> <span class="n">target_atom_indices</span><span class="p">),</span> 
                    <span class="n">s_contributions</span><span class="p">,</span> 
                    <span class="n">accumulate</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="c1"># Add derivative terms if needed</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">offsite_ds_reshaped</span> <span class="o">=</span> <span class="n">offsite_overlap_derivatives</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">k_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">):</span>
                    <span class="c1"># Pre-calculate phase factors for this k-point</span>
                    <span class="n">k_phase_factors</span> <span class="o">=</span> <span class="n">phase_factors</span><span class="p">[:</span><span class="n">edges_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="n">k_idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># Calculate contribution to derivatives</span>
                    <span class="n">ds_contributions</span> <span class="o">=</span> <span class="n">k_phase_factors</span> <span class="o">*</span> <span class="n">offsite_ds_reshaped</span>

                    <span class="c1"># Add contributions to k-space matrices using index_put</span>
                    <span class="n">overlap_derivatives_k</span><span class="p">[</span><span class="n">k_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_put</span><span class="p">(</span>
                        <span class="n">overlap_derivatives_k</span><span class="p">[</span><span class="n">k_idx</span><span class="p">],</span> 
                        <span class="p">(</span><span class="n">source_atom_indices</span><span class="p">,</span> <span class="n">target_atom_indices</span><span class="p">),</span> 
                        <span class="n">ds_contributions</span><span class="p">,</span> 
                        <span class="n">accumulate</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

            <span class="c1"># Reshape matrices to combine atom and orbital dimensions</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Swap atom and orbital indices</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">hamiltonian_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">overlap_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">overlap_derivatives_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Apply orbital mask to select only valid orbitals</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">orbital_interaction_masks</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">num_orbitals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">hamiltonian_k</span> <span class="o">=</span> <span class="n">hamiltonian_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">overlap_k</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="n">derivative_mask</span> <span class="o">=</span> <span class="n">orbital_interaction_masks</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">,</span> <span class="n">derivative_mask</span><span class="p">)</span>
                <span class="n">overlap_derivatives_k</span> <span class="o">=</span> <span class="n">overlap_derivatives_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># Solve generalized eigenvalue problem using Cholesky decomposition</span>
            <span class="n">cholesky_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">overlap_k</span><span class="p">)</span>
            <span class="n">cholesky_factor_conj_transpose</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cholesky_factor</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cholesky_inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky_factor</span><span class="p">)</span>
            <span class="n">cholesky_conj_transpose_inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky_factor_conj_transpose</span><span class="p">)</span>

            <span class="c1"># Transform to standard eigenvalue problem</span>
            <span class="n">transformed_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">cholesky_inverse</span><span class="p">,</span> <span class="n">hamiltonian_k</span><span class="p">),</span>
                <span class="n">cholesky_conj_transpose_inverse</span>
            <span class="p">)</span>

            <span class="c1"># Solve eigenvalue problem</span>
            <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">transformed_hamiltonian</span><span class="p">)</span>

            <span class="c1"># Transform eigenvectors back to original basis</span>
            <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,ika-&gt;iaj&#39;</span><span class="p">,</span> <span class="n">cholesky_conj_transpose_inverse</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">)</span>

            <span class="c1"># Calculate band gap</span>
            <span class="n">half_filled_band_index</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">crystal_valence_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">band_gap</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[:,</span> <span class="n">half_filled_band_index</span><span class="p">])</span> <span class="o">-</span> 
                <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[:,</span> <span class="n">half_filled_band_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">band_gaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_gap</span><span class="p">)</span>

            <span class="c1"># Apply band number control if specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># Use pre-calculated band counts</span>
                    <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[:,</span> <span class="p">:</span><span class="n">crystal_band_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]]</span>
                    <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="p">:</span><span class="n">crystal_band_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Calculate band window dynamically</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">band_window</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="o">*</span> <span class="n">half_filled_band_index</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">band_window</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="n">half_filled_band_index</span><span class="p">)</span>

                    <span class="c1"># Select band window centered around half-filled band</span>
                    <span class="n">start_band</span> <span class="o">=</span> <span class="n">half_filled_band_index</span> <span class="o">-</span> <span class="n">band_window</span>
                    <span class="n">end_band</span> <span class="o">=</span> <span class="n">half_filled_band_index</span> <span class="o">+</span> <span class="n">band_window</span>
                    <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[:,</span> <span class="n">start_band</span><span class="p">:</span><span class="n">end_band</span><span class="p">]</span>
                    <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">start_band</span><span class="p">:</span><span class="n">end_band</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># Normalize wavefunctions if exporting reciprocal values</span>
            <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
                <span class="c1"># Calculate normalization factors</span>
                <span class="n">normalization_factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
                    <span class="s1">&#39;nai,nij,naj-&gt;na&#39;</span><span class="p">,</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">),</span>
                    <span class="n">overlap_k</span><span class="p">,</span>
                    <span class="n">eigenvectors</span>
                <span class="p">)</span><span class="o">.</span><span class="n">real</span>

                <span class="c1"># Apply normalization</span>
                <span class="n">normalization_factors</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normalization_factors</span><span class="p">)</span>
                <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span> <span class="o">*</span> <span class="n">normalization_factors</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Store reciprocal space matrices</span>
                <span class="n">reciprocal_hamiltonians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hamiltonian_k</span><span class="p">)</span>
                <span class="n">reciprocal_overlaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap_k</span><span class="p">)</span>
                <span class="n">reciprocal_overlap_derivatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlap_derivatives_k</span><span class="p">)</span>

            <span class="c1"># Store results</span>
            <span class="n">band_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">wavefunctions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">)</span>
            <span class="n">symmetrized_hamiltonians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transformed_hamiltonian</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Combine results across all crystals</span>
        <span class="n">band_energies</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_energies</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">band_gaps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_gaps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_reciprocal_values</span><span class="p">:</span>
            <span class="c1"># Return reciprocal space matrices</span>
            <span class="n">wavefunctions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">wavefunctions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">hamiltonians_k_space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">reciprocal_hamiltonians</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">overlaps_k_space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">reciprocal_overlaps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">overlap_derivatives_k_space</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">reciprocal_overlap_derivatives</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">band_energies</span><span class="p">,</span> <span class="n">wavefunctions</span><span class="p">,</span> <span class="n">hamiltonians_k_space</span><span class="p">,</span> <span class="n">overlaps_k_space</span><span class="p">,</span> <span class="n">overlap_derivatives_k_space</span><span class="p">,</span> <span class="n">band_gaps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Flatten wavefunctions and return</span>
            <span class="n">wavefunctions</span> <span class="o">=</span> <span class="p">[</span><span class="n">wf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">wf</span> <span class="ow">in</span> <span class="n">wavefunctions</span><span class="p">]</span>
            <span class="n">wavefunctions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">wavefunctions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">symmetrized_hamiltonians</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">symmetrized_hamiltonians</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">band_energies</span><span class="p">,</span> <span class="n">wavefunctions</span><span class="p">,</span> <span class="n">band_gaps</span><span class="p">,</span> <span class="n">symmetrized_hamiltonians</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.calculate_band_energies_with_spin_orbit_coupling">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_band_energies_with_spin_orbit_coupling">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_band_energies_with_spin_orbit_coupling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_onsite</span><span class="p">,</span> <span class="n">imag_onsite</span><span class="p">,</span> <span class="n">real_offsite</span><span class="p">,</span> <span class="n">imag_offsite</span><span class="p">,</span> <span class="n">crystal_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate electronic band structure with spin-orbit coupling (SOC).</span>

<span class="sd">        This function computes electronic band energies and wavefunctions for systems with </span>
<span class="sd">        spin-orbit coupling, which requires handling complex Hamiltonian matrices and doubling </span>
<span class="sd">        the matrix dimensions to account for spin.</span>

<span class="sd">        Args:</span>
<span class="sd">            real_onsite (torch.Tensor): Real part of on-site SOC Hamiltonian with shape </span>
<span class="sd">                (total_atoms, 2*nao_max, 2*nao_max).</span>
<span class="sd">            imag_onsite (torch.Tensor): Imaginary part of on-site SOC Hamiltonian with shape </span>
<span class="sd">                (total_atoms, 2*nao_max, 2*nao_max).</span>
<span class="sd">            real_offsite (torch.Tensor): Real part of off-site SOC Hamiltonian with shape </span>
<span class="sd">                (total_edges, 2*nao_max, 2*nao_max).</span>
<span class="sd">            imag_offsite (torch.Tensor): Imaginary part of off-site SOC Hamiltonian with shape </span>
<span class="sd">                (total_edges, 2*nao_max, 2*nao_max).</span>
<span class="sd">            crystal_data (DataObject): Object containing crystal structure information including:</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - cell: Unit cell vectors</span>
<span class="sd">                - z: Atomic numbers</span>
<span class="sd">                - node_counts: Number of atoms in each crystal</span>
<span class="sd">                - batch: Batch assignment for each atom</span>
<span class="sd">                - k_vecs: k-points for band structure calculation</span>
<span class="sd">                - cell_shift: Cell shift vectors for periodic images</span>
<span class="sd">                - nbr_shift: Neighbor cell shifts for periodic boundary conditions</span>
<span class="sd">                - Son/Soff: Reference overlap matrices (without SOC)</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (</span>
<span class="sd">                band_energies (torch.Tensor): Band energies with shape (total_bands, num_k_points),</span>
<span class="sd">                wavefunctions (torch.Tensor): Flattened wavefunctions</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">cell</span>  <span class="c1"># shape: (batch_size, 3, 3)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">lattice_vectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Reshape Hamiltonian components to matrix form</span>
        <span class="n">real_onsite</span> <span class="o">=</span> <span class="n">real_onsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
        <span class="n">imag_onsite</span> <span class="o">=</span> <span class="n">imag_onsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
        <span class="n">real_offsite</span> <span class="o">=</span> <span class="n">real_offsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
        <span class="n">imag_offsite</span> <span class="o">=</span> <span class="n">imag_offsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

        <span class="c1"># Create orbital validity mask based on atomic numbers</span>
        <span class="n">atomic_orbital_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">orbital_indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">][</span><span class="n">orbital_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Get orbital mask for each atom</span>
        <span class="n">orbital_mask</span> <span class="o">=</span> <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms, nao_max]</span>
        <span class="n">orbital_mask_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orbital_mask</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Create interaction masks for each crystal</span>
        <span class="n">orbital_interaction_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Create outer product of orbital masks for interaction masking</span>
            <span class="n">orbital_interaction_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">orbital_mask_by_crystal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> 
                <span class="n">orbital_mask_by_crystal</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set the number of valence electrons per atom type</span>
        <span class="n">valence_electron_counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_valence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">valence_electron_counts</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c1"># Get valence electron count for each atom and then for each crystal</span>
        <span class="n">atom_valence_counts</span> <span class="o">=</span> <span class="n">valence_electron_counts</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms]</span>
        <span class="n">crystal_valence_counts</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">atom_valence_counts</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: [batch_size]</span>

        <span class="c1"># Initialize band window sizes if needed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">bands_per_atom_type</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">band_count</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">bands_per_atom_type</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_count</span>
            <span class="n">atom_band_counts</span> <span class="o">=</span> <span class="n">bands_per_atom_type</span><span class="p">[</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>  <span class="c1"># shape: [total_atoms]</span>
            <span class="n">crystal_band_counts</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">atom_band_counts</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: [batch_size]</span>

        <span class="c1"># Split data by crystal</span>
        <span class="n">atoms_per_crystal</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">node_counts</span>

        <span class="c1"># Split Hamiltonians by crystal</span>
        <span class="n">real_onsite_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">real_onsite</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imag_onsite_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">imag_onsite</span><span class="p">,</span> <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">onsite_overlaps_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="n">crystal_data</span><span class="o">.</span><span class="n">Son</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> 
            <span class="n">atoms_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Count edges per crystal and split edge data</span>
        <span class="n">edge_counter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>
        <span class="n">edges_per_crystal</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_counter</span><span class="p">,</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">source_indices</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">real_offsite_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">real_offsite</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imag_offsite_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">imag_offsite</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">offsite_overlaps_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
            <span class="n">crystal_data</span><span class="o">.</span><span class="n">Soff</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> 
            <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Split cell shifts and neighbor shifts by crystal</span>
        <span class="n">cell_shifts_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">cell_shift</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">nbr_shifts_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">nbr_shift</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Split edge indices by crystal and convert to local indices</span>
        <span class="n">edge_indices_by_crystal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">edges_per_crystal</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">atom_index_offsets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">atoms_per_crystal</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">atoms_per_crystal</span>

        <span class="c1"># Convert global edge indices to local indices within each crystal</span>
        <span class="n">local_edge_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">edge_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edge_indices_by_crystal</span><span class="p">):</span>
            <span class="n">local_edge_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_indices</span> <span class="o">-</span> <span class="n">atom_index_offsets</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="c1"># Initialize results containers</span>
        <span class="n">band_energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wavefunctions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Process each crystal</span>
        <span class="k">for</span> <span class="n">crystal_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">k_points</span> <span class="o">=</span> <span class="n">crystal_data</span><span class="o">.</span><span class="n">k_vecs</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
            <span class="n">num_atoms</span> <span class="o">=</span> <span class="n">atoms_per_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># Create unique cell shift mapping for this crystal</span>
            <span class="n">cell_shift_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shift</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">cell_shifts_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]]</span>
            <span class="n">unique_cell_shifts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cell_shift_tuples</span><span class="p">))</span>
            <span class="n">cell_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">shift</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_cell_shifts</span><span class="p">)}</span>
            <span class="n">cell_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">cell_to_index</span><span class="p">[</span><span class="n">shift</span><span class="p">]</span> <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">cell_shift_tuples</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">source_indices</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>
            <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cell_shifts</span><span class="p">)</span>

            <span class="c1"># Calculate phase factors for k-points</span>
            <span class="c1"># Shape: (num_k_points, num_cells)</span>
            <span class="n">phase_factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_cells</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Son</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Set phase factors for each cell shift</span>
            <span class="n">phase_factors</span><span class="p">[:,</span> <span class="n">cell_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">nbr_shifts_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">k_points</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Create atom index tensor</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">source_indices</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>

            <span class="c1"># Initialize overlap matrix in k-space</span>
            <span class="n">s_by_cell</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                    <span class="n">num_cells</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Son</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Set off-site overlap elements</span>
            <span class="n">source_atoms</span><span class="p">,</span> <span class="n">target_atoms</span> <span class="o">=</span> <span class="n">local_edge_indices</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>
            <span class="n">s_by_cell</span><span class="p">[</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">source_atoms</span><span class="p">,</span> <span class="n">target_atoms</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">offsite_overlaps_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span>

            <span class="c1"># Calculate k-space overlap matrix</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijklm,ni-&gt;njklm&#39;</span><span class="p">,</span> <span class="n">s_by_cell</span><span class="p">,</span> <span class="n">phase_factors</span><span class="p">)</span>

            <span class="c1"># Add on-site overlap elements</span>
            <span class="n">overlap_k</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_overlaps_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

            <span class="c1"># Reshape and swap dimensions for consistent ordering</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">overlap_k</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Swap atom and orbital indices</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

            <span class="c1"># Apply orbital mask to select only valid orbitals</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">overlap_k</span><span class="p">[:,</span> <span class="n">orbital_interaction_masks</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">num_orbitals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">overlap_k</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">))</span>
            <span class="n">overlap_k</span> <span class="o">=</span> <span class="n">overlap_k</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

            <span class="c1"># Create identity matrix for spin expansion</span>
            <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Hon</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Hon</span><span class="p">)</span>

            <span class="c1"># Expand overlap matrix to account for spin</span>
            <span class="n">overlap_k_soc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">overlap_k</span><span class="p">)</span>

            <span class="c1"># Process SOC Hamiltonian components</span>
            <span class="c1"># Extract spin blocks from on-site Hamiltonian</span>
            <span class="n">h_up_up</span> <span class="o">=</span> <span class="n">real_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span>

            <span class="n">h_up_down</span> <span class="o">=</span> <span class="n">real_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> \
                       <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span>

            <span class="n">h_down_up</span> <span class="o">=</span> <span class="n">real_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span>

            <span class="n">h_down_down</span> <span class="o">=</span> <span class="n">real_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> \
                         <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_onsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span>

            <span class="n">onsite_soc_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_up_up</span><span class="p">,</span> <span class="n">h_up_down</span><span class="p">,</span> <span class="n">h_down_up</span><span class="p">,</span> <span class="n">h_down_down</span><span class="p">]</span>

            <span class="c1"># Extract spin blocks from off-site Hamiltonian</span>
            <span class="n">h_up_up</span> <span class="o">=</span> <span class="n">real_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span>

            <span class="n">h_up_down</span> <span class="o">=</span> <span class="n">real_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> \
                       <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span>

            <span class="n">h_down_up</span> <span class="o">=</span> <span class="n">real_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span>

            <span class="n">h_down_down</span> <span class="o">=</span> <span class="n">real_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">+</span> \
                         <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_offsite_by_crystal</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span>

            <span class="n">offsite_soc_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_up_up</span><span class="p">,</span> <span class="n">h_up_down</span><span class="p">,</span> <span class="n">h_down_up</span><span class="p">,</span> <span class="n">h_down_down</span><span class="p">]</span>

            <span class="c1"># Initialize k-space Hamiltonian blocks</span>
            <span class="n">hamiltonian_k_blocks</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Process each spin block</span>
            <span class="k">for</span> <span class="n">onsite_block</span><span class="p">,</span> <span class="n">offsite_block</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">onsite_soc_blocks</span><span class="p">,</span> <span class="n">offsite_soc_blocks</span><span class="p">):</span>
                <span class="c1"># Initialize Hamiltonian matrix in k-space for this spin block</span>
                <span class="n">h_by_cell</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
                        <span class="n">num_cells</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span>
                    <span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">crystal_data</span><span class="o">.</span><span class="n">Son</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Set off-site Hamiltonian elements</span>
                <span class="n">h_by_cell</span><span class="p">[</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">source_atoms</span><span class="p">,</span> <span class="n">target_atoms</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">offsite_block</span>

                <span class="c1"># Calculate k-space Hamiltonian matrix</span>
                <span class="n">hamiltonian_k_block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijklm,ni-&gt;njklm&#39;</span><span class="p">,</span> <span class="n">h_by_cell</span><span class="p">,</span> <span class="n">phase_factors</span><span class="p">)</span>

                <span class="c1"># Add on-site Hamiltonian elements</span>
                <span class="n">hamiltonian_k_block</span><span class="p">[:,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">onsite_block</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">atom_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

                <span class="c1"># Reshape and swap dimensions for consistent ordering</span>
                <span class="n">hamiltonian_k_block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">hamiltonian_k_block</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">hamiltonian_k_block</span> <span class="o">=</span> <span class="n">hamiltonian_k_block</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                <span class="c1"># Apply orbital mask to select only valid orbitals</span>
                <span class="n">hamiltonian_k_block</span> <span class="o">=</span> <span class="n">hamiltonian_k_block</span><span class="p">[:,</span> <span class="n">orbital_interaction_masks</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">hamiltonian_k_block</span> <span class="o">=</span> <span class="n">hamiltonian_k_block</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">,</span> <span class="n">num_orbitals</span><span class="p">)</span>

                <span class="n">hamiltonian_k_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hamiltonian_k_block</span><span class="p">)</span>

            <span class="c1"># Combine spin blocks into full SOC Hamiltonian</span>
            <span class="n">hamiltonian_k_soc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hamiltonian_k_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hamiltonian_k_blocks</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hamiltonian_k_blocks</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hamiltonian_k_blocks</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Solve generalized eigenvalue problem using Cholesky decomposition</span>
            <span class="n">cholesky_factor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">overlap_k_soc</span><span class="p">)</span>
            <span class="n">cholesky_factor_conj_transpose</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cholesky_factor</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cholesky_inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky_factor</span><span class="p">)</span>
            <span class="n">cholesky_conj_transpose_inverse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky_factor_conj_transpose</span><span class="p">)</span>

            <span class="c1"># Transform to standard eigenvalue problem</span>
            <span class="n">transformed_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">cholesky_inverse</span><span class="p">,</span> <span class="n">hamiltonian_k_soc</span><span class="p">),</span>
                <span class="n">cholesky_conj_transpose_inverse</span>
            <span class="p">)</span>

            <span class="c1"># Solve eigenvalue problem</span>
            <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">transformed_hamiltonian</span><span class="p">)</span>

            <span class="c1"># Transform eigenvectors back to original basis</span>
            <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">cholesky_conj_transpose_inverse</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">)</span>

            <span class="c1"># Apply band number control if specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># Use pre-calculated band counts</span>
                    <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[:,</span> <span class="p">:</span><span class="n">crystal_band_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]]</span>
                    <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="p">:</span><span class="n">crystal_band_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">],</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Calculate band window centered around valence electron count</span>
                    <span class="n">band_window_start</span> <span class="o">=</span> <span class="n">crystal_valence_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span>
                    <span class="n">band_window_end</span> <span class="o">=</span> <span class="n">crystal_valence_counts</span><span class="p">[</span><span class="n">crystal_idx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">band_num_control</span>
                    <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[:,</span> <span class="n">band_window_start</span><span class="p">:</span><span class="n">band_window_end</span><span class="p">]</span>
                    <span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">band_window_start</span><span class="p">:</span><span class="n">band_window_end</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># Store results</span>
            <span class="n">band_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">wavefunctions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eigenvectors</span><span class="p">)</span>

        <span class="c1"># Combine results across all crystals</span>
        <span class="n">band_energies</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">band_energies</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">wavefunctions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">wavefunctions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">band_energies</span><span class="p">,</span> <span class="n">wavefunctions</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.apply_orbital_masks_to_hamiltonians">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.apply_orbital_masks_to_hamiltonians">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">return_masks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply atomic orbital validity masks to on-site and off-site Hamiltonian matrices.</span>

<span class="sd">        This function zeroes out elements of Hamiltonian matrices that correspond to invalid </span>
<span class="sd">        or non-existent atomic orbitals based on the atomic numbers. This ensures physical</span>
<span class="sd">        correctness by preventing interactions involving orbitals that shouldn&#39;t exist for</span>
<span class="sd">        particular atom types.</span>

<span class="sd">        Args:</span>
<span class="sd">            onsite_hamiltonian (torch.Tensor): On-site Hamiltonian matrix elements with shape</span>
<span class="sd">                (n_atoms, nao_max^2) or (n_atoms, nao_max, nao_max).</span>
<span class="sd">            offsite_hamiltonian (torch.Tensor): Off-site Hamiltonian matrix elements with shape </span>
<span class="sd">                (n_edges, nao_max^2) or (n_edges, nao_max, nao_max).</span>
<span class="sd">            data (DataObject): Object containing:</span>
<span class="sd">                - z: Atomic numbers for each atom</span>
<span class="sd">                - edge_index: Indices of connected atom pairs (source, target)</span>
<span class="sd">            return_masks (bool, optional): Whether to return the masks along with masked </span>
<span class="sd">                Hamiltonians. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: If return_masks is False:</span>
<span class="sd">                (masked_onsite_hamiltonian, masked_offsite_hamiltonian)</span>

<span class="sd">                If return_masks is True:</span>
<span class="sd">                (masked_onsite_hamiltonian, masked_offsite_hamiltonian, </span>
<span class="sd">                 onsite_orbital_mask, offsite_orbital_mask)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create atomic orbital validity mask based on atomic numbers</span>
        <span class="n">atomic_orbital_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

        <span class="c1"># Populate mask with 1s for valid orbitals of each atomic number</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">orbital_indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">][</span><span class="n">orbital_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Save original shapes for reshaping at the end</span>
        <span class="n">original_onsite_shape</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">original_offsite_shape</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># ---- Create and apply mask for on-site Hamiltonian ----</span>

        <span class="c1"># Get orbital mask for each atom</span>
        <span class="n">atom_orbital_masks</span> <span class="o">=</span> <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>  <span class="c1"># [n_atoms, nao_max]</span>

        <span class="c1"># Create outer product of masks for each atom&#39;s interaction with itself</span>
        <span class="c1"># This gives a matrix where element (i,j) is 1 if both orbitals i and j are valid</span>
        <span class="n">onsite_orbital_mask</span> <span class="o">=</span> <span class="n">atom_orbital_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">atom_orbital_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># [n_atoms, nao_max, nao_max]</span>

        <span class="c1"># Reshape to match Hamiltonian shape</span>
        <span class="n">onsite_orbital_mask</span> <span class="o">=</span> <span class="n">onsite_orbital_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_onsite_shape</span><span class="p">)</span>

        <span class="c1"># Apply mask to on-site Hamiltonian</span>
        <span class="n">masked_onsite_hamiltonian</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span> <span class="o">*</span> <span class="n">onsite_orbital_mask</span>

        <span class="c1"># ---- Create and apply mask for off-site Hamiltonian ----</span>

        <span class="c1"># Get source and target atom indices for each edge</span>
        <span class="n">source_atoms</span><span class="p">,</span> <span class="n">target_atoms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>

        <span class="c1"># Get orbital masks for source and target atoms of each edge</span>
        <span class="n">source_orbital_masks</span> <span class="o">=</span> <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">source_atoms</span><span class="p">]]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>  <span class="c1"># [n_edges, nao_max]</span>
        <span class="n">target_orbital_masks</span> <span class="o">=</span> <span class="n">atomic_orbital_mask</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">target_atoms</span><span class="p">]]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>  <span class="c1"># [n_edges, nao_max]</span>

        <span class="c1"># Create outer product of source and target masks for each edge</span>
        <span class="c1"># This gives a matrix where element (i,j) is 1 if both orbitals i (source) and j (target) are valid</span>
        <span class="n">offsite_orbital_mask</span> <span class="o">=</span> <span class="n">source_orbital_masks</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">target_orbital_masks</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># [n_edges, nao_max, nao_max]</span>

        <span class="c1"># Reshape to match Hamiltonian shape</span>
        <span class="n">offsite_orbital_mask</span> <span class="o">=</span> <span class="n">offsite_orbital_mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">original_offsite_shape</span><span class="p">)</span>

        <span class="c1"># Apply mask to off-site Hamiltonian</span>
        <span class="n">masked_offsite_hamiltonian</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span> <span class="o">*</span> <span class="n">offsite_orbital_mask</span>

        <span class="c1"># Return results based on return_masks flag</span>
        <span class="k">if</span> <span class="n">return_masks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">masked_onsite_hamiltonian</span><span class="p">,</span> <span class="n">masked_offsite_hamiltonian</span><span class="p">,</span> <span class="n">onsite_orbital_mask</span><span class="p">,</span> <span class="n">offsite_orbital_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">masked_onsite_hamiltonian</span><span class="p">,</span> <span class="n">masked_offsite_hamiltonian</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.symmetrize_orbital_coefficients">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.symmetrize_orbital_coefficients">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">symmetrize_orbital_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefficient_matrix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enforce spherical symmetry on orbital coefficient matrices by averaging within angular momentum blocks.</span>

<span class="sd">        This function applies orbital symmetrization to ensure that coefficients maintain proper</span>
<span class="sd">        rotational invariance within each angular momentum subspace (p, d, f orbitals). Each block</span>
<span class="sd">        of coefficients corresponding to orbitals with the same angular momentum is averaged to </span>
<span class="sd">        enforce spherical symmetry constraints.</span>

<span class="sd">        Orbital index ranges by angular momentum:</span>
<span class="sd">        - s orbitals: 0:3 (single orbital with additional indices)</span>
<span class="sd">        - p orbitals: 3:6 (3 components)</span>
<span class="sd">        - p&#39; orbitals: 6:9 (3 components)</span>
<span class="sd">        - d orbitals: 9:14 (5 components)</span>
<span class="sd">        - d&#39; orbitals: 14:19 (5 components, only for nao_max  19)</span>
<span class="sd">        - f orbitals: 19:26 (7 components, only for nao_max = 26)</span>

<span class="sd">        Args:</span>
<span class="sd">            coefficient_matrix (torch.Tensor): Coefficient matrix with shape (batch_size, nao_max2)</span>
<span class="sd">                or (batch_size, nao_max, nao_max).</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Symmetrized coefficient matrix with shape (batch_size, nao_max2).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">coefficient_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Reshape to 3D tensor if necessary</span>
        <span class="n">matrix_3d</span> <span class="o">=</span> <span class="n">coefficient_matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

        <span class="c1"># Define orbital blocks based on angular momentum</span>
        <span class="n">orbital_blocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">:</span>  <span class="c1"># All sizes have at least these blocks</span>
            <span class="n">orbital_blocks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>    <span class="c1"># p orbitals (3 components)</span>
                <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>    <span class="c1"># p&#39; orbitals (3 components)</span>
                <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>   <span class="c1"># d orbitals (5 components)</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">&gt;=</span> <span class="mi">19</span><span class="p">:</span>  <span class="c1"># 19 and 26 have d&#39; orbitals</span>
            <span class="n">orbital_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">19</span><span class="p">))</span>  <span class="c1"># d&#39; orbitals (5 components)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>  <span class="c1"># Only 26 has f orbitals</span>
            <span class="n">orbital_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">19</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>  <span class="c1"># f orbitals (7 components)</span>

        <span class="c1"># Apply row-wise averaging (across orbital m components)</span>
        <span class="k">for</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="ow">in</span> <span class="n">orbital_blocks</span><span class="p">:</span>
            <span class="c1"># Calculate mean across the angular momentum block</span>
            <span class="n">block_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">matrix_3d</span><span class="p">[:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Expand mean to match the original block shape and assign</span>
            <span class="n">block_size</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span>
            <span class="n">matrix_3d</span><span class="p">[:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_mean</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

        <span class="c1"># Apply column-wise averaging (across orbital m components)</span>
        <span class="k">for</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="ow">in</span> <span class="n">orbital_blocks</span><span class="p">:</span>
            <span class="c1"># Calculate mean across the angular momentum block</span>
            <span class="n">block_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">matrix_3d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Expand mean to match the original block shape and assign</span>
            <span class="n">block_size</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span>
            <span class="n">matrix_3d</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_mean</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="n">block_size</span><span class="p">)</span>

        <span class="c1"># Flatten the matrix back to original shape</span>
        <span class="k">return</span> <span class="n">matrix_3d</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="HamGNNPlusPlusOut.create_cell_index_mapping">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.create_cell_index_mapping">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_cell_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_cell_vectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a mapping from unique cell vectors to their indices.</span>

<span class="sd">        This function creates a dictionary that associates each unique cell vector </span>
<span class="sd">        (representing a unit cell in a periodic lattice) with its index in the list</span>
<span class="sd">        of unique vectors. This mapping is used for efficient lookup of cell indices</span>
<span class="sd">        when constructing Hamiltonian matrices with periodic boundary conditions.</span>

<span class="sd">        Args:</span>
<span class="sd">            unique_cell_vectors (List[List[int]]): A list of cell vectors, where each </span>
<span class="sd">                vector is represented as a list of integers (typically 3 integers for </span>
<span class="sd">                3D periodic systems).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary mapping each cell vector (as a tuple) to its integer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create mapping using dictionary comprehension for efficiency</span>
        <span class="k">return</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cell_vector</span><span class="p">):</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cell_vector</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_cell_vectors</span><span class="p">)}</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.extract_unique_cell_vectors">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.extract_unique_cell_vectors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_unique_cell_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract unique cell vectors and create mappings for periodic boundary conditions.</span>

<span class="sd">        This function processes cell shift data to:</span>
<span class="sd">        1. Find all unique cell shift vectors</span>
<span class="sd">        2. Ensure the zero vector (0,0,0) is included (required for on-site interactions)</span>
<span class="sd">        3. Create a mapping from each cell shift to its unique index</span>
<span class="sd">        4. Create an index array that maps each edge to its corresponding cell index</span>

<span class="sd">        This information is essential for constructing Hamiltonian matrices with</span>
<span class="sd">        proper periodic boundary conditions.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Object containing crystal structure information, including:</span>
<span class="sd">                - cell_shift: Tensor of cell shift vectors for each edge, with shape </span>
<span class="sd">                  (n_edges, 3), representing the periodic image shifts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                - unique_cell_vectors (torch.Tensor): Tensor of unique cell shift vectors</span>
<span class="sd">                  with shape (n_unique_cells, 3).</span>
<span class="sd">                - cell_vector_indices (torch.Tensor): Tensor mapping each edge to the</span>
<span class="sd">                  index of its corresponding unique cell vector, with shape (n_edges,).</span>
<span class="sd">                - cell_vector_map (dict): Dictionary mapping each cell vector tuple to</span>
<span class="sd">                  its index in unique_cell_vectors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all cell shift vectors from the data</span>
        <span class="n">cell_shift_vectors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift</span>

        <span class="c1"># Find all unique cell shift vectors</span>
        <span class="n">unique_cell_vectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_shift_vectors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Create zero vector with the same type as unique vectors</span>
        <span class="n">zero_vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">device</span><span class="o">=</span><span class="n">unique_cell_vectors</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">unique_cell_vectors</span><span class="p">)</span>

        <span class="c1"># Check if zero vector is already present in the unique vectors</span>
        <span class="n">is_zero_vector_present</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">unique_cell_vectors</span> <span class="o">==</span> <span class="n">zero_vector</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Add zero vector if not present (required for on-site interactions)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_zero_vector_present</span><span class="p">:</span>
            <span class="n">unique_cell_vectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">zero_vector</span><span class="p">,</span> <span class="n">unique_cell_vectors</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Create mapping from each edge&#39;s cell vector to its index in the unique vectors list</span>
        <span class="c1"># Method 1: Using tensor expansion (works for all PyTorch versions)</span>
        <span class="c1"># Expand tensors for broadcasting comparison</span>
        <span class="n">expanded_cell_shifts</span> <span class="o">=</span> <span class="n">cell_shift_vectors</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">unique_cell_vectors</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expanded_unique_vectors</span> <span class="o">=</span> <span class="n">unique_cell_vectors</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">cell_shift_vectors</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Find exact matches (where all dimensions are equal)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">expanded_cell_shifts</span> <span class="o">==</span> <span class="n">expanded_unique_vectors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Extract the index of the matching unique vector for each edge</span>
        <span class="n">cell_vector_indices</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Shape: (n_edges,)</span>

        <span class="c1"># Create dictionary mapping each cell vector to its index</span>
        <span class="n">cell_vector_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cell_index_mapping</span><span class="p">(</span><span class="n">unique_cell_vectors</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">unique_cell_vectors</span><span class="p">,</span> <span class="n">cell_vector_indices</span><span class="p">,</span> <span class="n">cell_vector_map</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.build_edge_lookup_structures">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_edge_lookup_structures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_edge_lookup_structures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build efficient edge lookup structures for crystal graph operations.</span>

<span class="sd">        This function constructs two data structures that enable fast edge lookup:</span>
<span class="sd">        1. A mapping from each atom to all edges where that atom is the source</span>
<span class="sd">        2. A mapping from each atom and cell shift combination to corresponding edges</span>

<span class="sd">        These structures accelerate operations that require finding all edges connected </span>
<span class="sd">        to specific atoms, particularly when periodic boundary conditions are involved.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Crystal graph data containing:</span>
<span class="sd">                - edge_index: Tensor of shape [2, num_edges] with source and target indices</span>
<span class="sd">                - unique_cell_shift: Tensor of unique cell shift vectors</span>
<span class="sd">                - cell_shift_indices: Tensor mapping each edge to its cell shift index</span>
<span class="sd">                - cell_index_map: Dictionary mapping cell shift tuples to indices</span>
<span class="sd">                - z: Atomic numbers, used to determine number of atoms</span>
<span class="sd">            inverse_edge_indices (torch.Tensor, optional): Tensor mapping each edge to its</span>
<span class="sd">                inverse edge index (ij maps to ji). Required for building the target lookup.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple:</span>
<span class="sd">                - source_edge_indices (list of torch.Tensor): For each atom, contains indices</span>
<span class="sd">                  of edges where that atom is the source.</span>
<span class="sd">                - target_edge_indices (list of list of torch.Tensor): For each atom and cell</span>
<span class="sd">                  shift combination, contains indices of edges where that atom is the target</span>
<span class="sd">                  in the specified cell shift.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract necessary data</span>
        <span class="n">source_nodes</span><span class="p">,</span> <span class="n">target_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">unique_cell_shifts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">unique_cell_shift</span>
        <span class="n">cell_shift_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift_indices</span>
        <span class="n">cell_index_map</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span>

        <span class="c1"># Get dimensions</span>
        <span class="n">num_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">num_cell_shifts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cell_shifts</span><span class="p">)</span>

        <span class="c1"># Build mapping from each atom to edges where it&#39;s the source</span>
        <span class="c1"># This finds all edges that originate from each atom</span>
        <span class="n">source_edge_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">source_nodes</span> <span class="o">==</span> <span class="n">atom_idx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">)]</span>

        <span class="c1"># Initialize the nested structure for target edge lookup</span>
        <span class="c1"># This will map each (atom, cell_shift) pair to a list of edge indices</span>
        <span class="n">target_edge_indices</span> <span class="o">=</span> <span class="p">[[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cell_shifts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">)]</span>

        <span class="c1"># Populate target edge lookup structure</span>
        <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">):</span>
            <span class="c1"># Get the inverse edges for edges where this atom is the source</span>
            <span class="c1"># These are edges where this atom is the target</span>
            <span class="n">inverse_edges</span> <span class="o">=</span> <span class="n">inverse_edge_indices</span><span class="p">[</span><span class="n">source_edge_indices</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]]</span>

            <span class="c1"># Get cell shift indices for these inverse edges</span>
            <span class="n">cell_shifts_of_inverse_edges</span> <span class="o">=</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">inverse_edges</span><span class="p">]</span>

            <span class="c1"># Group inverse edges by their cell shift</span>
            <span class="k">for</span> <span class="n">edge_idx</span><span class="p">,</span> <span class="n">cell_shift_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inverse_edges</span><span class="p">,</span> <span class="n">cell_shifts_of_inverse_edges</span><span class="p">):</span>
                <span class="n">target_edge_indices</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">cell_shift_idx</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_idx</span><span class="p">)</span>

            <span class="c1"># Convert lists to tensors for efficiency</span>
            <span class="k">for</span> <span class="n">cell_shift_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cell_shifts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">target_edge_indices</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">cell_shift_idx</span><span class="p">]:</span>
                    <span class="c1"># If edges exist for this cell shift, stack them into a tensor</span>
                    <span class="n">target_edge_indices</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">cell_shift_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                        <span class="n">target_edge_indices</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">cell_shift_idx</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_nodes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Otherwise create an empty tensor of the correct type</span>
                    <span class="n">target_edge_indices</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">cell_shift_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                        <span class="p">[],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_nodes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">source_edge_indices</span><span class="p">,</span> <span class="n">target_edge_indices</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.create_orbital_validity_mask">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.create_orbital_validity_mask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_orbital_validity_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomic_numbers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a mask identifying valid atomic orbitals for each element type.</span>

<span class="sd">        This function generates a binary mask tensor where each row corresponds to an</span>
<span class="sd">        element in the periodic table (indexed by atomic number), and each column</span>
<span class="sd">        represents an atomic orbital. A value of 1 indicates that the orbital is</span>
<span class="sd">        valid for that element type, while 0 indicates an invalid orbital.</span>

<span class="sd">        Args:</span>
<span class="sd">            atomic_numbers (torch.Tensor): Tensor containing atomic numbers, used only</span>
<span class="sd">                for device and dtype information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Binary mask tensor of shape (99, nao_max) where 99 covers</span>
<span class="sd">                all possible elements in the periodic table and nao_max is the maximum</span>
<span class="sd">                number of atomic orbitals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize all orbitals as invalid (zeros)</span>
        <span class="n">orbital_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">atomic_numbers</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">)</span>

        <span class="c1"># Set valid orbitals to 1 for each element type based on the basis definition</span>
        <span class="k">for</span> <span class="n">atomic_number</span><span class="p">,</span> <span class="n">valid_orbital_indices</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">orbital_mask</span><span class="p">[</span><span class="n">atomic_number</span><span class="p">][</span><span class="n">valid_orbital_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">orbital_mask</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.build_interaction_masks">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_interaction_masks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_interaction_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build boolean masks for valid orbital interactions in Hamiltonian matrices.</span>

<span class="sd">        This function generates masks that identify which elements in the Hamiltonian</span>
<span class="sd">        matrices correspond to valid orbital-orbital interactions, based on the atomic</span>
<span class="sd">        species involved. It creates separate masks for on-site (same atom) and</span>
<span class="sd">        off-site (different atoms) interactions.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Graph data containing:</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - z: Atomic numbers for each atom</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Combined mask tensor with shape (n_atoms + n_edges, nao_max2)</span>
<span class="sd">                where the first n_atoms rows are for on-site interactions and the</span>
<span class="sd">                remaining n_edges rows are for off-site interactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>

        <span class="c1"># Get orbital validity mask for each element type</span>
        <span class="n">orbital_validity_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_orbital_validity_mask</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">)</span>

        <span class="c1"># Create on-site interaction masks using einsum for efficient outer product</span>
        <span class="c1"># Each mask has shape (n_atoms, nao_max, nao_max) where element (i,j,k) is True</span>
        <span class="c1"># if orbital j of atom i can interact with orbital k of the same atom</span>
        <span class="n">onsite_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">],</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># Create off-site interaction masks using einsum</span>
        <span class="c1"># Each mask has shape (n_edges, nao_max, nao_max) where element (e,j,k) is True</span>
        <span class="c1"># if orbital j of source atom can interact with orbital k of target atom</span>
        <span class="n">offsite_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">[</span><span class="n">source_indices</span><span class="p">]],</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">[</span><span class="n">target_indices</span><span class="p">]]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># Reshape masks to 2D format and concatenate</span>
        <span class="n">combined_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">(</span><span class="n">onsite_masks</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> 
             <span class="n">offsite_masks</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_masks</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.build_column_wise_interaction_masks">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_column_wise_interaction_masks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_column_wise_interaction_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build interaction masks with an additional column dimension.</span>

<span class="sd">        Similar to build_interaction_masks, but creates masks with an additional</span>
<span class="sd">        dimension for column-wise operations (e.g., for real and imaginary parts).</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Graph data containing:</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - z: Atomic numbers for each atom</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Combined mask tensor with shape </span>
<span class="sd">                (n_atoms + n_edges, 2, nao_max2) where the additional</span>
<span class="sd">                dimension can be used for real and imaginary parts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>

        <span class="c1"># Get orbital validity mask for each element type</span>
        <span class="n">orbital_validity_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_orbital_validity_mask</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">)</span>

        <span class="c1"># Create on-site interaction masks</span>
        <span class="n">onsite_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">],</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># Stack the mask along a new dimension (for real and imaginary parts)</span>
        <span class="c1"># Shape: (n_atoms, 2, nao_max, nao_max)</span>
        <span class="n">onsite_masks_stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">onsite_masks</span><span class="p">,</span> <span class="n">onsite_masks</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create off-site interaction masks</span>
        <span class="n">offsite_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">[</span><span class="n">source_indices</span><span class="p">]],</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">[</span><span class="n">target_indices</span><span class="p">]]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># Stack the mask along a new dimension</span>
        <span class="c1"># Shape: (n_edges, 2, nao_max, nao_max)</span>
        <span class="n">offsite_masks_stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">offsite_masks</span><span class="p">,</span> <span class="n">offsite_masks</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Reshape masks and concatenate</span>
        <span class="n">combined_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">(</span><span class="n">onsite_masks_stacked</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> 
             <span class="n">offsite_masks_stacked</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> 
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_masks</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.build_spin_orbit_interaction_masks">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.build_spin_orbit_interaction_masks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_spin_orbit_interaction_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build interaction masks that account for spin-orbit coupling.</span>

<span class="sd">        This function generates masks for systems with spin-orbit coupling, which</span>
<span class="sd">        requires handling interactions between different spin components. The resulting</span>
<span class="sd">        masks have double the orbital dimension to account for spin-up and spin-down</span>
<span class="sd">        components.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Graph data containing:</span>
<span class="sd">                - edge_index: Indices of connected atom pairs</span>
<span class="sd">                - z: Atomic numbers for each atom</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing:</span>
<span class="sd">                - real_imag_masks (torch.Tensor): Mask for real and imaginary</span>
<span class="sd">                  components with shape (n_atoms + n_edges, (2*nao_max)2)</span>
<span class="sd">                - combined_masks (torch.Tensor): Full mask tensor with shape </span>
<span class="sd">                  (2*(n_atoms + n_edges), (2*nao_max)2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
        <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>

        <span class="c1"># Get orbital validity mask for each element type</span>
        <span class="n">orbital_validity_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_orbital_validity_mask</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">)</span>

        <span class="c1"># Create base interaction masks without converting to boolean yet</span>
        <span class="n">onsite_base_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">],</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">offsite_base_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="s1">&#39;ni, nj -&gt; nij&#39;</span><span class="p">,</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">[</span><span class="n">source_indices</span><span class="p">]],</span> 
            <span class="n">orbital_validity_mask</span><span class="p">[</span><span class="n">atomic_numbers</span><span class="p">[</span><span class="n">target_indices</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="c1"># Expand to include spin components using 2x2 block structure</span>
        <span class="c1"># This creates a block diagonal matrix where each block represents</span>
        <span class="c1"># interactions between different spin components</span>
        <span class="n">onsite_expanded_masks</span> <span class="o">=</span> <span class="n">blockwise_2x2_concat</span><span class="p">(</span>
            <span class="n">onsite_base_masks</span><span class="p">,</span> <span class="n">onsite_base_masks</span><span class="p">,</span> 
            <span class="n">onsite_base_masks</span><span class="p">,</span> <span class="n">onsite_base_masks</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="n">offsite_expanded_masks</span> <span class="o">=</span> <span class="n">blockwise_2x2_concat</span><span class="p">(</span>
            <span class="n">offsite_base_masks</span><span class="p">,</span> <span class="n">offsite_base_masks</span><span class="p">,</span> 
            <span class="n">offsite_base_masks</span><span class="p">,</span> <span class="n">offsite_base_masks</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># Combine on-site and off-site masks</span>
        <span class="n">real_imag_masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">onsite_expanded_masks</span><span class="p">,</span> <span class="n">offsite_expanded_masks</span>
        <span class="p">)</span>

        <span class="c1"># Create full mask tensor by duplicating (for real and imaginary parts)</span>
        <span class="n">combined_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">real_imag_masks</span><span class="p">,</span> <span class="n">real_imag_masks</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">real_imag_masks</span><span class="p">,</span> <span class="n">combined_masks</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.calculate_sparsity_ratio">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.calculate_sparsity_ratio">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_sparsity_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the ratio between the total possible matrix elements and the effective matrix elements.</span>

<span class="sd">        This function computes the sparsity of Hamiltonian matrices by dividing the total number</span>
<span class="sd">        of possible matrix elements by the number of effective matrix elements based on the</span>
<span class="sd">        atomic basis definitions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : object</span>
<span class="sd">            Data object containing atomic information and Hamiltonian matrices.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The sparsity ratio, defined as the total number of matrix elements</span>
<span class="sd">            divided by the number of effective matrix elements. Returns infinity</span>
<span class="sd">            if there are no effective elements.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The calculation considers both on-site and off-site Hamiltonian elements</span>
<span class="sd">        if they are present in the data object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get atomic numbers</span>
        <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>

        <span class="c1"># Initialize counters</span>
        <span class="n">total_matrix_elements</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">effective_matrix_elements</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Cache the squared maximum number of atomic orbitals for efficiency</span>
        <span class="n">nao_max_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Process on-site Hamiltonian (diagonal blocks)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Hon&#39;</span><span class="p">):</span>
            <span class="n">num_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">)</span>
            <span class="n">total_matrix_elements</span> <span class="o">+=</span> <span class="n">num_atoms</span> <span class="o">*</span> <span class="n">nao_max_squared</span>

            <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_atoms</span><span class="p">):</span>
                <span class="n">atom_type</span> <span class="o">=</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">atom_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">:</span>
                    <span class="n">basis_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">atom_type</span><span class="p">]</span>
                    <span class="n">effective_matrix_elements</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_indices</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If atom type is not defined, assume all elements are effective</span>
                    <span class="n">effective_matrix_elements</span> <span class="o">+=</span> <span class="n">nao_max_squared</span>

        <span class="c1"># Process off-site Hamiltonian (off-diagonal blocks)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Hoff&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;edge_index&#39;</span><span class="p">):</span>
            <span class="n">edge_index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>
            <span class="n">num_edges</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">total_matrix_elements</span> <span class="o">+=</span> <span class="n">num_edges</span> <span class="o">*</span> <span class="n">nao_max_squared</span>

            <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_edges</span><span class="p">):</span>
                <span class="n">source_idx</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">target_idx</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">source_atom_type</span> <span class="o">=</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">source_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">target_atom_type</span> <span class="o">=</span> <span class="n">atomic_numbers</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">source_atom_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span> <span class="ow">and</span> <span class="n">target_atom_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">:</span>
                    <span class="n">source_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">source_atom_type</span><span class="p">]</span>
                    <span class="n">target_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">[</span><span class="n">target_atom_type</span><span class="p">]</span>
                    <span class="n">effective_matrix_elements</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_basis</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_basis</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">effective_matrix_elements</span> <span class="o">+=</span> <span class="n">nao_max_squared</span>

        <span class="c1"># Calculate sparsity ratio (return inf if no effective elements)</span>
        <span class="k">return</span> <span class="n">total_matrix_elements</span> <span class="o">/</span> <span class="n">effective_matrix_elements</span> <span class="k">if</span> <span class="n">effective_matrix_elements</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.validate_elements_in_basis_def">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.validate_elements_in_basis_def">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_elements_in_basis_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that all elements in the input data exist in the basis_def dictionary.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function is used to ensure that all elements in the molecular system</span>
<span class="sd">        have corresponding basis set definitions before performing calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get atomic numbers from data object</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">):</span>
            <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>
            <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Input data object has no &#39;z&#39; or &#39;Z&#39; attribute containing atomic numbers&quot;</span><span class="p">)</span>

        <span class="c1"># Get unique atomic numbers and convert to standard Python list</span>
        <span class="n">unique_atomic_numbers</span> <span class="o">=</span> <span class="n">atomic_numbers</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Find atomic numbers that are missing from basis_def using set operations</span>
        <span class="n">missing_atomic_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">unique_atomic_numbers</span> <span class="k">if</span> <span class="n">num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_def</span><span class="p">]</span>

        <span class="c1"># Check if all elements are valid</span>
        <span class="n">all_elements_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_atomic_numbers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Handle case when invalid elements are found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_elements_valid</span> <span class="ow">and</span> <span class="n">raise_error</span><span class="p">:</span>
            <span class="c1"># Try to convert atomic numbers to element symbols if possible</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Attempt to use a periodic table package if available</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">qcelemental</span><span class="w"> </span><span class="kn">import</span> <span class="n">periodictable</span>
                <span class="n">element_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">periodictable</span><span class="o">.</span><span class="n">to_symbol</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="si">}</span><span class="s2"> (Z=</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">missing_atomic_numbers</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># Fallback to just showing atomic numbers</span>
                <span class="n">element_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Z=</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">missing_atomic_numbers</span><span class="p">]</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following elements are missing from basis_def: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">element_symbols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return appropriate value based on raise_error parameter</span>
        <span class="k">return</span> <span class="n">all_elements_valid</span> <span class="k">if</span> <span class="n">raise_error</span> <span class="k">else</span> <span class="p">(</span><span class="n">all_elements_valid</span><span class="p">,</span> <span class="n">missing_atomic_numbers</span><span class="p">)</span></div>


<div class="viewcode-block" id="HamGNNPlusPlusOut.forward">
<a class="viewcode-back" href="../../../api/model_structure.html#HamGNN_v_2_1.models.hamgnn_output.HamGNNPlusPlusOut.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">graph_representation</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass of the Hamiltonian prediction model.</span>

<span class="sd">        This method constructs Hamiltonian matrices for crystal structures from graph representations,</span>
<span class="sd">        with support for various physical effects including spin-orbit coupling (SOC), magnetism,</span>
<span class="sd">        and long-range interactions. It can also calculate electronic band structures.</span>

<span class="sd">        The method handles several different physical regimes:</span>
<span class="sd">        1. Non-magnetic systems (standard DFT-like Hamiltonians)</span>
<span class="sd">        2. Collinear spin-polarized systems (separate Hamiltonians for up/down spins)</span>
<span class="sd">        3. Non-collinear magnetic systems (full 2x2 spin blocks with SOC)</span>
<span class="sd">        4. Systems with spin-orbit coupling (complex Hamiltonians with real/imaginary parts)</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataObject): Contains crystal structure information including:</span>
<span class="sd">                - edge_index: Connectivity information between atoms</span>
<span class="sd">                - z: Atomic numbers</span>
<span class="sd">                - pos: Atomic positions</span>
<span class="sd">                - cell: Unit cell vectors</span>
<span class="sd">                - Hon/Hoff: Reference on-site/off-site Hamiltonian matrices (if available)</span>
<span class="sd">                - Son/Soff: Reference on-site/off-site overlap matrices</span>
<span class="sd">                - node_counts: Number of atoms in each crystal</span>
<span class="sd">                - batch: Batch assignment for each atom</span>
<span class="sd">                - inv_edge_idx: Inverse edge indices</span>

<span class="sd">            graph_representation (dict): Output from the graph neural network containing:</span>
<span class="sd">                - node_attr: Node feature vectors from the GNN</span>
<span class="sd">                - edge_attr: Edge feature vectors from the GNN</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing predicted quantities, which may include:</span>
<span class="sd">                - hamiltonian: Predicted Hamiltonian matrix</span>
<span class="sd">                - overlap: Predicted overlap matrix (if ham_only=False)</span>
<span class="sd">                - band_energy: Electronic band energies (if calculate_band_energy=True)</span>
<span class="sd">                - wavefunction: Eigenvectors of the Hamiltonian (if calculate_band_energy=True)</span>
<span class="sd">                - band_gap: Band gap values (if calculate_band_energy=True)</span>
<span class="sd">                - Various additional matrices for debugging or analysis</span>

<span class="sd">        Note:</span>
<span class="sd">            The exact contents of the return dictionary depend on the model configuration</span>
<span class="sd">            parameters (soc_switch, spin_constrained, collinear_spin, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate that all elements in the data are present in basis_def</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_elements_in_basis_def</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Data format compatibility handling</span>
        <span class="k">if</span> <span class="s1">&#39;H0_u&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="c1"># Handle legacy format from Hongyu yu&#39;s data</span>
            <span class="n">Hon_u0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_u</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hon_d0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_d</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hoff_u0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_u</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Hoff_d0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">H0_d</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Hon_u0</span><span class="p">,</span> <span class="n">Hon_d0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">Hoff_u0</span><span class="p">,</span> <span class="n">Hoff_d0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">H_u</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)],</span> <span class="n">data</span><span class="o">.</span><span class="n">H_d</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">)]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">H_u</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):],</span> <span class="n">data</span><span class="o">.</span><span class="n">H_d</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">):]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Prepare combined Hamiltonian and overlap matrices if not present</span>
        <span class="k">if</span> <span class="s1">&#39;hamiltonian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;overlap&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Son</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Soff</span><span class="p">)</span>

        <span class="c1"># Extract node and edge attributes from graph representation</span>
        <span class="n">node_attr</span> <span class="o">=</span> <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;node_attr&#39;</span><span class="p">]</span>
        <span class="n">edge_attr</span> <span class="o">=</span> <span class="n">graph_representation</span><span class="p">[</span><span class="s1">&#39;edge_attr&#39;</span><span class="p">]</span>  <span class="c1"># mji</span>
        <span class="n">source_indices</span><span class="p">,</span> <span class="n">target_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_index</span>

        <span class="c1"># Calculate batch-specific inverse edge indices</span>
        <span class="n">inverse_edge_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">inv_edge_idx</span>
        <span class="n">edge_count</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>
        <span class="n">edge_count_by_batch</span> <span class="o">=</span> <span class="n">scatter</span><span class="p">(</span><span class="n">edge_count</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">source_indices</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">edge_count_offset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">edge_count_by_batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">edge_count_by_batch</span>
        <span class="n">inverse_edge_indices</span> <span class="o">=</span> <span class="n">inverse_edge_indices</span> <span class="o">+</span> <span class="n">edge_count_offset</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">source_indices</span><span class="p">]]</span>

        <span class="c1"># Ensure irreps dimensions have correct data type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)</span>

        <span class="c1"># === OVERLAP MATRIX CALCULATION (if enabled) ===</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>
            <span class="c1"># Calculate on-site overlap matrix</span>
            <span class="n">node_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_overlap_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
            <span class="n">node_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">onsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">node_spherical_components</span><span class="p">)</span>  <span class="c1"># shape (n_atoms, nao_max2)</span>

            <span class="c1"># Reorder indices to match physical orbital ordering</span>
            <span class="n">onsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">onsite_overlap</span><span class="p">)</span>

            <span class="c1"># Impose Hermitian symmetry</span>
            <span class="n">onsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span><span class="n">onsite_overlap</span><span class="p">)</span>

            <span class="c1"># Calculate off-site overlap matrix</span>
            <span class="n">edge_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_overlap_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
            <span class="n">edge_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">offsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">edge_spherical_components</span><span class="p">)</span>

            <span class="c1"># Reorder indices and impose symmetry</span>
            <span class="n">offsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">offsite_overlap</span><span class="p">)</span>
            <span class="n">offsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span><span class="n">offsite_overlap</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>

            <span class="c1"># Apply orbital masking for certain Hamiltonian types</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span> <span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
                <span class="n">onsite_overlap</span><span class="p">,</span> <span class="n">offsite_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span><span class="n">onsite_overlap</span><span class="p">,</span> <span class="n">offsite_overlap</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># === HAMILTONIAN CALCULATION WITH SPIN EFFECTS ===</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
            <span class="c1"># Handle spin-orbit coupling</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
                <span class="c1"># Different SOC basis implementations</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;so3&#39;</span><span class="p">:</span>
                    <span class="c1"># SO(3) representation of spin-orbit coupling</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H_nonsoc</span><span class="p">:</span>
                        <span class="c1"># Use pre-defined non-SOC Hamiltonians</span>
                        <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon_nonsoc</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff_nonsoc</span>

                        <span class="c1"># Process the H0 matrices for SOC</span>
                        <span class="n">onsite_h0</span><span class="p">,</span> <span class="n">offsite_h0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hon0&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hoff0&#39;</span><span class="p">]</span>
                        <span class="n">onsite_h0_resized</span> <span class="o">=</span> <span class="n">onsite_h0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">offsite_h0_resized</span> <span class="o">=</span> <span class="n">offsite_h0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                        <span class="c1"># Create zero blocks for the diagonal blocks</span>
                        <span class="n">zero_onsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Son&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">zero_offsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Soff&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                        <span class="c1"># Zero out the diagonal blocks (spin-conserving terms)</span>
                        <span class="n">onsite_h0_resized</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_onsite</span>
                        <span class="n">onsite_h0_resized</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">zero_onsite</span>
                        <span class="n">offsite_h0_resized</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_offsite</span>
                        <span class="n">offsite_h0_resized</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">zero_offsite</span>

                        <span class="c1"># Store processed matrices</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hon0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onsite_h0_resized</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hoff0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsite_h0_resized</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Calculate Hamiltonians from spherical harmonics</span>
                        <span class="n">node_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_hamiltonian_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                        <span class="n">node_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">node_spherical_components</span><span class="p">)</span>

                        <span class="c1"># Process on-site Hamiltonian</span>
                        <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                        <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>

                        <span class="c1"># Calculate off-site Hamiltonian</span>
                        <span class="n">edge_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_hamiltonian_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                        <span class="n">edge_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">edge_spherical_components</span><span class="p">)</span>

                        <span class="c1"># Process off-site Hamiltonian</span>
                        <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">)</span>
                        <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>
                        
                        <span class="c1"># Apply orbital masking</span>
                        <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                    <span class="c1"># Calculate SOC coupling strength</span>
                    <span class="n">ksi_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_ksi_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                    <span class="n">ksi_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_orbital_coefficients</span><span class="p">(</span><span class="n">ksi_onsite</span><span class="p">)</span>
                    <span class="n">ksi_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_ksi_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">ksi_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_orbital_coefficients</span><span class="p">(</span><span class="n">ksi_offsite</span><span class="p">)</span>

                    <span class="c1"># Construct SOC Hamiltonian real part (2x2 block structure)</span>
                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                    <span class="c1"># Diagonal blocks (spin-conserving terms)</span>
                    <span class="n">soc_onsite_real</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_real</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="c1"># Off-diagonal blocks (spin-flip terms)</span>
                    <span class="n">soc_onsite_real</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_onsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_real</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_onsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">soc_onsite_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># Construct SOC Hamiltonian imaginary part</span>
                    <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                    <span class="c1"># Diagonal blocks</span>
                    <span class="n">soc_onsite_imag</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_onsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_imag</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_onsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="c1"># Off-diagonal blocks</span>
                    <span class="n">soc_onsite_imag</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_onsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_imag</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_onsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Lon</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                    <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="n">soc_onsite_imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># Similar construction for off-site SOC Hamiltonian</span>
                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">)</span>
                    <span class="c1"># Diagonal blocks</span>
                    <span class="n">soc_offsite_real</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_real</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="c1"># Off-diagonal blocks</span>
                    <span class="n">soc_offsite_real</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_offsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_real</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_offsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">soc_offsite_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># Off-site SOC Hamiltonian imaginary part</span>
                    <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">)</span>
                    <span class="c1"># Diagonal blocks</span>
                    <span class="n">soc_offsite_imag</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_offsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_imag</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_offsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="c1"># Off-diagonal blocks</span>
                    <span class="n">soc_offsite_imag</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_offsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_imag</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ksi_offsite</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">Loff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                    <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="n">soc_offsite_imag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_basis</span> <span class="o">==</span> <span class="s1">&#39;su2&#39;</span><span class="p">:</span>
                    <span class="c1"># SU(2) representation of spin-orbit coupling</span>
                    <span class="n">node_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_hamiltonian_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                    <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_decomposition</span><span class="o">.</span><span class="n">get_H</span><span class="p">(</span><span class="n">node_spherical_harmonics</span><span class="p">)</span>
                    <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                    <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># shape (n_atoms, 2, nao_max, 2, nao_max)</span>
                    <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian_soc</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># Ensure Hermiticity</span>

                    <span class="c1"># Calculate off-site Hamiltonian</span>
                    <span class="n">edge_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_hamiltonian_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_decomposition</span><span class="o">.</span><span class="n">get_H</span><span class="p">(</span><span class="n">edge_spherical_harmonics</span><span class="p">)</span>
                    <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">)</span>
                    <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># shape (n_edges, 2, nao_max, 2, nao_max)</span>
                    <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian_soc</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="c1"># Ensure Hermiticity</span>
                    
                    <span class="c1"># Apply orbital masking to each spin block</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">onsite_hamiltonian</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="n">offsite_hamiltonian</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span>
                                <span class="n">onsite_hamiltonian</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="n">offsite_hamiltonian</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span>
                            <span class="p">)</span>

                    <span class="c1"># Reshape to flattened form</span>
                    <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># Extract real and imaginary parts</span>
                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">imag</span>
                    <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">imag</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unsupported SOC basis&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># No SOC, but spin-constrained</span>
                <span class="c1"># Calculate standard Hamiltonian</span>
                <span class="n">node_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_hamiltonian_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                <span class="n">node_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">node_spherical_components</span><span class="p">)</span>

                <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>

                <span class="c1"># Calculate off-site Hamiltonian</span>
                <span class="n">edge_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_hamiltonian_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                <span class="n">edge_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">edge_spherical_components</span><span class="p">)</span>

                <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">)</span>
                <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>
                
                <span class="c1"># Apply orbital masking</span>
                <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="c1"># For non-collinear spin without SOC, create block diagonal matrices</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_real</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_real</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">soc_onsite_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_real</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_real</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">:]</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">soc_offsite_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># Zero imaginary parts</span>
                    <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iHon</span><span class="p">)</span>
                    <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iHoff</span><span class="p">)</span>

            <span class="c1"># === MAGNETIC INTERACTION CALCULATION ===</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
                <span class="c1"># Identify magnetic atoms</span>
                <span class="n">magnetic_atoms</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spin_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_magnetic_moment</span><span class="p">)</span>

                <span class="c1"># Extract cell shift information</span>
                <span class="n">data</span><span class="o">.</span><span class="n">unique_cell_shift</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift_indices</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_unique_cell_vectors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">cell_shift_indices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_shift_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">cell_index_map</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span>

                <span class="c1"># Learn weight matrices if enabled</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_learned_weight</span><span class="p">:</span>
                    <span class="c1"># Calculate on-site weight matrix</span>
                    <span class="n">node_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_weight_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                    <span class="n">node_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">weight_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">node_spherical_components</span><span class="p">)</span>

                    <span class="n">weight_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">weight_onsite</span><span class="p">)</span>
                    <span class="n">weight_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span><span class="n">weight_onsite</span><span class="p">)</span>

                    <span class="c1"># Calculate off-site weight matrix</span>
                    <span class="n">edge_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_weight_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">edge_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">weight_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">edge_spherical_components</span><span class="p">)</span>

                    <span class="n">weight_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">weight_offsite</span><span class="p">)</span>
                    <span class="n">weight_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span><span class="n">weight_offsite</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>

                    <span class="c1"># Apply orbital masking to weights</span>
                    <span class="n">weight_onsite</span><span class="p">,</span> <span class="n">weight_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span><span class="n">weight_onsite</span><span class="p">,</span> <span class="n">weight_offsite</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">weight_onsite</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                    <span class="n">weight_offsite</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>

                    <span class="c1"># Store weights for later use</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">weight_on</span> <span class="o">=</span> <span class="n">weight_onsite</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">weight_off</span> <span class="o">=</span> <span class="n">weight_offsite</span>

                <span class="c1"># Calculate magnetic interaction terms</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span><span class="p">:</span>
                    <span class="c1"># Calculate Heisenberg J coupling for SOC</span>
                    <span class="n">J_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_J_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                    <span class="n">J_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_j_coupling_matrix</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)</span>  <span class="c1"># shape: (n_atoms, nao_max, nao_max, 3, 3)</span>

                    <span class="n">J_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_J_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">J_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_j_coupling_matrix</span><span class="p">(</span><span class="n">J_offsite</span><span class="p">)</span>  <span class="c1"># shape: (n_edges, nao_max, nao_max, 3, 3)</span>

                    <span class="c1"># Calculate quartic terms if enabled</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span><span class="p">:</span>
                        <span class="n">K_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_K_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                        <span class="n">K_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_k_coupling_matrix</span><span class="p">(</span><span class="n">K_onsite</span><span class="p">)</span>  <span class="c1"># shape: (n_atoms, nao_max, nao_max)</span>

                        <span class="n">K_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_K_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                        <span class="n">K_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_k_coupling_matrix</span><span class="p">(</span><span class="n">K_offsite</span><span class="p">)</span>  <span class="c1"># shape: (n_edges, nao_max, nao_max)</span>

                    <span class="c1"># Define Pauli matrices for spin operators</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">))</span>
                    <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>  <span class="c1"># x</span>
                    <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span>
                        <span class="n">real</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> 
                        <span class="n">imag</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>  <span class="c1"># y</span>
                    <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>  <span class="c1"># z</span>

                    <span class="c1"># Get spin vectors</span>
                    <span class="n">spin_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">spin_vec</span>

                    <span class="c1"># Initialize Heisenberg interaction terms</span>
                    <span class="n">H_heisen_J_onsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                    <span class="n">H_heisen_J_offsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_indices</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

                    <span class="c1"># Optimize performance with edge lookup structures</span>
                    <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_edge_lookup_structures</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>

                    <span class="c1"># Calculate on-site Heisenberg terms for magnetic atoms</span>
                    <span class="c1"># SJS terms using opt_einsum for efficient contraction</span>
                    <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                        <span class="s1">&#39;mijkl,mij,kop,ml-&gt;moipj&#39;</span><span class="p">,</span>
                        <span class="n">J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                        <span class="n">weight_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                        <span class="n">sigma</span><span class="p">,</span>
                        <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                        <span class="s1">&#39;mijkl,mij,lop,mk-&gt;moipj&#39;</span><span class="p">,</span>
                        <span class="n">J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                        <span class="n">weight_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                        <span class="n">sigma</span><span class="p">,</span>
                        <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="c1"># Calculate off-site interactions via neighboring atoms</span>
                    <span class="n">zero_shift_idx</span> <span class="o">=</span> <span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)):</span>
                        <span class="c1"># Process source atom contributions</span>
                        <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]:</span>
                            <span class="c1"># Get all edges where this atom appears, including zero-shift cells</span>
                            <span class="n">zero_shift_edges</span> <span class="o">=</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">zero_shift_idx</span><span class="p">]</span>
                            <span class="n">source_edges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span> <span class="n">zero_shift_edges</span><span class="p">])</span>
                            <span class="n">offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span>

                            <span class="c1"># Calculate Heisenberg interactions for these edges</span>
                            <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                <span class="s1">&#39;ijkl,mij,kop,l-&gt;moipj&#39;</span><span class="p">,</span>
                                <span class="n">J_onsite</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">sigma</span><span class="p">,</span>
                                <span class="n">spin_vec</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                            <span class="p">)</span>

                            <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                <span class="s1">&#39;ijkl,mij,lop,k-&gt;moipj&#39;</span><span class="p">,</span>
                                <span class="n">J_onsite</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">sigma</span><span class="p">,</span>
                                <span class="n">spin_vec</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="c1"># Process edge-specific interactions</span>
                    <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)):</span>
                        <span class="n">source_atom</span> <span class="o">=</span> <span class="n">source_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">target_atom</span> <span class="o">=</span> <span class="n">target_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                        <span class="c1"># Target atom contribution to source</span>
                        <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]:</span>
                            <span class="n">onsite_weight</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span>
                            <span class="n">source_offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]]</span>

                            <span class="c1"># Update on-site term at source atom</span>
                            <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                <span class="s1">&#39;ijkl,ij,kop,l-&gt;oipj&#39;</span><span class="p">,</span>
                                <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">onsite_weight</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">sigma</span><span class="p">,</span>
                                <span class="n">spin_vec</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                            <span class="p">)</span>

                            <span class="c1"># Update off-site terms from source atom</span>
                            <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                <span class="s1">&#39;ijkl,mij,kop,l-&gt;moipj&#39;</span><span class="p">,</span>
                                <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">source_offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">sigma</span><span class="p">,</span>
                                <span class="n">spin_vec</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="c1"># Source atom contribution to target</span>
                        <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]:</span>
                            <span class="n">target_offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">target_atom</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]]]</span>

                            <span class="c1"># Update off-site terms to target atom</span>
                            <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">target_atom</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                <span class="s1">&#39;ijkl,mij,lop,k-&gt;moipj&#39;</span><span class="p">,</span>
                                <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">target_offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                <span class="n">sigma</span><span class="p">,</span>
                                <span class="n">spin_vec</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                            <span class="p">)</span>

                            <span class="c1"># For zero-cell-shift, also update on-site term at target</span>
                            <span class="k">if</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]:</span>
                                <span class="n">target_onsite_weight</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span>
                                <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ijkl,ij,lop,k-&gt;oipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">target_onsite_weight</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">spin_vec</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                                <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Non-SOC magnetic interactions</span>
                    <span class="n">J_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_J_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                    <span class="n">J_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_j_coupling_matrix</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)</span>  <span class="c1"># shape: (n_atoms, nao_max, nao_max)</span>

                    <span class="n">J_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_J_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                    <span class="n">J_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_j_coupling_matrix</span><span class="p">(</span><span class="n">J_offsite</span><span class="p">)</span>  <span class="c1"># shape: (n_edges, nao_max, nao_max)</span>

                    <span class="c1"># Calculate quartic terms if enabled</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_quartic</span><span class="p">:</span>
                        <span class="n">K_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_K_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
                        <span class="n">K_onsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_k_coupling_matrix</span><span class="p">(</span><span class="n">K_onsite</span><span class="p">)</span>

                        <span class="n">K_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_K_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
                        <span class="n">K_offsite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_k_coupling_matrix</span><span class="p">(</span><span class="n">K_offsite</span><span class="p">)</span>

                    <span class="c1"># Handle collinear vs non-collinear spin</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                        <span class="c1"># Collinear spin uses only z-component</span>
                        <span class="n">sigma_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)</span>
                        <span class="n">spin_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">spin_vec</span>

                        <span class="c1"># Initialize Heisenberg interaction matrices</span>
                        <span class="n">H_heisen_J_onsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)</span>
                        <span class="n">H_heisen_J_offsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_indices</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_offsite</span><span class="p">)</span>

                        <span class="c1"># Build edge lookup for efficient calculation</span>
                        <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_edge_lookup_structures</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>

                        <span class="c1"># Calculate on-site contributions for magnetic atoms</span>
                        <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                            <span class="s1">&#39;mij,mij,op,m-&gt;moipj&#39;</span><span class="p">,</span>
                            <span class="n">J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">],</span>
                            <span class="n">weight_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">],</span>
                            <span class="n">sigma_z</span><span class="p">,</span>
                            <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># z-component only</span>
                        <span class="p">)</span>

                        <span class="c1"># Calculate off-site contributions</span>
                        <span class="n">zero_shift_idx</span> <span class="o">=</span> <span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]:</span>
                                <span class="n">zero_shift_edges</span> <span class="o">=</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">zero_shift_idx</span><span class="p">]</span>
                                <span class="n">source_edges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span> <span class="n">zero_shift_edges</span><span class="p">])</span>
                                <span class="n">offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span>

                                <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,mij,op-&gt;moipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_onsite</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span>
                                    <span class="n">offsite_weights</span><span class="p">,</span>
                                    <span class="n">sigma_z</span>
                                <span class="p">)</span> <span class="o">*</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

                        <span class="c1"># Process edge-specific interactions</span>
                        <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)):</span>
                            <span class="n">source_atom</span> <span class="o">=</span> <span class="n">source_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="n">target_atom</span> <span class="o">=</span> <span class="n">target_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                            <span class="c1"># Target atom contribution to source</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]:</span>
                                <span class="n">onsite_weight</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span>
                                <span class="n">source_offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]]</span>

                                <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,ij,op-&gt;oipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span>
                                    <span class="n">onsite_weight</span><span class="p">,</span>
                                    <span class="n">sigma_z</span>
                                <span class="p">)</span> <span class="o">*</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">target_atom</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

                                <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,mij,op-&gt;moipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span>
                                    <span class="n">source_offsite_weights</span><span class="p">,</span>
                                    <span class="n">sigma_z</span>
                                <span class="p">)</span> <span class="o">*</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">target_atom</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

                            <span class="c1"># Source atom contribution to target</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]:</span>
                                <span class="n">target_offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">target_atom</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]]]</span>

                                <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">target_atom</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,mij,op-&gt;moipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span>
                                    <span class="n">target_offsite_weights</span><span class="p">,</span>
                                    <span class="n">sigma_z</span>
                                <span class="p">)</span> <span class="o">*</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">source_atom</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

                                <span class="k">if</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]:</span>
                                    <span class="n">target_onsite_weight</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span>
                                    <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                        <span class="s1">&#39;ij,ij,op-&gt;oipj&#39;</span><span class="p">,</span>
                                        <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">],</span>
                                        <span class="n">target_onsite_weight</span><span class="p">,</span>
                                        <span class="n">sigma_z</span>
                                    <span class="p">)</span> <span class="o">*</span> <span class="n">spin_vec</span><span class="p">[</span><span class="n">source_atom</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Non-collinear spin handling (similar to SOC case but simpler)</span>
                        <span class="c1"># Define Pauli matrices</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">))</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span>
                            <span class="n">real</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                            <span class="n">imag</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]])</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

                        <span class="n">spin_vec</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">spin_vec</span>

                        <span class="c1"># Initialize Heisenberg matrices</span>
                        <span class="n">H_heisen_J_onsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                        <span class="n">H_heisen_J_offsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_indices</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

                        <span class="c1"># Build edge lookup</span>
                        <span class="n">edge_matcher_src</span><span class="p">,</span> <span class="n">edge_matcher_tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_edge_lookup_structures</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>

                        <span class="c1"># Calculate on-site contributions for magnetic atoms</span>
                        <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                            <span class="s1">&#39;mij,mij,kop,mk-&gt;moipj&#39;</span><span class="p">,</span>
                            <span class="n">J_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                            <span class="n">weight_onsite</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                            <span class="n">sigma</span><span class="p">,</span>
                            <span class="n">spin_vec</span><span class="p">[</span><span class="n">magnetic_atoms</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="c1"># Calculate off-site contributions</span>
                        <span class="n">zero_shift_idx</span> <span class="o">=</span> <span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_onsite</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]:</span>
                                <span class="n">zero_shift_edges</span> <span class="o">=</span> <span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">][</span><span class="n">zero_shift_idx</span><span class="p">]</span>
                                <span class="n">source_edges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span> <span class="n">zero_shift_edges</span><span class="p">])</span>
                                <span class="n">offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span>

                                <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">source_edges</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,mij,kop,k-&gt;moipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_onsite</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">spin_vec</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                                <span class="p">)</span>

                        <span class="c1"># Process edge-specific interactions</span>
                        <span class="k">for</span> <span class="n">edge_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source_indices</span><span class="p">)):</span>
                            <span class="n">source_atom</span> <span class="o">=</span> <span class="n">source_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="n">target_atom</span> <span class="o">=</span> <span class="n">target_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                            <span class="c1"># Target atom contribution to source</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]:</span>
                                <span class="n">onsite_weight</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span>
                                <span class="n">source_offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]]</span>

                                <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,ij,kop,k-&gt;oipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">onsite_weight</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">spin_vec</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                                <span class="p">)</span>

                                <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">edge_matcher_src</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,mij,kop,k-&gt;moipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">source_offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">spin_vec</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                                <span class="p">)</span>

                            <span class="c1"># Source atom contribution to target</span>
                            <span class="k">if</span> <span class="n">magnetic_atoms</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]:</span>
                                <span class="n">target_offsite_weights</span> <span class="o">=</span> <span class="n">weight_offsite</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">target_atom</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]]]</span>

                                <span class="n">H_heisen_J_offsite</span><span class="p">[</span><span class="n">edge_matcher_tar</span><span class="p">[</span><span class="n">target_atom</span><span class="p">][</span><span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]]]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                    <span class="s1">&#39;ij,mij,kop,k-&gt;moipj&#39;</span><span class="p">,</span>
                                    <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">target_offsite_weights</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                    <span class="n">sigma</span><span class="p">,</span>
                                    <span class="n">spin_vec</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="n">cell_shift_indices</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">cell_index_map</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]:</span>
                                    <span class="n">target_onsite_weight</span> <span class="o">=</span> <span class="n">weight_onsite</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span>
                                    <span class="n">H_heisen_J_onsite</span><span class="p">[</span><span class="n">target_atom</span><span class="p">]</span> <span class="o">+=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                                        <span class="s1">&#39;ij,ij,kop,k-&gt;oipj&#39;</span><span class="p">,</span>
                                        <span class="n">J_offsite</span><span class="p">[</span><span class="n">edge_idx</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                        <span class="n">target_onsite_weight</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
                                        <span class="n">sigma</span><span class="p">,</span>
                                        <span class="n">spin_vec</span><span class="p">[</span><span class="n">source_atom</span><span class="p">]</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
                                    <span class="p">)</span>

                <span class="c1"># Combine Heisenberg terms with SOC Hamiltonian</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="c1"># Add real and imaginary parts separately</span>
                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">soc_onsite_real</span> <span class="o">+</span> <span class="n">H_heisen_J_onsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">soc_offsite_real</span> <span class="o">+</span> <span class="n">H_heisen_J_offsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="n">soc_onsite_imag</span> <span class="o">+</span> <span class="n">H_heisen_J_onsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>
                    <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="n">soc_offsite_imag</span> <span class="o">+</span> <span class="n">H_heisen_J_offsite</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>

                    <span class="c1"># Apply symmetrization if enabled</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
                        <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian_soc</span><span class="p">(</span><span class="n">soc_onsite_real</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian_soc</span><span class="p">(</span><span class="n">soc_offsite_real</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian_soc</span><span class="p">(</span><span class="n">soc_onsite_imag</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian_soc</span><span class="p">(</span><span class="n">soc_offsite_imag</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">,</span> <span class="n">hermitian</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For collinear spin, create separate up and down Hamiltonians</span>
                    <span class="n">collinear_onsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
                        <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_onsite</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">onsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_onsite</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">collinear_offsite</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
                        <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_offsite</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">offsite_hamiltonian</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_heisen_J_offsite</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Add reference H0 terms if enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="n">soc_onsite_real</span> <span class="o">=</span> <span class="n">soc_onsite_real</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span>
                    <span class="n">soc_offsite_real</span> <span class="o">=</span> <span class="n">soc_offsite_real</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span>
                    <span class="n">soc_onsite_imag</span> <span class="o">=</span> <span class="n">soc_onsite_imag</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">iHon0</span>
                    <span class="n">soc_offsite_imag</span> <span class="o">=</span> <span class="n">soc_offsite_imag</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">iHoff0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">collinear_onsite</span> <span class="o">=</span> <span class="n">collinear_onsite</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span>
                    <span class="n">collinear_offsite</span> <span class="o">=</span> <span class="n">collinear_offsite</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span>

            <span class="c1"># === COMBINE HAMILTONIANS AND CALCULATE BAND STRUCTURES ===</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                <span class="c1"># Combine real and imaginary parts of SOC Hamiltonian</span>
                <span class="n">soc_hamiltonian_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">soc_onsite_real</span><span class="p">,</span> <span class="n">soc_offsite_real</span><span class="p">)</span>
                <span class="n">soc_hamiltonian_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">soc_onsite_imag</span><span class="p">,</span> <span class="n">soc_offsite_imag</span><span class="p">)</span>

                <span class="c1"># Store reference Hamiltonians</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHoff</span><span class="p">)</span>

                <span class="c1"># Combine real and imaginary parts</span>
                <span class="n">soc_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">soc_hamiltonian_real</span><span class="p">,</span> <span class="n">soc_hamiltonian_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_real</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Calculate band structure if requested</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span><span class="p">:</span>
                    <span class="c1"># Generate k-points for each crystal</span>
                    <span class="n">k_vectors</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span>

                        <span class="c1"># Generate k-point path based on configuration</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                            <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Random k-points if no path specified</span>
                            <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># (-1, 1)</span>

                        <span class="c1"># Transform k-points to reciprocal space</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lat_per_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>  <span class="c1"># shape (nk, 1, 3)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># shape (nk, 3)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                        <span class="n">k_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span>

                    <span class="c1"># Store k-vectors for band structure calculation</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">k_vectors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># Calculate band energies and wavefunctions with SOC</span>
                    <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies_with_spin_orbit_coupling</span><span class="p">(</span>
                        <span class="n">soc_onsite_real</span><span class="p">,</span> <span class="n">soc_onsite_imag</span><span class="p">,</span> <span class="n">soc_offsite_real</span><span class="p">,</span> <span class="n">soc_offsite_imag</span><span class="p">,</span> <span class="n">data</span>
                    <span class="p">)</span>

                    <span class="c1"># Calculate reference band structure</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies_with_spin_orbit_coupling</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">iHoff</span><span class="p">,</span> <span class="n">data</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">band_energy</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">wavefunction</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For collinear spin or non-SOC case</span>
                <span class="n">collinear_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">collinear_onsite</span><span class="p">,</span> <span class="n">collinear_offsite</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">)</span>

                <span class="c1"># Calculate band structure if requested</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span><span class="p">:</span>
                    <span class="n">k_vectors</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span>

                        <span class="c1"># Generate k-point path based on configuration</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                            <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                            <span class="c1"># Automatic k-path generation based on crystal symmetry</span>
                            <span class="n">lattice</span> <span class="o">=</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">au2ang</span>
                            <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">au2ang</span>
                            <span class="n">species</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

                            <span class="c1"># Create pymatgen Structure</span>
                            <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span>
                                <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span> 
                                <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species</span><span class="p">],</span> 
                                <span class="n">coords</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> 
                                <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span>
                            <span class="p">)</span>

                            <span class="c1"># Generate k-path using symmetry</span>
                            <span class="n">kpath_seek</span> <span class="o">=</span> <span class="n">KPathSeek</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">)</span>
                            <span class="n">k_labels</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">label_group</span> <span class="ow">in</span> <span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
                                <span class="n">k_labels</span> <span class="o">+=</span> <span class="n">label_group</span>

                            <span class="c1"># Remove adjacent duplicates</span>
                            <span class="n">unique_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">k_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="p">[</span><span class="n">unique_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">unique_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

                            <span class="n">k_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;kpoints&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                                <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="c1"># Fallback to random k-points if path generation fails</span>
                                <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                                <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># (-1, 1)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Random k-points if no path specified</span>
                            <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># (-1, 1)</span>

                        <span class="c1"># Transform k-points to reciprocal space</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lat_per_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                        <span class="n">k_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span>

                    <span class="c1"># Store k-vectors for band structure calculation</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">k_vectors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
                        <span class="c1"># Calculate band structure for both spin channels with reciprocal space matrices</span>
                        <span class="n">band_energy_up</span><span class="p">,</span> <span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">HK_up</span><span class="p">,</span> <span class="n">SK_up</span><span class="p">,</span> <span class="n">dSK_up</span><span class="p">,</span> <span class="n">gap_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">collinear_onsite</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">collinear_offsite</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">band_energy_down</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">,</span> <span class="n">HK_down</span><span class="p">,</span> <span class="n">SK_down</span><span class="p">,</span> <span class="n">dSK_down</span><span class="p">,</span> <span class="n">gap_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">collinear_onsite</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">collinear_offsite</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>

                        <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">band_energy_down</span><span class="p">])</span>
                        <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">])</span>
                        <span class="n">HK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">HK_up</span><span class="p">,</span> <span class="n">HK_down</span><span class="p">])</span>
                        <span class="n">gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">gap_up</span><span class="p">,</span> <span class="n">gap_down</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Calculate band structure for both spin channels</span>
                        <span class="n">band_energy_up</span><span class="p">,</span> <span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">gap_up</span><span class="p">,</span> <span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">collinear_onsite</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">collinear_offsite</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span>
                        <span class="p">)</span>
                        <span class="n">band_energy_down</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">,</span> <span class="n">gap_down</span><span class="p">,</span> <span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">collinear_onsite</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">collinear_offsite</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span>
                        <span class="p">)</span>

                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">band_energy_down</span><span class="p">])</span>
                        <span class="n">wavefunction</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">wavefunction_up</span><span class="p">,</span> <span class="n">wavefunction_down</span><span class="p">])</span>
                        <span class="n">gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">gap_up</span><span class="p">,</span> <span class="n">gap_down</span><span class="p">])</span>

                    <span class="c1"># Calculate reference band structure</span>
                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span>
                        <span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy_down</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap_down</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span>
                        <span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">band_energy_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_energy_down</span><span class="p">])</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">band_gap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">band_gap_up</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap_down</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">band_energy</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">wavefunction</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">gap</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># === NON-MAGNETIC, NON-SOC CASE ===</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate standard Hamiltonian</span>
            <span class="n">node_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onsite_hamiltonian_network</span><span class="p">(</span><span class="n">node_attr</span><span class="p">)</span>
            <span class="n">node_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">node_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">node_spherical_components</span><span class="p">)</span>

            <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
            <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_onsite_hamiltonian</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>

            <span class="c1"># Add reference H0 if available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span><span class="p">:</span>
                <span class="n">onsite_hamiltonian</span> <span class="o">=</span> <span class="n">onsite_hamiltonian</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hon0</span>

            <span class="c1"># Calculate off-site Hamiltonian</span>
            <span class="n">edge_spherical_harmonics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsite_hamiltonian_network</span><span class="p">(</span><span class="n">edge_attr</span><span class="p">)</span>
            <span class="n">edge_spherical_components</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">edge_spherical_harmonics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hamiltonian_irreps_dimensions</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_tensor_components</span><span class="p">(</span><span class="n">edge_spherical_components</span><span class="p">)</span>

            <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_matrix</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">)</span>
            <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize_offsite_hamiltonian</span><span class="p">(</span><span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">inverse_edge_indices</span><span class="p">)</span>

            <span class="c1"># Add reference H0 if available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_H0</span><span class="p">:</span>
                <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="n">offsite_hamiltonian</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff0</span>
                
            <span class="c1"># Apply orbital masking for specific Hamiltonian types</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span> <span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
                <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_orbital_masks_to_hamiltonians</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="c1"># Calculate band structure if requested</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energy</span><span class="p">:</span>
                <span class="c1"># Generate k-points for each crystal</span>
                <span class="n">k_vectors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">lattice_vectors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cell</span>

                    <span class="c1"># Generate k-point path based on configuration</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                        <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                        <span class="c1"># Automatic k-path generation</span>
                        <span class="n">lattice</span> <span class="o">=</span> <span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">au2ang</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">au2ang</span>
                        <span class="n">species</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">node_counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

                        <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span>
                            <span class="n">lattice</span><span class="o">=</span><span class="n">lattice</span><span class="p">,</span>
                            <span class="n">species</span><span class="o">=</span><span class="p">[</span><span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">species</span><span class="p">],</span>
                            <span class="n">coords</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
                            <span class="n">coords_are_cartesian</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>

                        <span class="n">kpath_seek</span> <span class="o">=</span> <span class="n">KPathSeek</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">)</span>
                        <span class="n">k_labels</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">label_group</span> <span class="ow">in</span> <span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]:</span>
                            <span class="n">k_labels</span> <span class="o">+=</span> <span class="n">label_group</span>

                        <span class="n">unique_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">k_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="p">[</span><span class="n">unique_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">unique_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

                        <span class="n">k_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpath_seek</span><span class="o">.</span><span class="n">kpath</span><span class="p">[</span><span class="s1">&#39;kpoints&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">kpoints</span> <span class="o">=</span> <span class="n">kpoints_generator</span><span class="p">(</span><span class="n">dim_k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
                            <span class="n">k_vec</span><span class="p">,</span> <span class="n">k_dist</span><span class="p">,</span> <span class="n">k_node</span><span class="p">,</span> <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">k_path</span><span class="p">(</span><span class="n">k_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="c1"># Fallback to random k-points</span>
                            <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Random k-points</span>
                        <span class="n">lat_per_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lattice_vectors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">k_vec</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>

                    <span class="c1"># Transform k-points to reciprocal space</span>
                    <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lat_per_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="n">k_vec</span> <span class="o">=</span> <span class="n">k_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="n">k_vec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">onsite_hamiltonian</span><span class="p">)</span>
                    <span class="n">k_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_vec</span><span class="p">)</span>

                <span class="c1"># Store k-vectors for band structure calculation</span>
                <span class="n">data</span><span class="o">.</span><span class="n">k_vecs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">k_vectors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>
                        <span class="c1"># Calculate band structure with reciprocal space matrices</span>
                        <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">HK</span><span class="p">,</span> <span class="n">SK</span><span class="p">,</span> <span class="n">dSK</span><span class="p">,</span> <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                            <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Calculate band structure with overlap matrices</span>
                        <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">HK</span><span class="p">,</span> <span class="n">SK</span><span class="p">,</span> <span class="n">dSK</span><span class="p">,</span> <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies_with_overlap</span><span class="p">(</span>
                            <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">onsite_overlap</span><span class="p">,</span> <span class="n">offsite_overlap</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Standard band structure calculation</span>
                    <span class="n">band_energy</span><span class="p">,</span> <span class="n">wavefunction</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                        <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">,</span> <span class="n">data</span>
                    <span class="p">)</span>

                <span class="c1"># Calculate reference band structure</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">wavefunction</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">band_gap</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">H_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_band_energies</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">Hon</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Hoff</span><span class="p">,</span> <span class="n">data</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">band_energy</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wavefunction</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">gap</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">H_sym</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># === PREPARE RESULTS ===</span>
        <span class="c1"># Process results based on Hamiltonian type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span> <span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">soc_switch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin_constrained</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">collinear_spin</span><span class="p">:</span>
                    <span class="c1"># Handle zero point energy shift if enabled</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span><span class="p">:</span>
                        <span class="c1"># Calculate energy shift to match reference</span>
                        <span class="n">overlap_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">soc_hamiltonian_real_reshaped</span> <span class="o">=</span> <span class="n">soc_hamiltonian_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">real_up_up_block</span> <span class="o">=</span> <span class="n">soc_hamiltonian_real_reshaped</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  
                        <span class="n">real_down_down_block</span> <span class="o">=</span> <span class="n">soc_hamiltonian_real_reshaped</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> 
                        
                        <span class="n">data_hamiltonian_real_reshaped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian_real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span>
                        <span class="n">data_real_up_up_block</span> <span class="o">=</span> <span class="n">data_hamiltonian_real_reshaped</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  
                        <span class="n">data_real_down_down_block</span> <span class="o">=</span> <span class="n">data_hamiltonian_real_reshaped</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>  
                        
                        <span class="n">sum_overlap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">overlap_matrix</span><span class="p">[</span><span class="n">overlap_matrix</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">])</span>
                        
                        <span class="n">diagonal_block_difference</span> <span class="o">=</span> <span class="p">(</span><span class="n">real_up_up_block</span> <span class="o">+</span> <span class="n">real_down_down_block</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_real_up_up_block</span> <span class="o">+</span> <span class="n">data_real_down_down_block</span><span class="p">)</span>
                        
                        <span class="n">energy_shift_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extract_elements_above_threshold</span><span class="p">(</span>
                            <span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">diagonal_block_difference</span> <span class="p">,</span> <span class="mf">1e-6</span>
                        <span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">sum_overlap</span><span class="p">)</span>

                        <span class="c1"># Apply energy shift</span>
                        <span class="n">soc_hamiltonian_real_reshaped</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">real_up_up_block</span> <span class="o">-</span> <span class="n">energy_shift_real</span> <span class="o">*</span> <span class="n">overlap_matrix</span>
                        <span class="n">soc_hamiltonian_real_reshaped</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">real_down_down_block</span> <span class="o">-</span> <span class="n">energy_shift_real</span> <span class="o">*</span> <span class="n">overlap_matrix</span>
                        <span class="n">soc_hamiltonian_real</span> <span class="o">=</span> <span class="n">soc_hamiltonian_real_reshaped</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nao_max</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        
                        <span class="n">soc_hamiltonian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">soc_hamiltonian_real</span><span class="p">,</span> <span class="n">soc_hamiltonian_imag</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="c1"># Adjust band energies if calculated</span>
                        <span class="k">if</span> <span class="n">band_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">band_energy</span> <span class="o">=</span> <span class="n">band_energy</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">band_energy</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">)</span>

                    <span class="c1"># Prepare result dictionary</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;hamiltonian&#39;</span><span class="p">:</span> <span class="n">soc_hamiltonian</span><span class="p">,</span>
                        <span class="s1">&#39;hamiltonian_real&#39;</span><span class="p">:</span> <span class="n">soc_hamiltonian_real</span><span class="p">,</span>
                        <span class="s1">&#39;hamiltonian_imag&#39;</span><span class="p">:</span> <span class="n">soc_hamiltonian_imag</span><span class="p">,</span>
                        <span class="s1">&#39;band_energy&#39;</span><span class="p">:</span> <span class="n">band_energy</span><span class="p">,</span>
                        <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span> <span class="n">wavefunction</span>
                    <span class="p">}</span>

                    <span class="c1"># Add mask tensor if requested</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span><span class="p">:</span>
                        <span class="n">mask_real_imag</span><span class="p">,</span> <span class="n">mask_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_spin_orbit_interaction_masks</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mask_real_imag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_real_imag</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Collinear spin</span>
                    <span class="c1"># Handle zero point energy shift if enabled</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span><span class="p">:</span>
                        <span class="c1"># Calculate energy shift to match reference</span>
                        <span class="n">overlap_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span>
                        <span class="n">collinear_overlap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">overlap_matrix</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sum_collinear_overlap</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">overlap_matrix</span><span class="p">[</span><span class="n">overlap_matrix</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">])</span>

                        <span class="n">energy_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extract_elements_above_threshold</span><span class="p">(</span>
                            <span class="n">collinear_overlap</span><span class="p">,</span> <span class="n">collinear_hamiltonian</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="mf">1e-6</span>
                        <span class="p">))</span> <span class="o">/</span> <span class="n">sum_collinear_overlap</span>

                        <span class="c1"># Apply energy shift</span>
                        <span class="n">collinear_hamiltonian</span> <span class="o">=</span> <span class="n">collinear_hamiltonian</span> <span class="o">-</span> <span class="n">energy_shift</span> <span class="o">*</span> <span class="n">collinear_overlap</span>

                        <span class="c1"># Adjust band energies if calculated</span>
                        <span class="k">if</span> <span class="n">band_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">band_energy</span> <span class="o">=</span> <span class="n">band_energy</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">band_energy</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">)</span>

                    <span class="c1"># Prepare result dictionary</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;hamiltonian&#39;</span><span class="p">:</span> <span class="n">collinear_hamiltonian</span><span class="p">,</span>
                        <span class="s1">&#39;band_energy&#39;</span><span class="p">:</span> <span class="n">band_energy</span><span class="p">,</span>
                        <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span> <span class="n">wavefunction</span>
                    <span class="p">}</span>

                    <span class="c1"># Add mask tensor if requested</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span><span class="p">:</span>
                        <span class="n">mask_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_column_wise_interaction_masks</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_all</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Standard non-magnetic case</span>
                <span class="n">combined_hamiltonian</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">onsite_hamiltonian</span><span class="p">,</span> <span class="n">offsite_hamiltonian</span><span class="p">)</span>

                <span class="c1"># Handle zero point energy shift if enabled</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_point_shift</span><span class="p">:</span>
                    <span class="c1"># Calculate energy shift to match reference</span>
                    <span class="n">overlap_matrix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span>
                    <span class="n">sum_overlap</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">overlap_matrix</span><span class="p">[</span><span class="n">overlap_matrix</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">])</span>

                    <span class="n">energy_shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">extract_elements_above_threshold</span><span class="p">(</span>
                        <span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">combined_hamiltonian</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">hamiltonian</span><span class="p">,</span> <span class="mf">1e-6</span>
                    <span class="p">))</span> <span class="o">/</span> <span class="n">sum_overlap</span>

                    <span class="c1"># Apply energy shift</span>
                    <span class="n">combined_hamiltonian</span> <span class="o">=</span> <span class="n">combined_hamiltonian</span> <span class="o">-</span> <span class="n">energy_shift</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">overlap</span>

                    <span class="c1"># Adjust band energies if calculated</span>
                    <span class="k">if</span> <span class="n">band_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">band_energy</span> <span class="o">=</span> <span class="n">band_energy</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">band_energy</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">band_energy</span><span class="p">)</span>

                <span class="c1"># Prepare result dictionary</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;hamiltonian&#39;</span><span class="p">:</span> <span class="n">combined_hamiltonian</span><span class="p">,</span>
                    <span class="s1">&#39;band_energy&#39;</span><span class="p">:</span> <span class="n">band_energy</span><span class="p">,</span>
                    <span class="s1">&#39;wavefunction&#39;</span><span class="p">:</span> <span class="n">wavefunction</span><span class="p">,</span>
                    <span class="s1">&#39;band_gap&#39;</span><span class="p">:</span> <span class="n">gap</span><span class="p">,</span>
                    <span class="s1">&#39;H_sym&#39;</span><span class="p">:</span> <span class="n">H_sym</span>
                <span class="p">}</span>

                <span class="c1"># Add reciprocal space matrices if requested</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_reciprocal_values</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;HK&#39;</span><span class="p">:</span> <span class="n">HK</span><span class="p">,</span> <span class="s1">&#39;SK&#39;</span><span class="p">:</span> <span class="n">SK</span><span class="p">,</span> <span class="s1">&#39;dSK&#39;</span><span class="p">:</span> <span class="n">dSK</span><span class="p">})</span>

                <span class="c1"># Add mask tensor if requested</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nonzero_mask_tensor</span><span class="p">:</span>
                    <span class="n">mask_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_interaction_masks</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_all</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unsupported Hamiltonian type&quot;</span><span class="p">)</span>

        <span class="c1"># Add overlap matrix if calculating both Hamiltonian and overlap</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ham_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;openmx&#39;</span><span class="p">,</span> <span class="s1">&#39;pasp&#39;</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;abacus&#39;</span><span class="p">]:</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenate_hamiltonians_by_crystal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">onsite_overlap</span><span class="p">,</span> <span class="n">offsite_overlap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unsupported Hamiltonian type for overlap calculation&quot;</span><span class="p">)</span>

            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;overlap&#39;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">})</span>
        
        <span class="c1"># Calculate and add sparsity ratio if requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sparsity</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sparsity_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sparsity_ratio</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright HamGNN Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"></span>
    docs | v2.1 | en
    <span class="fa fa-caret-down"></span>
  </span>
  
  <div class="rst-other-versions">
    
    
    
    
    
    
    
    

    <hr>
    <dl>
      <dt></dt>
      <dd>
        <a href="https://github.com/bud-primordium/HamGNN">
          <span class="fa fa-github"></span> GitHub
        </a>
      </dd>
    </dl>
  </div>
</div>

<style>
/*  */
.rst-versions {
  font-size: 14px;
}

/*  */
.rst-current-version {
  background-color: #2c3e50 !important;
  font-weight: bold !important;
  font-size: 15px !important;
  padding: 12px 24px !important;
}

.rst-current-version:hover {
  background-color: #34495e !important;
}

.rst-other-versions dl {
  margin-bottom: 16px;
}

.rst-other-versions dt {
  color: #55a5d9;
  font-weight: bold;
  margin-bottom: 8px;
}

.rst-other-versions dd {
  margin-left: 16px;
  margin-bottom: 4px;
}

.rst-other-versions dd.rtd-current-item a {
  font-weight: bold;
  color: #55a5d9;
}

.rst-other-versions hr {
  margin: 16px 0;
  border: none;
  border-top: 1px solid #444;
}
</style><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>